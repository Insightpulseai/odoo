# ssot/runtime/prod_settings.yaml
#
# Production readiness SSOT — email, OCR, invariants, URLs, AI policy.
#
# Schema: ssot.runtime.prod_settings.v1
# Validator: scripts/ci/check_prod_settings_ssot.py
#
# This file is hand-authored (not generated). It declares what MUST be true
# for production to be considered healthy. The CI gate validates:
#   1. Schema structure and required keys
#   2. Every secret_ref exists in ssot/secrets/registry.yaml
#   3. Every URL in urls.active_required exists in docs/architecture/CANONICAL_URLS.md
#   4. Deterministic only — no network calls
#
# When a service is added or removed from prod, update this file and commit.
# CI will fail if the contract is violated.

schema: ssot.runtime.prod_settings.v1
version: "1.0"
last_reviewed: "2026-02-27"

# ── Email ────────────────────────────────────────────────────────────────

email:
  status: required
  provider: zoho_smtp
  notes: "Zoho Mail SMTP is the production mail provider. Mailgun is deprecated."
  config:
    smtp_host: smtp.zoho.com
    smtp_port: 465
    imap_host: imap.zoho.com
    imap_port: 993
    from_domain: insightpulseai.com
  secrets_refs:
    # Names only — values live in approved stores per ssot/secrets/registry.yaml
    - zoho_client_id
    - zoho_client_secret
    - zoho_refresh_token
  odoo_config_parameters:
    - key: ipai_zoho_mail.smtp_host
      expected: smtp.zoho.com
    - key: ipai_zoho_mail.smtp_port
      expected: "465"
    - key: ipai_zoho_mail.imap_host
      expected: imap.zoho.com
    - key: ipai_zoho_mail.imap_port
      expected: "993"
    - key: ipai_zoho_mail.from_domain
      expected: insightpulseai.com
  health_check:
    method: smtp_connect
    notes: "Live check requires network; CI gate is schema-only."

# ── OCR ──────────────────────────────────────────────────────────────────

ocr:
  status: required
  provider: paddleocr
  base_url: https://ocr.insightpulseai.com
  health_endpoint: /health
  notes: "PaddleOCR microservice. /health must return HTTP 200 with JSON OK."
  secrets_refs: []
  odoo_config_parameters: []
  health_check:
    method: http_get
    url: https://ocr.insightpulseai.com/health
    notes: "Live check requires network; CI gate validates URL is in CANONICAL_URLS.md."

# ── Odoo invariants ─────────────────────────────────────────────────────

odoo:
  invariants:
    web_base_url:
      expected: https://erp.insightpulseai.com
      config_parameter: web.base.url
      notes: "Must match production domain. Controls links in outbound emails."
    web_base_url_freeze:
      expected: "True"
      config_parameter: web.base.url.freeze
      notes: "Prevents Odoo from auto-updating web.base.url on login."
    proxy_mode:
      expected: "True"
      config_parameter: proxy_mode
      notes: "Required behind nginx reverse proxy. Enables X-Forwarded-* headers."
    list_db:
      expected: "False"
      config_parameter: list_db
      notes: "Disable DB selector on login page. Hardened for production."
    dbfilter:
      expected: "^odoo$"
      notes: "Restrict to prod DB only. Set in odoo.conf, not ir.config_parameter."

# ── URLs ─────────────────────────────────────────────────────────────────

urls:
  active_required:
    # Every URL here must appear in docs/architecture/CANONICAL_URLS.md
    # under Production Services (not Planned, not Deprecated).
    - url: https://erp.insightpulseai.com
      service: Odoo ERP
      health_check: /web/login
    - url: https://ocr.insightpulseai.com
      service: PaddleOCR Microservice
      health_check: /health
    - url: https://n8n.insightpulseai.com
      service: n8n Workflow Automation
      health_check: /healthz
    - url: https://mcp.insightpulseai.com
      service: MCP Gateway
      health_check: /healthz

# ── AI policy ────────────────────────────────────────────────────────────

ai:
  policy:
    fail_closed: true
    notes: >
      AI modules must not activate unless their upstream dependency is pinned.
      If apexive_odoo_llm.upstream.pinned_ref is null, all consumer modules
      are blocked from prod activation.
  dependencies:
    - id: apexive_odoo_llm
      ssot_ref: ssot/ai/dependencies.yaml
      gate: "pinned_ref != null AND lifecycle != 'unknown'"
      notes: "Anthropic provider requires this port. See spec/ipai-llm-supabase-bridge/."
  secrets_refs:
    - anthropic_api_key
    - llm_bridge_webhook_secret
