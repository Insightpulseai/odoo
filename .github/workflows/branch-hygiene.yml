name: Branch Hygiene — Auto-prune stale agent branches

on:
  schedule:
    # Nightly at 03:00 UTC (11:00 Asia/Manila)
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run — log only, do not delete"
        type: boolean
        default: true
      older_than_days:
        description: "Delete branches older than N days (default: 14)"
        type: number
        default: 14

permissions:
  contents: write      # Required to delete remote branch refs
  pull-requests: read  # Required to check for open PRs

jobs:
  prune-stale-branches:
    name: Prune stale agent branches
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Prune stale branches
        id: prune
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          DRY_RUN: ${{ github.event_name == 'workflow_dispatch' && inputs.dry_run || 'true' }}
          MAX_AGE_DAYS: ${{ github.event_name == 'workflow_dispatch' && inputs.older_than_days || 14 }}
        run: |
          mkdir -p reports/ci
          python3 scripts/ci/branch_hygiene.py

      - name: Upload hygiene report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: branch-hygiene-report-${{ github.run_number }}
          path: reports/ci/branch_hygiene_report.json
          retention-days: 30
          if-no-files-found: warn

      - name: Job summary
        if: always()
        env:
          REPORT: reports/ci/branch_hygiene_report.json
        run: |
          if [ ! -f "$REPORT" ]; then
            echo "## Branch Hygiene — no report generated" >> "$GITHUB_STEP_SUMMARY"
            exit 0
          fi
          python3 - <<'PYEOF'
          import json, os

          with open(os.environ["REPORT"]) as f:
              r = json.load(f)

          dry = r.get("dry_run", True)
          label = "Would delete" if dry else "Deleted"
          mode = "**Dry run** — no deletions" if dry else "**Live** — deletions applied"

          with open(os.environ["GITHUB_STEP_SUMMARY"], "a") as f:
              f.write(f"## Branch Hygiene Run\n\n")
              f.write(f"Mode: {mode}  \n")
              f.write(f"Max age: {r.get('max_age_days', '?')} days\n\n")
              f.write(f"| Metric | Count |\n|--------|-------|\n")
              f.write(f"| {label} | {len(r['deleted'])} |\n")
              f.write(f"| Skipped (open PR) | {len(r['skipped_open_pr'])} |\n")
              f.write(f"| Skipped (protected/not candidate) | {len(r['skipped_other'])} |\n")
              f.write(f"| Skipped (too new) | {len(r['skipped_too_new'])} |\n")
              f.write(f"| Errors | {len(r['errors'])} |\n\n")

              if r["deleted"]:
                  f.write(f"### {label}\n\n")
                  for b in r["deleted"]:
                      f.write(f"- `{b['name']}` (age: {b.get('age_days', '?')}d)\n")
                  f.write("\n")

              if r["errors"]:
                  f.write("### Errors\n\n")
                  for e in r["errors"]:
                      f.write(f"- `{e['name']}`: {e['error']}\n")
                  f.write("\n")
          PYEOF
