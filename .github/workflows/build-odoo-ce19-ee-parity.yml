# =============================================================================
# GitHub Actions: Build Odoo CE 19 + OCA + ipai_enterprise_bridge (EE Parity)
# =============================================================================
# Purpose: Build custom Odoo CE 19 image with Enterprise Edition feature parity
#          using only open source components (CE + OCA + ipai_enterprise_bridge)
#
# Triggers:
#   - Git tags: v19.*.* (production releases)
#   - Push to main branch (edge builds)
#   - Manual workflow dispatch
#
# CI Gates:
#   - Verify OCA Lock: Validate oca.lock.ce19.json
#   - Build: Multi-arch image build
#   - Smoke Test: --stop-after-init validation
#   - Audit: SBOM + vulnerability scan
#
# Registry: ghcr.io/jgtolentino/odoo-ce
# Tag Format: 19.0-ee-parity, 19.0.1-ee-parity, edge-19-ee-parity
# =============================================================================

name: Build Odoo CE 19 EE Parity Image

on:
  push:
    branches:
      - main
    tags:
      - 'v19.*.*'
    paths:
      - 'addons/ipai/ipai_enterprise_bridge/**'
      - 'addons/ipai/ipai_finance_ppm/**'
      - 'addons/ipai/ipai_hr_payroll_ph/**'
      - 'addons/ipai/ipai_helpdesk/**'
      - 'docker/Dockerfile.ce19'
      - 'vendor/oca.lock.ce19.json'
      - '.github/workflows/build-odoo-ce19-ee-parity.yml'
  workflow_dispatch:
    inputs:
      push_image:
        description: 'Push images to registry'
        required: false
        default: 'true'
        type: boolean
      run_audit:
        description: 'Run image audit (SBOM + vulns)'
        required: false
        default: 'true'
        type: boolean
      odoo_base_image:
        description: 'Odoo base image (e.g., odoo:19.0)'
        required: false
        default: 'odoo:19.0'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: jgtolentino/odoo-ce
  ODOO_VERSION: "19.0"

jobs:
  # ===========================================================================
  # Verify OCA Lockfile (CE 19 specific)
  # ===========================================================================
  verify-oca-lock:
    name: Verify OCA Lock (CE 19)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify OCA lockfile for CE 19
        run: |
          echo "Verifying OCA lockfile for Odoo CE 19..."

          # Check if CE 19 lockfile exists, fall back to main lockfile
          LOCKFILE="vendor/oca.lock.ce19.json"
          if [ ! -f "$LOCKFILE" ]; then
            LOCKFILE="vendor/oca.lock.json"
            echo "Warning: CE 19 lockfile not found, using main lockfile"
          fi

          if [ ! -f "$LOCKFILE" ]; then
            echo "ERROR: No OCA lockfile found"
            exit 1
          fi

          # Validate JSON
          if ! jq empty "$LOCKFILE" 2>/dev/null; then
            echo "ERROR: Invalid JSON in $LOCKFILE"
            exit 1
          fi

          # Check required fields
          VERSION=$(jq -r '.version // "unknown"' "$LOCKFILE")
          ODOO_VERSION=$(jq -r '.odoo_version // "unknown"' "$LOCKFILE")
          REPOS_COUNT=$(jq '.repos | length // 0' "$LOCKFILE")

          echo "Lockfile: $LOCKFILE"
          echo "Lockfile version: $VERSION"
          echo "Odoo version: $ODOO_VERSION"
          echo "Repositories: $REPOS_COUNT"

          # Summary
          echo "## OCA Lock Verification (CE 19)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lockfile | \`$LOCKFILE\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | $VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| Odoo Version | $ODOO_VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| Repositories | $REPOS_COUNT |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Build CE 19 EE Parity Image
  # ===========================================================================
  build:
    name: Build CE 19 EE Parity
    runs-on: ubuntu-latest
    needs: verify-oca-lock
    permissions:
      contents: read
      packages: write

    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
      image_tags: ${{ steps.meta.outputs.tags }}

    steps:
      # -----------------------------------------------------------------------
      # Checkout & Setup
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # Registry Login
      # -----------------------------------------------------------------------
      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # Image Metadata
      # -----------------------------------------------------------------------
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Tag for version releases (v19.0.1 -> 19.0.1-ee-parity)
            type=semver,pattern={{version}}-ee-parity,prefix=
            # Edge tag for main branch
            type=edge,branch=main,suffix=-19-ee-parity
            # SHA tag
            type=sha,prefix=19.0-ee-parity-sha-
            # Static tag for latest CE 19 EE parity
            type=raw,value=19.0-ee-parity,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=Odoo CE 19 + OCA + IPAI Enterprise Bridge (EE Parity)
            org.opencontainers.image.description=Odoo CE 19 with Enterprise Edition feature parity via OCA + ipai_enterprise_bridge. 100% open source.
            com.insightpulseai.odoo.version=19.0
            com.insightpulseai.ee.parity=true
            com.insightpulseai.ee.parity.strategy=CE+OCA+ipai_enterprise_bridge

      # -----------------------------------------------------------------------
      # Build Image
      # -----------------------------------------------------------------------
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./docker/Dockerfile.ce19
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_image != 'false') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            ODOO_BASE_IMAGE=${{ github.event.inputs.odoo_base_image || 'odoo:19.0' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      # -----------------------------------------------------------------------
      # Build Summary
      # -----------------------------------------------------------------------
      - name: Add build summary
        run: |
          echo "## Build Summary (CE 19 EE Parity)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Base Image | \`${{ github.event.inputs.odoo_base_image || 'odoo:19.0' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tags | See below |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Smoke Test
  # ===========================================================================
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
          POSTGRES_DB: odoo_ce19_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull built image
        run: |
          # Use the SHA tag for exact image
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:19.0-ee-parity-sha-${GITHUB_SHA::7}"
          echo "Pulling: $IMAGE"
          docker pull "$IMAGE" || docker pull "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:19.0-ee-parity"

      - name: Run Odoo --stop-after-init test
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:19.0-ee-parity-sha-${GITHUB_SHA::7}"

          # If SHA image doesn't exist, use the main tag
          if ! docker image inspect "$IMAGE" > /dev/null 2>&1; then
            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:19.0-ee-parity"
          fi

          echo "Testing with image: $IMAGE"

          # Run with --stop-after-init
          docker run --rm \
            --network ${{ job.container.network }} \
            -e "HOST=postgres" \
            -e "PORT=5432" \
            -e "USER=odoo" \
            -e "PASSWORD=odoo" \
            -e "DB=odoo_ce19_test" \
            "$IMAGE" \
            odoo -d odoo_ce19_test -i base --stop-after-init

          echo "✅ Smoke test passed"

      - name: Add test summary
        run: |
          echo "## Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Odoo CE 19 --stop-after-init: **PASSED**" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Security Audit (SBOM + Vulnerability Scan)
  # ===========================================================================
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request' && github.event.inputs.run_audit != 'false'

    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull built image
        run: |
          docker pull "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:19.0-ee-parity" || true

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:19.0-ee-parity
          format: spdx-json
          output-file: sbom-ce19-ee-parity.spdx.json
        continue-on-error: true

      - name: Scan with Grype
        uses: anchore/scan-action@v4
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:19.0-ee-parity
          fail-build: false
          severity-cutoff: critical
        continue-on-error: true

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-ce19-ee-parity
          path: sbom-ce19-ee-parity.spdx.json
        if: always()

      - name: Add audit summary
        run: |
          echo "## Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- SBOM generated: \`sbom-ce19-ee-parity.spdx.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- Vulnerability scan: Completed (see artifacts)" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Notify on Completion
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build, smoke-test]
    if: always()

    steps:
      - name: Final Summary
        run: |
          echo "## Odoo CE 19 EE Parity Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Odoo Version | 19.0 |" >> $GITHUB_STEP_SUMMARY
          echo "| EE Parity | ✅ Yes |" >> $GITHUB_STEP_SUMMARY
          echo "| Strategy | CE + OCA + ipai_enterprise_bridge |" >> $GITHUB_STEP_SUMMARY
          echo "| License | LGPL-3.0 (100% open source) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Command" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/jgtolentino/odoo-ce:19.0-ee-parity" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
