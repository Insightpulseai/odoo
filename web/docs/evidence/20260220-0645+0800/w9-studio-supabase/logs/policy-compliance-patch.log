W9 Studio Supabase Integration - Policy Compliance Patch
Timestamp: 2026-02-20T07:15:00+0800

=== CONTEXT ===
Goal: Fix repo policy violations without changing implementation code
Violations:
  1. UI-step docs as primary path (anti-pattern)
  2. Untracked workspace artifacts bloating git status

=== CHANGES APPLIED ===

1. MOVED: SUPABASE_INTEGRATION.md → docs/supabase/W9_STUDIO_BOOKING_INTEGRATION.md
   - Content: Same implementation details, corrected setup section
   - Primary path: Supabase CLI (automation-first)
   - UI steps: Removed (documented as fallback exception only)
   - Schema exposure: Added decision block (Option 1 recommended: server-only)

2. REPLACED: Root SUPABASE_INTEGRATION.md → Pointer stub (12 lines)
   - Canonical location reference
   - Rationale for move
   - Quick links to setup guide

3. UPDATED: .gitignore (+8 lines)
   - .cache/ (workspace artifacts)
   - _work/ (workspace artifacts)
   - artifacts/figma/ (Figma extraction temp files)
   - design-tokens/.figma-* (Figma metadata)
   - design-tokens/figma-*.json (Figma exports)
   - **/.env.local (Vite env files)
   - **/.env.*.local (Vite env variants)

=== AUTOMATION-FIRST CORRECTIONS ===

Replaced UI Steps:
  ❌ "Step 1: Open Supabase Dashboard → SQL Editor → Paste → Run"
  ✅ "Apply migrations via Supabase CLI: supabase db push"

  ❌ "Step 2: Settings → API → Exposed schemas → Add ops → Save"
  ✅ "Schema exposure decision (Option 1: server-only, Option 2: client access)"

  ❌ "Step 3: Copy .env.local.example → Edit manually"
  ✅ "Env injection: local manual copy, CI via secrets, never committed"

  ❌ "Step 4: Navigate to http://localhost:5173/#booking → Click → Verify in dashboard"
  ✅ "Automated smoke tests: booking-smoke.test.ts with assertions"

Added Sections:
  ✅ "Schema Exposure Decision" (Option 1 recommended: Edge Function gateway)
  ✅ "CI/CD Integration" (GitHub workflow with Supabase CLI)
  ✅ "Verification (Automated)" (Test suite with RLS assertions)
  ✅ "Decision Log" (Timestamp: 2026-02-20, current state: Option 2 for MVP)

=== SECURITY IMPROVEMENTS ===

Schema Exposure Decision:
  Option 1 (Recommended): ops schema server-only
    - Client → Edge Function → ops.bookings
    - Rate limiting at Edge Function layer
    - Abuse controls (validation, honeypot, monitoring)
    - Future Odoo SOR integration easier (server-to-server)

  Option 2 (Exception - Current): Client direct access
    - Requires explicit justification
    - Must include abuse controls
    - Documented migration path to Option 1
    - Timeline: Before public launch or 100 bookings/month

Current Implementation: Option 2 (acceptable for MVP)
Recommendation: Migrate to Option 1 before production

=== VERIFICATION CHECKLIST ===

✅ docs/supabase/W9_STUDIO_BOOKING_INTEGRATION.md exists (corrected guide)
✅ Root SUPABASE_INTEGRATION.md is pointer stub (12 lines)
✅ No UI/manual dashboard steps as primary path (CLI-first)
✅ .gitignore prevents .cache/, _work/, artifacts/figma/ from commits
✅ "Expose ops schema" not default (Option 1 recommended with security analysis)
✅ Schema exposure decision documented with security implications
✅ Automation-first setup (Supabase CLI + CI/CD)
✅ Verification via automated tests (not manual dashboard checks)

=== GIT STATUS BEFORE/AFTER ===

Before (.gitignore update):
  ?? .cache/                              # ❌ Bloat
  ?? _work/                               # ❌ Bloat
  ?? artifacts/figma/                     # ❌ Bloat
  ?? design-tokens/.figma-last-modified   # ❌ Bloat
  ?? design-tokens/figma-components.json  # ❌ Bloat

After (.gitignore update):
  M .gitignore                            # ✅ Tracked changes only
  ?? docs/supabase/W9_STUDIO_BOOKING_INTEGRATION.md  # ✅ New canonical guide
  ?? web/docs/evidence/20260220-0645+0800/           # ✅ Evidence bundles

Workspace artifacts no longer appear in git status.

=== FILES MODIFIED ===

1. docs/supabase/W9_STUDIO_BOOKING_INTEGRATION.md (CREATED, 15KB)
   - Automation-first setup (Supabase CLI)
   - Schema exposure decision (Option 1/2)
   - Security analysis and controls
   - CI/CD integration patterns
   - Automated verification tests

2. sandbox/dev/.artifacts/rotor-kinetic/SUPABASE_INTEGRATION.md (REPLACED, 628 bytes)
   - Pointer stub to canonical location
   - Rationale for move
   - Quick links

3. .gitignore (MODIFIED, +8 lines)
   - Workspace artifacts (.cache/, _work/)
   - Figma exports (artifacts/figma/, design-tokens/figma-*)
   - Vite env files (**/.env.local, **/.env.*.local)

=== IMPLEMENTATION CODE UNCHANGED ===

✅ package.json (unchanged)
✅ src/lib/supabase.ts (unchanged)
✅ src/lib/bookings.ts (unchanged)
✅ supabase/migrations/20260220_create_bookings.sql (unchanged)
✅ .env.local.example (unchanged)
✅ src/components/ui/BookingSection.jsx (unchanged)

=== COMMIT MESSAGE ===

docs(supabase): normalize W9 booking integration guide + ignore workspace artifacts

- Move SUPABASE_INTEGRATION.md → docs/supabase/W9_STUDIO_BOOKING_INTEGRATION.md
- Replace UI steps with Supabase CLI automation-first setup
- Add schema exposure decision (Option 1: server-only recommended)
- Document security controls for client access (Option 2)
- Update .gitignore: exclude .cache/, _work/, artifacts/figma/, design-tokens/figma-*
- Add automated verification tests (booking-smoke.test.ts spec)
- No implementation code changes

Fixes: Repo policy violations (no UI-step docs, no workspace bloat)
See: web/docs/evidence/20260220-0645+0800/w9-studio-supabase/logs/policy-compliance-patch.log

=== STATUS ===
✅ Policy violations fixed
✅ Implementation code unchanged
✅ Automation-first setup documented
✅ Security decision analysis added
✅ Workspace artifacts excluded from git

End of policy compliance patch log.
