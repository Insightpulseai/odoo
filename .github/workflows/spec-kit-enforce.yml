# .github/workflows/spec-kit-enforce.yml
name: Spec Kit Enforcement

on:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: spec-kit-enforce-${{ github.ref }}
  cancel-in-progress: true

jobs:
  spec-kit-enforce:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (YAML validator)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate required files + non-trivial content
        shell: bash
        run: |
          set -euo pipefail

          fail=0

          # For every spec/<slug>/constitution.md, enforce the full 4-file kit.
          while IFS= read -r cfile; do
            slug_dir="$(dirname "$cfile")"
            slug_name="$(basename "$slug_dir")"
            echo "Validating spec bundle: $slug_name"

            for f in constitution.md prd.md plan.md tasks.md; do
              path="$slug_dir/$f"
              if [ ! -f "$path" ]; then
                echo "::error file=$path::Missing required Spec Kit file: $path"
                fail=1
                continue
              fi

              # Non-trivial: at least 10 non-empty, non-heading lines
              non_empty="$(grep -Ev '^\s*$' "$path" | grep -Ev '^\s*#' | wc -l | tr -d ' ')"
              if [ "$non_empty" -lt 10 ]; then
                echo "::error file=$path::Spec file too small (<10 non-empty, non-heading lines). Add real content."
                fail=1
              fi

              # Block placeholder-y text patterns (warn only; enforce via fail if you want)
              if grep -Eqi '(TODO|TBD|PLACEHOLDER|FILL\s+ME\s+IN|LOREM\s+IPSUM)' "$path"; then
                echo "::warning file=$path::Spec contains placeholders (TODO/TBD/etc). Consider resolving."
              fi
            done
          done < <(find spec -mindepth 2 -maxdepth 2 -type f -name constitution.md -print 2>/dev/null || true)

          # Require CLAUDE.md
          if [ ! -f "CLAUDE.md" ]; then
            echo "::error::Missing CLAUDE.md at repo root"
            fail=1
          fi

          # Check for .claude directory (optional warning)
          if [ ! -d ".claude" ]; then
            echo "::warning::Missing .claude/ directory"
          fi

          # Check for verification scripts
          if [ ! -f "scripts/verify.sh" ] && [ ! -f "scripts/ci_local.sh" ]; then
            echo "::warning::No verify script found (scripts/verify.sh or scripts/ci_local.sh)"
          fi

          exit "$fail"

      - name: Validate YAML files (spec bundles)
        shell: bash
        run: |
          set -euo pipefail

          # Find YAML files in spec bundles
          yaml_files="$(find spec -type f \( -name "*.yaml" -o -name "*.yml" \) 2>/dev/null || true)"
          if [ -n "$yaml_files" ]; then
            echo "Validating YAML files in spec bundles..."
            while IFS= read -r f; do
              [ -z "$f" ] && continue
              python3 -c "import yaml; yaml.safe_load(open(r'''$f''', encoding='utf-8')); print('OK:', r'''$f''')"
            done <<< "$yaml_files"
          else
            echo "No YAML files found under spec/."
          fi
