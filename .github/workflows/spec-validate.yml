name: Spec Bundle Validation

on:
  push:
    paths:
      - 'spec/**'
      - '.github/workflows/spec-validate.yml'
  pull_request:
    paths:
      - 'spec/**'

jobs:
  validate-specs:
    name: Validate Spec Bundles
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check spec bundle structure
        run: |
          echo "Validating spec bundle structure..."

          errors=0

          for spec_dir in spec/*/; do
            if [[ -d "$spec_dir" ]]; then
              spec_name=$(basename "$spec_dir")
              echo "Checking spec: $spec_name"

              # Required files
              required_files=("constitution.md" "prd.md" "plan.md" "tasks.md")

              for file in "${required_files[@]}"; do
                if [[ ! -f "${spec_dir}${file}" ]]; then
                  echo "  ERROR: Missing required file: $file"
                  errors=$((errors + 1))
                else
                  echo "  OK: $file"
                fi
              done

              # Check constitution.md has required sections
              if [[ -f "${spec_dir}constitution.md" ]]; then
                if ! grep -q "## Non-Negotiables" "${spec_dir}constitution.md"; then
                  echo "  WARNING: constitution.md missing '## Non-Negotiables' section"
                fi
              fi

              # Check tasks.md has checkbox items
              if [[ -f "${spec_dir}tasks.md" ]]; then
                if ! grep -q "\- \[" "${spec_dir}tasks.md"; then
                  echo "  WARNING: tasks.md has no checkbox items"
                fi
              fi
            fi
          done

          if [[ $errors -gt 0 ]]; then
            echo ""
            echo "Validation failed with $errors errors"
            exit 1
          fi

          echo ""
          echo "All spec bundles validated successfully!"

      - name: Check markdown formatting
        run: |
          npm install -g markdownlint-cli

          # Lint all spec markdown files
          for spec_dir in spec/*/; do
            if [[ -d "$spec_dir" ]]; then
              markdownlint "${spec_dir}"*.md --config .markdownlint.json || true
            fi
          done

      - name: Generate spec summary
        run: |
          echo "# Spec Bundle Summary" > spec-summary.md
          echo "" >> spec-summary.md
          echo "| Spec | Constitution | PRD | Plan | Tasks |" >> spec-summary.md
          echo "|------|--------------|-----|------|-------|" >> spec-summary.md

          for spec_dir in spec/*/; do
            if [[ -d "$spec_dir" ]]; then
              spec_name=$(basename "$spec_dir")

              constitution=$(if [[ -f "${spec_dir}constitution.md" ]]; then echo "✅"; else echo "❌"; fi)
              prd=$(if [[ -f "${spec_dir}prd.md" ]]; then echo "✅"; else echo "❌"; fi)
              plan=$(if [[ -f "${spec_dir}plan.md" ]]; then echo "✅"; else echo "❌"; fi)
              tasks=$(if [[ -f "${spec_dir}tasks.md" ]]; then echo "✅"; else echo "❌"; fi)

              echo "| $spec_name | $constitution | $prd | $plan | $tasks |" >> spec-summary.md
            fi
          done

          cat spec-summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: spec-summary
          path: spec-summary.md
          retention-days: 30
