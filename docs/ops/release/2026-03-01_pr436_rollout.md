# PR #436 + #438 Rollout Checklist — 2026-03-01

## Context
- PR #436 merged: mail catcher + DO ingest + ops.capabilities + work-items webhooks + processor + tests
- PR #438 merged: fix(ops-console) exclude tests/ from tsc + playwright.config + webhook fn registration

## Pre-deployment (DONE)
- [x] `20260301000050_ops_digitalocean.sql` — committed
- [x] `20260301000055_ops_mail_events.sql` — committed
- [x] `20260301000060_ops_capabilities.sql` — committed
- [x] `20260301000065_ops_workitems_webhooks.sql` — committed
- [x] `ops-mailgun-ingest` Edge Function — committed
- [x] `ops-do-ingest` Edge Function — committed
- [x] `ops-workitems-processor` Edge Function — committed
- [x] Webhook routes `/api/webhooks/plane` + `/api/webhooks/github` — committed
- [x] SSOT sources: `ssot/sources/plane/work_items.yaml`, `ssot/sources/github/work_items.yaml`
- [x] Contracts: `C-PLANE-02` (C-21), `C-GH-02` (C-22)

## Deployment Steps

### 1. Apply migrations (prod)
```bash
# Requires valid SUPABASE_ACCESS_TOKEN — refresh at supabase.com/dashboard/account/tokens
supabase link --project-ref spdtwktxdalcfigzeqrz
supabase db push
```
Verify: `ops.mail_events`, `ops.plane_webhook_deliveries`, `ops.github_webhook_deliveries`, `ops.work_queue`, `ops.work_items` tables exist with correct RLS.

### 2. Deploy Edge Functions
```bash
supabase functions deploy ops-mailgun-ingest --project-ref spdtwktxdalcfigzeqrz
supabase functions deploy ops-do-ingest --project-ref spdtwktxdalcfigzeqrz
supabase functions deploy ops-workitems-processor --project-ref spdtwktxdalcfigzeqrz
```

### 3. Set Supabase Vault secret
SSOT ref: `mailgun_signing_key` (see `ssot/secrets/registry.yaml`)
```bash
supabase secrets set MAILGUN_SIGNING_KEY=<value> --project-ref spdtwktxdalcfigzeqrz
```

### 4. Set Vercel env vars for ops-console
Project: `odooops-console`
```bash
vercel env add PLANE_WEBHOOK_SECRET production --yes
vercel env add GITHUB_WEBHOOK_SECRET production --yes
```
SSOT refs: `plane_webhook_secret`, `github_webhook_secret` (see `ssot/secrets/registry.yaml`)

### 5. Activate ops.insightpulseai.com
1. [MANUAL] Add `ops.insightpulseai.com` as custom domain in Vercel project `odooops-console`
2. Update `infra/dns/subdomain-registry.yaml` line ~263:
   - `lifecycle: planned` → `lifecycle: active`
   - Add `provider_claim.status: claimed`, `claimed_at: <today>`, `claim_ref: vercel:prj_<project-id>`

## Verification Checklist
- [ ] `POST /api/webhooks/plane` → 200 JSON with valid sig, 403 JSON with invalid sig
- [ ] `POST /api/webhooks/github` → same
- [ ] `ops.plane_webhook_deliveries` rows populate on webhook delivery
- [ ] `ops.work_items` updated after processor runs
- [ ] `ops.mail_events` populated on Mailgun webhook delivery
- [ ] `ops.do_droplets` / `ops.do_databases` / `ops.do_firewalls` have recent rows
- [ ] `/platform/digitalocean` page renders with data
- [ ] `ops.insightpulseai.com` resolves to Vercel ops-console deployment

## Links
- PR #436: https://github.com/Insightpulseai/odoo/pull/436 (merged)
- PR #438: https://github.com/Insightpulseai/odoo/pull/438 (merged)
- Supabase project: https://supabase.com/dashboard/project/spdtwktxdalcfigzeqrz
- Vercel project: https://vercel.com/tbwa/odooops-console
