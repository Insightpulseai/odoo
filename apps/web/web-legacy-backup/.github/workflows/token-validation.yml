name: Token Validation

on:
  pull_request:
    paths:
      - 'pkgs/ipai-design-tokens/**'
      - 'web/*/src/**/*.tsx'
      - 'web/*/src/**/*.ts'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Generate tokens
        run: cd pkgs/ipai-design-tokens && pnpm generate:tokens

      - name: Check for uncommitted changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "❌ Generated token files differ from committed versions"
            echo "Run 'pnpm generate:tokens' in pkgs/ipai-design-tokens and commit the changes"
            git diff
            exit 1
          fi
          echo "✅ Token files are in sync"

      - name: Validate token usage
        run: |
          # Check for hardcoded colors in components
          HARDCODED=$(grep -r "bg-\[#" web/web/src/ || true)
          if [[ -n "$HARDCODED" ]]; then
            echo "❌ Hardcoded colors found:"
            echo "$HARDCODED"
            exit 1
          fi
          echo "✅ No hardcoded colors found"

      - name: Validate hex color usage
        run: |
          # Check for hardcoded hex colors in style attributes
          HARDCODED_HEX=$(grep -rE '(backgroundColor|color|borderColor):\s*["\']#[0-9a-fA-F]{3,8}["\']' web/web/src/ || true)
          if [[ -n "$HARDCODED_HEX" ]]; then
            echo "⚠️ Warning: Direct hex colors found (should use tokens):"
            echo "$HARDCODED_HEX"
            # Don't fail, just warn for now
          fi
          echo "✅ Hex color validation complete"
