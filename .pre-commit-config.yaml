# OCA Pre-commit Configuration for Odoo 18 CE
# Ensures code quality and OCA compliance before commit
#
# Usage:
#   pip install pre-commit
#   pre-commit install
#   pre-commit install --hook-type commit-msg
#   pre-commit run --all-files
#
# OCA Alignment: https://github.com/OCA/maintainer-tools
#
repos:
  # =============================================================================
  # OCA Maintainer Tools - README/Icon Generation
  # =============================================================================
  - repo: https://github.com/OCA/maintainer-tools
    rev: master
    hooks:
      # Generate README.rst from readme/ folder fragments
      - id: oca-gen-addon-readme
        args:
          - --addons-dir=addons
          - --org-name=InsightPulseAI
          - --repo-name=odoo-ce
          - --branch=main

      # Generate module icons from template
      - id: oca-gen-addon-icon
        args:
          - --addons-dir=addons

  # =============================================================================
  # OCA Official Hooks - Odoo-specific validation
  # =============================================================================
  - repo: https://github.com/OCA/odoo-pre-commit-hooks
    rev: v0.0.35
    hooks:
      - id: oca-checks-odoo-module
        description: Multiple OCA checks for Odoo modules (manifest, CSV, XML)
      - id: oca-checks-po
        description: Multiple checks for PO translation files

  # Python Code Formatting (Black)
  - repo: https://github.com/psf/black
    rev: 25.11.0
    hooks:
      - id: black
        args: [--line-length=88]
        files: ^addons/

  # Import Sorting (isort)
  - repo: https://github.com/pycqa/isort
    rev: 7.0.0
    hooks:
      - id: isort
        args: [--profile=black, --line-length=88]
        files: ^addons/

  # Flake8 Linting (PEP8)
  # Configuration in .flake8 file - ignores F401/E741 for Odoo module patterns
  - repo: https://github.com/pycqa/flake8
    rev: 7.3.0
    hooks:
      - id: flake8
        files: ^addons/

  # YAML Validation
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.37.1
    hooks:
      - id: yamllint
        args: [-d, relaxed]
        files: \.(yaml|yml)$

  # Standard Pre-commit Hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
        exclude: \.po$|\.pot$
      - id: end-of-file-fixer
        exclude: \.po$|\.pot$
      - id: check-yaml
        args: [--unsafe]
      - id: check-xml
      - id: check-json
      - id: check-merge-conflict
      - id: check-added-large-files
        args: [--maxkb=1000]
      - id: debug-statements
        files: ^addons/

  # Pylint Odoo (Optional - can be slow)
  # Uncomment for stricter OCA compliance
  # - repo: https://github.com/OCA/pylint-odoo
  #   rev: v9.0.5
  #   hooks:
  #     - id: pylint-odoo
  #       args: [--rcfile=.pylintrc]
  #       files: ^addons/

  # =============================================================================
  # Conventional Commits (commit message validation)
  # =============================================================================
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v3.1.0
    hooks:
      - id: conventional-pre-commit
        stages: [commit-msg]
        args:
          - feat
          - fix
          - docs
          - style
          - refactor
          - perf
          - test
          - build
          - ci
          - chore
          - revert

  # =============================================================================
  # Local Hooks (Custom Policy Enforcement)
  # =============================================================================
  - repo: local
    hooks:
      # Check for Enterprise/IAP dependencies
      - id: no-enterprise-deps
        name: No Enterprise Dependencies
        entry: bash -c 'scripts/policy-check.sh --diff || true'
        language: system
        pass_filenames: false
        types: [python]

      # Validate spec bundles on spec changes
      - id: validate-spec-kit
        name: Validate Spec Kit
        entry: bash -c 'scripts/validate-spec-kit.sh || true'
        language: system
        pass_filenames: false
        files: ^spec/

      # Validate manifest icons
      - id: odoo-manifest-check
        name: Odoo Manifest Validator
        entry: python3 scripts/validate_manifest.py
        language: system
        files: __manifest__\.py$
        pass_filenames: false

# =============================================================================
# CI Configuration
# =============================================================================
ci:
  autofix_commit_msg: |
    style: auto fixes from pre-commit hooks [skip ci]
  autofix_prs: true
  autoupdate_commit_msg: 'ci: pre-commit autoupdate'
  autoupdate_schedule: monthly
  skip:
    - no-enterprise-deps  # Run in CI workflow instead
    - validate-spec-kit   # Run in CI workflow instead
  submodules: false
