name: Cloudflare Authority Gate

# =============================================================================
# Two-job gate for DNS/Terraform PRs.
#
# Job 1 — provider-claims:
#   Validates that every lifecycle=active record in infra/dns/subdomain-registry.yaml
#   has a verified provider claim (status=claimed + claimed_at + claim_ref).
#   Fails on planned records with an expired expires_at.
#   Blocks merge before any DNS or Terraform changes land.
#
# Job 2 — authority-check:
#   Verifies Cloudflare is the authoritative NS for insightpulseai.com.
#   Runs ONLY if provider-claims passes (needs: [provider-claims]).
#   Prevents DNS record commits from merging when NS delegation is still pending.
#
# Pass:  Both gates green → PR may merge.
# Fail:  Either gate fails → PR blocked with actionable PR comment.
# Bypass (authority-check only): add label "cf-ns-pending" to the PR.
#         provider-claims has NO bypass — claim evidence is always required.
#
# Secrets required: none (all checks are SSOT-file or public DNS queries).
# =============================================================================

on:
  pull_request:
    paths:
      - "infra/cloudflare/**"
      - "infra/dns/**"
      - "ssot/secrets/registry.yaml"
      - "scripts/ci/check_dns_provider_claims.py"
  workflow_dispatch:
    inputs:
      domain:
        description: "Domain to check (default: insightpulseai.com)"
        required: false
        default: "insightpulseai.com"

permissions:
  contents: read
  pull-requests: write

# ─── Job 1: Provider Claim Gate ───────────────────────────────────────────────
jobs:
  provider-claims:
    name: DNS provider claim gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PyYAML
        run: pip install pyyaml --quiet

      - name: Run provider claim gate
        id: gate
        run: |
          python3 scripts/ci/check_dns_provider_claims.py \
            2>&1 | tee /tmp/provider_claims.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Post PR comment (failure)
        if: steps.gate.outputs.exit_code != '0' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LOG=$(cat /tmp/provider_claims.log 2>/dev/null | head -c 3000 || echo "Log unavailable")
          {
            echo '## DNS Provider Claim Gate — FAILED'
            echo ''
            echo 'One or more `lifecycle: active` records lack a verified provider claim,'
            echo 'or a `lifecycle: planned` record has passed its `expires_at` deadline.'
            echo ''
            echo '### Rules'
            echo ''
            echo '| Condition | Requirement |'
            echo '|-----------|-------------|'
            echo '| `lifecycle: active` | `provider_claim.status: claimed` + `claimed_at` + `claim_ref` |'
            echo '| `lifecycle: planned` + `expires_at` in the past | Must resolve or extend deadline |'
            echo ''
            echo '### Remediation'
            echo ''
            echo '**A) Record is active but unclaimed** (e.g., Vercel CNAME not yet set up):'
            echo '```yaml'
            echo '# Step 1: Temporarily keep as planned'
            echo 'lifecycle: planned'
            echo 'provider_claim:'
            echo '  provider: vercel'
            echo '  status: unclaimed'
            echo '  expires_at: "YYYY-MM-DD"   # ~21 days'
            echo ''
            echo '# Step 2: After claiming domain in Vercel dashboard:'
            echo 'lifecycle: active'
            echo 'provider_claim:'
            echo '  provider: vercel'
            echo '  status: claimed'
            echo '  claimed_at: "YYYY-MM-DD"'
            echo '  claim_ref: "vercel:prj_<your-project-id>"'
            echo '```'
            echo ''
            echo '**B) Planned record expired** → claim the domain and transition to active (see above),'
            echo 'or extend `expires_at` with justification in the commit message.'
            echo ''
            echo '---'
            echo '<details><summary>Gate output</summary>'
            echo ''
            echo '```'
            echo "$LOG"
            echo '```'
            echo '</details>'
          } > /tmp/claims_comment.md
          gh pr comment "${{ github.event.pull_request.number }}" --body-file /tmp/claims_comment.md

      - name: Fail gate
        if: steps.gate.outputs.exit_code != '0'
        run: |
          echo "::error::DNS provider claim gate failed."
          echo "::error::Active records must have status=claimed + claimed_at + claim_ref."
          echo "::error::Planned records cannot have expired expires_at."
          echo "::error::See PR comment for remediation."
          exit 1

      - name: Pass
        if: steps.gate.outputs.exit_code == '0'
        run: echo "DNS provider claim gate passed."

# ─── Job 2: Cloudflare NS Authority Check ────────────────────────────────────
  authority-check:
    name: Verify Cloudflare is authoritative
    runs-on: ubuntu-latest
    needs: [provider-claims]   # ← hard prerequisite: claim gate must pass first
    env:
      VERIFY_DOMAIN: ${{ github.event.inputs.domain || 'insightpulseai.com' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dig (dnsutils)
        run: sudo apt-get install -y dnsutils

      - name: Check Cloudflare authority
        id: authority
        run: |
          python3 scripts/cloudflare/verify_authoritative.py \
            --domain "$VERIFY_DOMAIN" \
            2>&1 | tee /tmp/authority_check.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Read check result
        id: result
        run: |
          if grep -q "PASS" /tmp/authority_check.log; then
            echo "authoritative=true" >> "$GITHUB_OUTPUT"
          else
            echo "authoritative=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for bypass label
        id: bypass
        if: steps.result.outputs.authoritative == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LABELS=$(gh pr view "${{ github.event.pull_request.number }}" \
            --json labels --jq '.labels[].name' 2>/dev/null || echo "")
          if echo "$LABELS" | grep -q "cf-ns-pending"; then
            echo "bypassed=true" >> "$GITHUB_OUTPUT"
            echo "Bypass label 'cf-ns-pending' found -- gate warning only, not blocking."
          else
            echo "bypassed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Post PR comment (if not authoritative)
        if: steps.result.outputs.authoritative == 'false' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LOG=$(head -c 2000 /tmp/authority_check.log 2>/dev/null || echo "Log unavailable")
          {
            echo '## Cloudflare Authority Gate — FAILED'
            echo ''
            echo 'Cloudflare is NOT currently the authoritative DNS for `insightpulseai.com`.'
            echo ''
            echo 'DNS record changes committed to `infra/cloudflare/zones/` will have no effect'
            echo 'until Cloudflare nameservers are delegated.'
            echo ''
            echo '### Required action (one-time, at registrar)'
            echo ''
            echo '1. Log into Spacesquare (domain registrar)'
            echo '2. Set nameservers to:'
            echo '   - `edna.ns.cloudflare.com`'
            echo '   - `keanu.ns.cloudflare.com`'
            echo '3. Wait for NS propagation (up to 24-48 hours)'
            echo '4. Re-run this check: trigger the Cloudflare Authority Gate workflow manually'
            echo ''
            echo '### While delegation is pending'
            echo ''
            echo 'Add label `cf-ns-pending` to this PR to convert the gate from blocking to warning-only.'
            echo 'DNS record commits are still safe to merge -- they will apply once delegation completes.'
            echo ''
            echo '---'
            echo '<details><summary>Check log</summary>'
            echo ''
            echo '```'
            echo "$LOG"
            echo '```'
            echo '</details>'
          } > /tmp/cf_comment.md
          gh pr comment "${{ github.event.pull_request.number }}" --body-file /tmp/cf_comment.md

      - name: Fail gate (if not authoritative and not bypassed)
        if: steps.result.outputs.authoritative == 'false' && steps.bypass.outputs.bypassed != 'true'
        run: |
          echo "::error::Cloudflare is NOT authoritative for $VERIFY_DOMAIN."
          echo "::error::DNS record changes will have no effect until NS delegation is complete."
          echo "::error::See PR comment for remediation steps, or add label 'cf-ns-pending' to bypass."
          exit 1

      - name: Warn (bypassed)
        if: steps.result.outputs.authoritative == 'false' && steps.bypass.outputs.bypassed == 'true'
        run: |
          echo "::warning::Cloudflare is NOT authoritative for $VERIFY_DOMAIN (bypass active via 'cf-ns-pending' label)."
          echo "::warning::DNS record commits will apply once NS delegation completes."

      - name: Pass
        if: steps.result.outputs.authoritative == 'true'
        run: |
          echo "Cloudflare is authoritative for $VERIFY_DOMAIN -- DNS changes will apply on merge."

# ─── Job 3: Dual-Writer Scan ─────────────────────────────────────────────────
  dual-writer-scan:
    name: Dual-writer scan (this repo only)
    runs-on: ubuntu-latest
    # Runs independently — no dependency on other jobs.
    # This validates that the odoo repo itself stays clean of ad-hoc resources.

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Scan for zone-write Terraform resources
        id: scan
        run: |
          # Pass --allow-odoo-repo so the check skips if GITHUB_REPOSITORY == Insightpulseai/odoo.
          # The check is primarily useful when run in *other* repos to prevent split-brain.
          # In this repo we run it to keep the script exercised and its exit-path validated.
          python3 scripts/ci/check_dns_dual_writer.py \
            --repo-root . \
            --allow-odoo-repo \
            2>&1 | tee /tmp/dual_writer_scan.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Fail on violation
        if: steps.scan.outputs.exit_code != '0'
        run: |
          echo "::error::Dual-writer violation: this repo contains Cloudflare zone-write resources"
          echo "::error::that conflict with the DNS authority contract."
          echo "::error::See docs/architecture/DNS_AUTHORITY_CONTRACT.md for remediation."
          cat /tmp/dual_writer_scan.log
          exit 1

      - name: Pass
        if: steps.scan.outputs.exit_code == '0'
        run: echo "Dual-writer scan passed — no conflicting Cloudflare resources found."
