# =============================================================================
# GitHub Actions: Continuous Deployment to Production
# =============================================================================
# Unified pipeline: Build → Test → Deploy → Verify → Tag
#
# Triggers:
#   - Push to main branch (auto-deploy)
#   - Manual workflow dispatch
#
# Target: erp.insightpulseai.net (DigitalOcean Droplet)
# =============================================================================

name: CD Production

on:
  push:
    branches:
      - main
    paths:
      - 'addons/**'
      - 'docker/**'
      - 'config/**'
      - 'deploy/**'
      - 'scripts/**'
      - '.github/workflows/cd-production.yml'
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip build and use existing image'
        required: false
        default: false
        type: boolean
      image_tag:
        description: 'Image tag to deploy (if skip_build)'
        required: false
        default: 'edge-standard'
        type: string
      dry_run:
        description: 'Dry run (no actual deployment)'
        required: false
        default: false
        type: boolean

concurrency:
  group: cd-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: jgtolentino/odoo-ce
  DEPLOY_TAG: prod-${{ github.run_id }}

jobs:
  # ===========================================================================
  # Stage 1: Build Docker Image
  # ===========================================================================
  build:
    name: Build & Push Image
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_build }}
    permissions:
      contents: read
      packages: write

    outputs:
      image_digest: ${{ steps.build.outputs.digest }}
      image_tag: ${{ steps.tags.outputs.deploy_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate tags
        id: tags
        run: |
          TIMESTAMP=$(date -u +'%Y%m%d-%H%M')
          DEPLOY_TAG="prod-${TIMESTAMP}"
          SHORT_SHA="${GITHUB_SHA::7}"

          echo "deploy_tag=${DEPLOY_TAG}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.unified
          build-args: |
            PROFILE=standard
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_SHA=${{ github.sha }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.tags.outputs.deploy_tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:edge-standard
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha,scope=standard
          cache-to: type=gha,mode=max,scope=standard

      - name: Summary
        run: |
          echo "## Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image | \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | \`${{ steps.tags.outputs.deploy_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| SHA | \`${{ steps.tags.outputs.short_sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Stage 2: Smoke Test
  # ===========================================================================
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    needs: build
    if: ${{ !inputs.skip_build }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run smoke test
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.build.outputs.image_tag }}"
          echo "Testing image: $IMAGE"

          # Pull the image
          docker pull "$IMAGE"

          # Run --stop-after-init test
          docker run --rm \
            -e DB_HOST=localhost \
            "$IMAGE" \
            odoo --version

          echo "Smoke test passed"

      - name: Cleanup
        if: always()
        run: docker system prune -f || true

  # ===========================================================================
  # Stage 3: Deploy to Production
  # ===========================================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, smoke-test]
    if: |
      always() &&
      (needs.build.result == 'success' || inputs.skip_build) &&
      (needs.smoke-test.result == 'success' || inputs.skip_build) &&
      !inputs.dry_run

    environment:
      name: production
      url: https://erp.insightpulseai.net

    outputs:
      deployed_tag: ${{ steps.deploy.outputs.tag }}
      deploy_status: ${{ steps.deploy.outputs.status }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine image tag
        id: image
        run: |
          if [ "${{ inputs.skip_build }}" == "true" ]; then
            TAG="${{ inputs.image_tag }}"
          else
            TAG="${{ needs.build.outputs.image_tag }}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Deploying image tag: $TAG"

      - name: Deploy via SSH
        id: deploy
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          IMAGE_TAG: ${{ steps.image.outputs.tag }}
        run: |
          # Check secrets are configured
          if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$SSH_HOST" ]; then
            echo "::error::SSH secrets not configured"
            echo "Required secrets: SSH_PRIVATE_KEY, SSH_HOST, SSH_USER"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Setup SSH with retry logic
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Retry ssh-keyscan with exponential backoff
          for i in 1 2 3 4; do
            if ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null; then
              echo "SSH keyscan successful"
              break
            fi
            WAIT=$((2**i))
            echo "Retry $i: waiting ${WAIT}s..."
            sleep $WAIT
          done

          # Deploy with retry logic
          MAX_RETRIES=4
          RETRY=0

          while [ $RETRY -lt $MAX_RETRIES ]; do
            if ssh -i ~/.ssh/deploy_key -o ConnectTimeout=30 "${SSH_USER}@${SSH_HOST}" << DEPLOY_EOF
              set -e
              echo "=== Starting deployment ==="

              # Navigate to repo
              cd /opt/odoo-ce || cd /workspace/odoo-ce || cd ~/odoo-ce

              # Pull latest code
              echo "Pulling latest code..."
              git fetch origin main
              git checkout main
              git pull origin main --ff-only

              # Update submodules
              git submodule update --init --recursive

              # Login to GHCR
              echo "Logging into registry..."
              echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

              # Pull new image
              echo "Pulling image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}..."
              docker pull "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"

              # Tag as latest for docker-compose
              docker tag "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}" "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"

              # Recreate containers
              echo "Recreating containers..."
              cd deploy
              docker compose -f docker-compose.prod.yml pull
              docker compose -f docker-compose.prod.yml up -d --force-recreate

              # Wait for Odoo to start
              echo "Waiting for Odoo to initialize..."
              sleep 45

              # Health check with retries
              for i in 1 2 3 4 5; do
                if curl -sf http://localhost:8069/web/health > /dev/null 2>&1; then
                  echo "Health check passed!"
                  exit 0
                fi
                echo "Health check attempt \$i failed, retrying..."
                sleep 10
              done

              echo "Health check failed after retries"
              docker logs odoo-ce --tail 50
              exit 1
DEPLOY_EOF
            then
              echo "Deployment successful!"
              echo "status=success" >> $GITHUB_OUTPUT
              echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
              exit 0
            fi

            RETRY=$((RETRY + 1))
            if [ $RETRY -lt $MAX_RETRIES ]; then
              WAIT=$((2**RETRY))
              echo "Deploy attempt $RETRY failed. Retrying in ${WAIT}s..."
              sleep $WAIT
            fi
          done

          echo "::error::Deployment failed after $MAX_RETRIES attempts"
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1

      - name: Deploy summary
        if: always()
        run: |
          echo "## Deployment Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Target | erp.insightpulseai.net |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ steps.image.outputs.tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ steps.deploy.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered By | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Stage 4: Production Verification
  # ===========================================================================
  verify:
    name: Verify Production
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.outputs.deploy_status == 'success'

    steps:
      - name: Wait for stability
        run: sleep 30

      - name: Health check
        id: health
        run: |
          # Try public health endpoint
          for i in 1 2 3 4 5; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              --connect-timeout 10 \
              --max-time 30 \
              "https://erp.insightpulseai.net/web/health" || echo "000")

            echo "Attempt $i: HTTP $HTTP_CODE"

            if [ "$HTTP_CODE" == "200" ]; then
              echo "status=healthy" >> $GITHUB_OUTPUT
              echo "Production is healthy!"
              exit 0
            fi

            sleep 15
          done

          echo "status=unhealthy" >> $GITHUB_OUTPUT
          echo "::warning::Production health check returned HTTP $HTTP_CODE"

      - name: Login page check
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            --connect-timeout 10 \
            "https://erp.insightpulseai.net/web/login" || echo "000")

          echo "Login page: HTTP $HTTP_CODE"

          if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "303" ]; then
            echo "Login page accessible"
          else
            echo "::warning::Login page returned HTTP $HTTP_CODE"
          fi

      - name: Verification summary
        run: |
          echo "## Production Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| /web/health | ${{ steps.health.outputs.status }} |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Stage 5: Auto-Tag Release
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [deploy, verify]
    if: needs.deploy.outputs.deploy_status == 'success'
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create release tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.deploy.outputs.deployed_tag }}"

          # Create and push tag
          git tag "$TAG" -m "Production deployment $TAG"

          # Push with retry
          for i in 1 2 3 4; do
            if git push origin "$TAG"; then
              echo "Tag pushed successfully"
              break
            fi
            WAIT=$((2**i))
            echo "Push failed, retrying in ${WAIT}s..."
            sleep $WAIT
          done

          # Create GitHub release
          gh release create "$TAG" \
            --title "Production: $TAG" \
            --notes "Automated production deployment

**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG\`
**Commit:** ${{ github.sha }}
**Deployed by:** ${{ github.actor }}
**Workflow:** [Run #${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" \
            --latest

      - name: Release summary
        run: |
          echo "## Release Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ needs.deploy.outputs.deployed_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${{ needs.deploy.outputs.deployed_tag }})" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Notify on Failure
  # ===========================================================================
  notify-failure:
    name: Notify Failure
    runs-on: ubuntu-latest
    needs: [build, smoke-test, deploy, verify]
    if: failure()

    steps:
      - name: Create failure issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create \
            --repo ${{ github.repository }} \
            --title "CD Pipeline Failed: ${{ github.run_id }}" \
            --body "## CD Pipeline Failure

**Workflow Run:** [#${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
**Triggered by:** ${{ github.actor }}
**Commit:** ${{ github.sha }}

### Failed Jobs
Check the workflow run for details on which stage failed.

### Recovery Steps
1. Check the workflow logs
2. Fix the issue
3. Re-run the workflow or push a fix to main" \
            --label "bug,ci" || echo "Could not create issue"

      - name: Failure summary
        run: |
          echo "## Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the job logs above for details." >> $GITHUB_STEP_SUMMARY
