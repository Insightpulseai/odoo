# Gate Contract v2.0 Specification

**Version:** 2.0
**Last Updated:** 2026-02-13
**Status:** Design Specification
**Authors:** AI Agent (implementation pending)

---

## Purpose

This specification defines a unified contract for all quality gates in the Odoo repository. All gates must produce:

1. **Machine-readable JSON report** (schema: `schemas/gate_report.schema.json`)
2. **Human-readable Markdown summary** (template below)
3. **Standard exit codes** for CI integration

---

## Exit Code Conventions

| Code | Status | Meaning | CI Behavior |
|------|--------|---------|-------------|
| `0` | PASS | All checks passed | Continue workflow |
| `1` | FAIL | Critical issues found | Fail workflow |
| `2` | WARN | Warnings found (non-blocking) | Continue with annotation |

**Local mode:** Warnings (exit code 2) are treated as pass
**CI mode:** Warnings can be configured to fail (strict mode)

---

## JSON Report Schema

See `schemas/gate_report.schema.json` for full JSON Schema definition.

**Minimal example:**

```json
{
  "version": "2.0",
  "timestamp": "2026-02-13T10:30:00Z",
  "environment": "ci",
  "gates": [
    {
      "name": "seed_data_consistency",
      "status": "pass",
      "duration_seconds": 1.234,
      "findings": [],
      "metrics": {
        "employees_count": 9,
        "bir_records_count": 144,
        "tasks_count": 36
      }
    }
  ],
  "summary": {
    "total": 1,
    "passed": 1,
    "failed": 0,
    "warnings": 0
  }
}
```

**Required fields:**
- `version`: Schema version (currently "2.0")
- `timestamp`: ISO 8601 timestamp
- `environment`: `"local"` or `"ci"`
- `gates`: Array of gate results
- `summary`: Aggregate statistics

**Gate result object:**
- `name`: Gate identifier (snake_case)
- `status`: `"pass"`, `"fail"`, or `"warn"`
- `duration_seconds`: Execution time (float)
- `findings`: Array of issue objects (empty if pass)
- `metrics`: Gate-specific metrics (object)

**Finding object:**
```json
{
  "level": "error|warning|info",
  "message": "Human-readable description",
  "file": "path/to/file.py",
  "line": 42,
  "column": 10,
  "rule": "gate-specific-rule-id"
}
```

---

## Markdown Summary Template

Gates must generate a Markdown summary in this format:

```markdown
# Gate Report: [GATE_NAME]

**Status:** ✅ PASS / ❌ FAIL / ⚠️ WARN
**Duration:** X.XXs
**Environment:** local / ci
**Timestamp:** YYYY-MM-DD HH:MM:SS UTC

## Summary

[Brief description of what was validated]

## Metrics

| Metric | Value | Threshold | Status |
|--------|-------|-----------|--------|
| Employees | 9 | >= 8 | ✅ |
| BIR Records | 144 | >= 20 | ✅ |
| Tasks | 36 | >= 30 | ✅ |

## Findings

[If status is FAIL or WARN, list findings here]

### Errors (0)

[List errors if any]

### Warnings (0)

[List warnings if any]

## Details

[Gate-specific detailed output]

---
Generated by: [gate-script-name]
Report version: 2.0
```

---

## File Naming Conventions

**JSON reports:**
```
artifacts/gates/<gate-name>/<timestamp>.json
artifacts/gates/<gate-name>/latest.json  # symlink to most recent
```

**Markdown summaries:**
```
artifacts/gates/<gate-name>/<timestamp>.md
artifacts/gates/<gate-name>/latest.md  # symlink to most recent
```

**CI artifacts:**
```
artifacts/ci/<workflow-run-id>/gate-summary.json  # aggregated
artifacts/ci/<workflow-run-id>/gate-summary.md
```

---

## Gate Script Requirements

All gate scripts must:

1. **Accept mode flag:** `--mode=local|ci` (default: local)
2. **Write JSON report** to `artifacts/gates/<gate-name>/<timestamp>.json`
3. **Write Markdown summary** to `artifacts/gates/<gate-name>/<timestamp>.md`
4. **Create symlinks** to `latest.json` and `latest.md`
5. **Exit with appropriate code:** 0 (pass), 1 (fail), 2 (warn)
6. **Include timestamp** in ISO 8601 format
7. **Log to stderr** for human consumption (stdout is for structured output)

**Example gate script structure:**

```bash
#!/usr/bin/env bash
set -euo pipefail

GATE_NAME="example_gate"
MODE="${1:-local}"  # local or ci
TIMESTAMP="$(date -u +%Y%m%d-%H%M%S)"
ARTIFACT_DIR="artifacts/gates/${GATE_NAME}"

mkdir -p "${ARTIFACT_DIR}"

# Run checks and collect results
# ... gate-specific logic ...

# Write JSON report
cat > "${ARTIFACT_DIR}/${TIMESTAMP}.json" << EOF
{
  "version": "2.0",
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "environment": "${MODE}",
  "gates": [
    {
      "name": "${GATE_NAME}",
      "status": "pass",
      "duration_seconds": 1.234,
      "findings": [],
      "metrics": {}
    }
  ],
  "summary": {
    "total": 1,
    "passed": 1,
    "failed": 0,
    "warnings": 0
  }
}
EOF

# Write Markdown summary
cat > "${ARTIFACT_DIR}/${TIMESTAMP}.md" << EOF
# Gate Report: ${GATE_NAME}
[... markdown template ...]
EOF

# Create symlinks
ln -sf "${TIMESTAMP}.json" "${ARTIFACT_DIR}/latest.json"
ln -sf "${TIMESTAMP}.md" "${ARTIFACT_DIR}/latest.md"

# Exit with appropriate code
exit 0  # or 1 for fail, 2 for warn
```

---

## Integration with Existing Tools

### Reuse Pattern: `scripts/gates/run_parity_gates.sh`

The existing parity gate script (13K lines) provides reusable functions:

```bash
# JSON summary generation
update_gate_summary() {
  local gate_name="$1"
  local status="$2"  # pass, fail, warn
  local duration="$3"
  # ... appends to summary.json
}

# Status formatting
print_gate_status() {
  local gate_name="$1"
  local status="$2"
  # Outputs: ✅ PASS, ❌ FAIL, ⚠️ WARN
}

# Final aggregation
finalize_summary() {
  # Writes artifacts/gates/summary.json with totals
}
```

**Reuse strategy:**
1. Extract these functions into `scripts/gates/lib/gate_utils.sh`
2. Source in all new gate scripts
3. Maintain consistent JSON structure

---

## CI Integration Pattern

GitHub Actions workflow structure:

```yaml
name: Quality Gate Check
on:
  pull_request:
  push:
    branches: [main]

jobs:
  run-gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run quality gates
        run: |
          make gates-ci

      - name: Upload gate reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gate-reports
          path: artifacts/gates/**/*.{json,md}

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('artifacts/gates/summary.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
```

---

## Validation Checklist

Before implementing a new gate, verify:

- [ ] Gate script accepts `--mode=local|ci` flag
- [ ] JSON report matches `schemas/gate_report.schema.json`
- [ ] Markdown summary follows template structure
- [ ] Exit codes follow convention (0/1/2)
- [ ] Artifacts directory created before writing
- [ ] Symlinks to `latest.json` and `latest.md` created
- [ ] Duration measurement included
- [ ] Timestamp in ISO 8601 format
- [ ] Gate-specific metrics documented
- [ ] Integration with `make gates` command

---

## Future Enhancements (Out of Scope for v2.0)

- **SARIF format support** for Security tab integration
- **JUnit XML format** for test result visualization
- **Historical trend analysis** (gate pass rates over time)
- **Gate dependency graph** (enforce execution order)
- **Parallel gate execution** (using `parallel` or `xargs`)
- **Gate timeout enforcement** (kill long-running gates)

---

## References

- JSON Schema: `schemas/gate_report.schema.json`
- Example gate: `specs/gates/seed-data-consistency-gate.md`
- Existing parity gate: `scripts/gates/run_parity_gates.sh`
- Makefile targets: `Makefile` (gates section)

---

**Status:** Design specification complete. Implementation deferred to Phase 2.
