name: PPM & Finance Stability Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-ppm:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install psycopg2-binary

      - name: Wait for PostgreSQL
        shell: python
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
        run: |
          import time
          import psycopg2
          import sys
          import os

          host = os.environ['PGHOST']
          port = os.environ['PGPORT']
          user = os.environ['PGUSER']
          password = os.environ['PGPASSWORD']
          dbname = 'postgres'

          print(f"üîç Connecting to PostgreSQL at {host}:{port}...")

          for i in range(30):
              try:
                  conn = psycopg2.connect(
                      host=host,
                      port=port,
                      user=user,
                      password=password,
                      dbname=dbname,
                  )
                  conn.close()
                  print("‚úÖ PostgreSQL is ready!")
                  sys.exit(0)
              except psycopg2.OperationalError:
                  time.sleep(1)
              except Exception as e:
                  print(f"‚ö†Ô∏è Connection failed: {e}")
                  time.sleep(1)

          print("‚ùå PostgreSQL did not become ready in time.")
          sys.exit(1)

      # TEST 1: Finance PPM (The Clarity Engine)
      - name: Test Finance Month-End
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
        run: |
          echo "üß™ Testing Finance Control (ipai_finance_ppm)..."
          python3 ./odoo-bin -d test_finance \
            -i ipai_finance_ppm \
            --test-enable \
            --stop-after-init \
            --log-level=test \
            --db_host=localhost --db_port=5432 --db_user=odoo --db_password=odoo || {
              echo "‚ùå Finance PPM tests FAILED"
              exit 1
            }
          echo "‚úÖ Finance PPM tests PASSED"

      # TEST 2: PPM Monthly Close (The Automation Engine)
      - name: Test PPM Monthly Close
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
        run: |
          echo "üß™ Testing PPM Monthly Close (ipai_ppm_monthly_close)..."
          python3 ./odoo-bin -d test_ppm_close \
            -i ipai_ppm_monthly_close \
            --test-enable \
            --stop-after-init \
            --log-level=test \
            --db_host=localhost --db_port=5432 --db_user=odoo --db_password=odoo || {
              echo "‚ùå PPM Monthly Close tests FAILED"
              exit 1
            }
          echo "‚úÖ PPM Monthly Close tests PASSED"

      # TEST 3: Finance PPM Dashboard (The Executive View)
      - name: Test Finance Dashboard
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: odoo
          PGPASSWORD: odoo
        run: |
          echo "üß™ Testing Finance Dashboard (ipai_finance_ppm_dashboard)..."
          python3 ./odoo-bin -d test_dashboard \
            -i ipai_finance_ppm_dashboard \
            --test-enable \
            --stop-after-init \
            --log-level=test \
            --db_host=localhost --db_port=5432 --db_user=odoo --db_password=odoo || {
              echo "‚ùå Finance Dashboard tests FAILED"
              exit 1
            }
          echo "‚úÖ Finance Dashboard tests PASSED"

      - name: Report CI Telemetry
        if: always()
        run: |
          if [ -f scripts/report_ci_telemetry.sh ]; then
            sh scripts/report_ci_telemetry.sh "${{ job.status }}"
          else
            echo "‚ö†Ô∏è Telemetry script not found, skipping."
          fi
