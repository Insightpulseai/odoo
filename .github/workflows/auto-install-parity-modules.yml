name: auto-install-parity-modules

# Automatically install/upgrade enterprise parity modules on push to main.
# Uses the mega install set as SSOT for which modules to activate.

on:
  push:
    branches: [main]
    paths:
      - 'addons/ipai/**'
      - 'addons/ipai_*/**'
      - 'config/install_sets/**'
      - 'vendor/oca/**'
      - 'external-src/**'
  workflow_dispatch:
    inputs:
      install_set:
        description: 'Install set file to use'
        required: false
        default: 'config/install_sets/mega_parity_autogen.txt'
      action:
        description: 'Action: install or upgrade'
        required: false
        default: 'install'
        type: choice
        options:
          - install
          - upgrade

# Only one install at a time â€” never overlap prod deploys
concurrency:
  group: odoo-prod-parity-install
  cancel-in-progress: false

permissions:
  contents: read
  issues: write

env:
  ODOO_CONTAINER: odoo-erp-prod
  ODOO_CONF: /etc/odoo/odoo.conf

jobs:
  auto-install:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine install set and action
        id: config
        shell: bash
        run: |
          SET_FILE="${{ github.event.inputs.install_set || 'config/install_sets/mega_parity_autogen.txt' }}"
          ACTION="${{ github.event.inputs.action || 'install' }}"

          if [[ ! -f "$SET_FILE" ]]; then
            echo "ERROR: install set not found: $SET_FILE"
            exit 1
          fi

          MODULES="$(grep -vE '^\s*#' "$SET_FILE" | sed '/^\s*$/d' | paste -sd, -)"
          COUNT="$(echo "$MODULES" | tr ',' '\n' | wc -l)"

          echo "set_file=$SET_FILE" >> "$GITHUB_OUTPUT"
          echo "action=$ACTION" >> "$GITHUB_OUTPUT"
          echo "modules=$MODULES" >> "$GITHUB_OUTPUT"
          echo "count=$COUNT" >> "$GITHUB_OUTPUT"

          echo "Install set: $SET_FILE"
          echo "Action: $ACTION"
          echo "Module count: $COUNT"

      - name: Preflight validation on production
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script_stop: true
          script: |
            set -euo pipefail
            echo "=== Preflight: validate prod environment ==="

            # Find repo directory
            REPO_DIR=""
            for d in /opt/odoo-ce/repo /opt/odoo/repo /opt/odoo-ce; do
              if [[ -d "$d/.git" ]]; then REPO_DIR="$d"; break; fi
            done
            if [[ -z "$REPO_DIR" ]]; then
              echo "ERROR: repo directory not found on prod"
              exit 1
            fi
            echo "Repo: $REPO_DIR"

            cd "$REPO_DIR"
            git fetch origin main --prune
            git checkout main
            git pull origin main --ff-only

            # Confirm mega set exists on host
            test -f config/install_sets/mega_parity_autogen.txt || {
              echo "ERROR: mega_parity_autogen.txt not found on prod"
              exit 1
            }

            # Confirm container is running
            docker inspect --format='{{.State.Running}}' ${{ env.ODOO_CONTAINER }} | grep -q true || {
              echo "ERROR: container ${{ env.ODOO_CONTAINER }} not running"
              exit 1
            }

            # Confirm addons mounts exist inside container
            docker exec ${{ env.ODOO_CONTAINER }} bash -lc '
              set -e
              test -d /mnt/extra-addons/ipai && echo "OK: /mnt/extra-addons/ipai exists"
              ls /mnt/extra-addons/oca/ >/dev/null 2>&1 && echo "OK: /mnt/extra-addons/oca/ exists" || echo "WARN: /mnt/extra-addons/oca/ not found"
            '

            # Dry-run: confirm odoo-bin starts with base
            DB="${{ secrets.ODOO_PROD_DB }}"
            DB="${DB:-odoo_core}"
            echo ">>> Preflight dry-run: odoo-bin -u base on DB=$DB"
            docker exec ${{ env.ODOO_CONTAINER }} \
              odoo -c ${{ env.ODOO_CONF }} -d "$DB" \
              --stop-after-init -u base --log-level=warn 2>&1 | tail -20

            echo "=== Preflight passed ==="

      - name: Install and upgrade modules on production
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          command_timeout: 30m
          script_stop: true
          script: |
            set -euo pipefail
            echo "=== Auto-install parity modules ==="
            echo "Action: ${{ steps.config.outputs.action }}"
            echo "Modules: ${{ steps.config.outputs.count }}"

            MODULES="${{ steps.config.outputs.modules }}"
            DB="${{ secrets.ODOO_PROD_DB }}"
            DB="${DB:-odoo_core}"

            # Step 1: Install missing modules (-i tolerates already-installed)
            echo ">>> Step 1: Installing modules (idempotent)..."
            docker exec ${{ env.ODOO_CONTAINER }} \
              odoo -c ${{ env.ODOO_CONF }} -d "$DB" \
              -i "$MODULES" --stop-after-init \
              --log-level=warn 2>&1 | tail -50 || {
                echo "WARN: -i had errors (may be expected if some modules already installed)"
              }

            # Step 2: Upgrade all modules in set (ensures latest code is active)
            echo ">>> Step 2: Upgrading modules..."
            docker exec ${{ env.ODOO_CONTAINER }} \
              odoo -c ${{ env.ODOO_CONF }} -d "$DB" \
              -u "$MODULES" --stop-after-init \
              --log-level=warn 2>&1 | tail -50

            # Step 3: Restart container for clean state
            echo ">>> Step 3: Restarting container..."
            docker restart ${{ env.ODOO_CONTAINER }}
            sleep 15

            # Step 4: Health check with retries
            echo ">>> Step 4: Health check..."
            for i in 1 2 3 4 5; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8069/web/health || echo "000")
              if [[ "$HTTP_CODE" == "200" ]]; then
                echo "OK: health check passed (attempt $i)"
                exit 0
              fi
              echo "Attempt $i: HTTP $HTTP_CODE, retrying in 10s..."
              sleep 10
            done

            echo "ERROR: health check failed after 5 attempts"
            docker logs --tail=100 ${{ env.ODOO_CONTAINER }}
            exit 1

      - name: Verify module states in database
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.PROD_HOST }}
          username: ${{ secrets.PROD_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            set -euo pipefail
            DB="${{ secrets.ODOO_PROD_DB }}"
            DB="${DB:-odoo_core}"

            echo "=== Installed IPAI modules ==="
            docker exec ${{ env.ODOO_CONTAINER }} \
              psql -U odoo -d "$DB" -t -c \
              "SELECT name, state FROM ir_module_module WHERE name LIKE 'ipai_%' AND state = 'installed' ORDER BY name;" \
              2>/dev/null || echo "(psql not available in container, skipping DB verification)"

            echo ""
            echo "=== Module state summary ==="
            docker exec ${{ env.ODOO_CONTAINER }} \
              psql -U odoo -d "$DB" -t -c \
              "SELECT state, COUNT(*) FROM ir_module_module WHERE name LIKE 'ipai_%' GROUP BY state ORDER BY state;" \
              2>/dev/null || true

            echo ""
            echo "=== HTTP health ==="
            curl -s -o /dev/null -w "HTTP %{http_code}\n" http://localhost:8069/web/health
            curl -s -o /dev/null -w "HTTP %{http_code}\n" http://localhost:8069/web/login

      - name: Create failure issue
        if: failure()
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          gh issue create \
            --title "Prod parity auto-install failed: $(date +%Y-%m-%d) @ ${GITHUB_SHA:0:8}" \
            --body "$(cat <<BODY
          **Workflow run**: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID
          **Commit**: $GITHUB_SHA
          **Install set**: ${{ steps.config.outputs.set_file }}
          **Module count**: ${{ steps.config.outputs.count }}

          Check logs and rerun after fix.
          BODY
          )" \
            --label "bug" --label "deploy"
