name: Phase 3 - OCA Allowlist Gate

# This workflow enforces Phase 3: OCA Module Allowlist validation
# Ensures all modules in allowlist exist in fetched OCA repos

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'config/oca/**'
      - 'scripts/oca/**'
      - 'vendor/oca.lock.ce19.json'
  push:
    branches: [main]
    paths:
      - 'config/oca/**'
      - 'scripts/oca/**'
      - 'vendor/oca.lock.ce19.json'

concurrency:
  group: phase3-oca-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ==========================================================================
  # Gate: OCA Allowlist Validation
  # ==========================================================================
  validate-allowlist:
    name: Validate OCA Allowlist
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml
          sudo apt-get update && sudo apt-get install -y jq

      - name: Make scripts executable
        run: chmod +x scripts/oca/*.sh

      - name: Fetch OCA repositories
        run: ./scripts/oca/fetch_and_pin.sh
        env:
          # Skip if repos already exist (CI caching)
          FORCE_RECLONE: ""

      - name: Generate addon inventory
        run: ./scripts/oca/generate_inventory.sh

      - name: Validate allowlist against inventory
        run: ./scripts/oca/clean_install_allowlist.sh --dry-run

      - name: Upload inventory artifacts
        uses: actions/upload-artifact@v4
        with:
          name: oca-inventory
          path: |
            docs/oca/ADDON_INVENTORY.json
            docs/oca/ADDON_NAMES.txt
            docs/oca/REPO_SUMMARY.md
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## Phase 3: OCA Allowlist Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ All modules in allowlist found in inventory" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Inventory Stats" >> $GITHUB_STEP_SUMMARY
            if [ -f docs/oca/ADDON_INVENTORY.json ]; then
              count=$(jq '.count' docs/oca/ADDON_INVENTORY.json 2>/dev/null || echo "N/A")
              echo "- **Total addons discovered**: $count" >> $GITHUB_STEP_SUMMARY
            fi
            if [ -f config/oca/module_allowlist.yml ]; then
              modules=$(grep -E "^\s+- [a-z_]+" config/oca/module_allowlist.yml | wc -l | tr -d ' ')
              echo "- **Modules in allowlist**: $modules" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ Allowlist validation failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check that all modules in \`config/oca/module_allowlist.yml\` exist in the OCA repos." >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # Check: No TODO placeholders
  # ==========================================================================
  no-todos:
    name: No TODO Placeholders
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for TODO_ placeholders in allowlist
        run: |
          if grep -E "TODO_" config/oca/module_allowlist.yml 2>/dev/null; then
            echo "❌ Found TODO_ placeholders in allowlist"
            exit 1
          fi
          echo "✅ No TODO placeholders found"

      - name: Summary
        if: always()
        run: |
          echo "## TODO Placeholder Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ No TODO placeholders in allowlist" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Found TODO placeholders - replace with real module names from inventory" >> $GITHUB_STEP_SUMMARY
          fi

  # ==========================================================================
  # Final Gate: Phase 3 Complete
  # ==========================================================================
  phase3-complete:
    name: Phase 3 Complete
    runs-on: ubuntu-latest
    needs: [validate-allowlist, no-todos]
    if: always()

    steps:
      - name: Check all gates
        run: |
          if [ "${{ needs.validate-allowlist.result }}" != "success" ]; then
            echo "❌ Allowlist validation failed"
            exit 1
          fi
          if [ "${{ needs.no-todos.result }}" != "success" ]; then
            echo "❌ TODO placeholder check failed"
            exit 1
          fi
          echo "✅ Phase 3 OCA Allowlist Gate passed!"

      - name: Summary
        if: always()
        run: |
          echo "## Phase 3 Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Allowlist Validation | ${{ needs.validate-allowlist.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| No TODO Placeholders | ${{ needs.no-todos.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.validate-allowlist.result }}" == "success" ] && [ "${{ needs.no-todos.result }}" == "success" ]; then
            echo "**✅ Phase 3 PASSED - OCA modules are deterministically pinned and validated**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**❌ Phase 3 FAILED - Fix the issues above before merging**" >> $GITHUB_STEP_SUMMARY
          fi
