# =============================================================================
# Auto ERD Generation with SchemaSpy
# =============================================================================
# Generates comprehensive ERD documentation from PostgreSQL database
# Outputs: HTML site + PNG/SVG diagrams
#
# Prerequisites:
# - Secrets: DB_HOST, DB_PORT, DB_NAME, DB_USER, DB_PASSWORD
# - Optional: DB_SCHEMAS (default: public)
# =============================================================================

name: Generate ERD (SchemaSpy)

on:
  push:
    branches: [main]
    paths:
      - 'db/migrations/**'
      - 'db/schema/**'
      - 'addons/ipai/**/models/**'
      - '.github/workflows/erd-schemaspy.yml'
  pull_request:
    paths:
      - 'db/migrations/**'
      - 'db/schema/**'
      - 'addons/ipai/**/models/**'
      - '.github/workflows/erd-schemaspy.yml'
  workflow_dispatch:
    inputs:
      schemas:
        description: 'Comma-separated list of schemas to include'
        required: false
        default: 'public'

permissions:
  contents: write

env:
  DB_HOST: ${{ secrets.DB_HOST }}
  DB_PORT: ${{ secrets.DB_PORT || '5432' }}
  DB_NAME: ${{ secrets.DB_NAME }}
  DB_USER: ${{ secrets.DB_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  DB_SCHEMAS: ${{ github.event.inputs.schemas || secrets.DB_SCHEMAS || 'public' }}

jobs:
  generate-erd:
    name: Generate ERD with SchemaSpy
    runs-on: ubuntu-latest
    # Only run if DB credentials are configured
    if: ${{ secrets.DB_HOST != '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Create output directory
        run: mkdir -p erd_out

      - name: Generate ERD with SchemaSpy
        run: |
          docker run --rm \
            -v "$PWD/erd_out:/output" \
            schemaspy/schemaspy:6.2.4 \
            -t pgsql \
            -host "$DB_HOST" \
            -port "$DB_PORT" \
            -db "$DB_NAME" \
            -u "$DB_USER" \
            -p "$DB_PASSWORD" \
            -s "$DB_SCHEMAS" \
            -o /output \
            -vizjs \
            -degree 2
        continue-on-error: true

      - name: Copy key diagrams to docs
        run: |
          mkdir -p docs/data-model/schemaspy
          # Copy summary diagrams if generated
          cp erd_out/diagrams/summary/*.png docs/data-model/schemaspy/ 2>/dev/null || true
          cp erd_out/diagrams/summary/*.svg docs/data-model/schemaspy/ 2>/dev/null || true
          # Copy relationships diagram
          cp erd_out/diagrams/orphans/*.png docs/data-model/schemaspy/ 2>/dev/null || true
          cp erd_out/diagrams/relationships.real.large.png docs/data-model/schemaspy/erd-full.png 2>/dev/null || true
          # Create timestamp file
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > docs/data-model/schemaspy/GENERATED.txt
          echo "Schemas: $DB_SCHEMAS" >> docs/data-model/schemaspy/GENERATED.txt

      - name: Upload ERD artifacts
        uses: actions/upload-artifact@v4
        with:
          name: erd-schemaspy
          path: erd_out/
          retention-days: 30

      - name: Upload diagram artifacts
        uses: actions/upload-artifact@v4
        with:
          name: erd-diagrams
          path: docs/data-model/schemaspy/
          retention-days: 90

  # Publish to gh-pages on main branch
  publish-docs:
    name: Publish ERD to gh-pages
    if: github.ref == 'refs/heads/main' && needs.generate-erd.result == 'success'
    needs: [generate-erd]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download ERD artifacts
        uses: actions/download-artifact@v4
        with:
          name: erd-schemaspy
          path: erd_site

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: erd_site
          publish_branch: gh-pages
          destination_dir: erd

  # Fallback: Generate ERD from codebase if no DB connection
  generate-from-code:
    name: Generate ERD from Codebase
    runs-on: ubuntu-latest
    if: ${{ secrets.DB_HOST == '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate DBML and diagrams
        run: python scripts/generate_odoo_dbml.py

      - name: Check for drift
        run: |
          if [ -n "$(git status --porcelain docs/data-model/)" ]; then
            echo "::warning::Data model artifacts out of sync"
            git status --porcelain docs/data-model/
            exit 1
          fi
          echo "Data model artifacts up-to-date"
