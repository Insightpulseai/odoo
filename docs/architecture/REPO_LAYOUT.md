# Repo Layout — Canonical Structure and Boundary Rules

**Status**: Active
**CI Guard**: `scripts/ci/check_repo_structure.py`
**SSOT**: This document is the single source of truth for repo layout decisions.
**Last updated**: 2026-03-01

---

## Overview

`Insightpulseai/odoo` is a monorepo that hosts four distinct technology stacks under one root:

1. **Odoo addons** — Python-based Odoo CE 19.0 modules
2. **Supabase control plane** — Edge Functions, migrations, and seed data
3. **Web applications** — TypeScript/Next.js apps deployed to Vercel
4. **Shared libraries** — TypeScript packages consumed by apps

These stacks have different runtimes, toolchains, and deployment targets. The boundary rules below enforce strict separation to prevent accidental cross-contamination.

---

## Canonical Directory Tree

```
Insightpulseai/odoo/              ← repo root
│
├── addons/                       ← Odoo addons ONLY (see §1)
│   ├── odoo/                     #   CE built-in module references (read-only pointers)
│   ├── oca/                      #   OCA community submodules (pinned, read-only)
│   ├── ipai/                     #   Custom IPAI modules (ipai_<domain>_<feature>)
│   ├── local/                    #   Scratch/experimental (not deployed to production)
│   └── _deprecated/              #   Modules pending removal (do not import)
│
├── supabase/                     ← Supabase control plane ONLY (see §2)
│   ├── functions/                #   Edge Functions (TypeScript, Deno runtime)
│   ├── migrations/               #   Append-only SQL migrations (timestamp prefix)
│   └── seed/                     #   Seed data SQL
│
├── apps/                         ← Vercel deployables ONLY (see §3)
│   ├── odooops-console/          #   Ops Console — Next.js
│   ├── workspace/                #   SoW UI — Next.js
│   └── slack-agent/              #   Slack Bolt — Nitro
│
├── packages/                     ← Shared TS/JS libraries ONLY (see §4)
│   ├── taskbus/                  #   Idempotent orchestration helpers
│   ├── shared-ui/                #   Design system (planned)
│   └── sdk/                      #   Internal client SDKs (planned)
│
├── ssot/                         ← SSOT registry ONLY (see §5)
│   ├── integrations/             #   Per-integration YAML files + _index.yaml
│   ├── infra/                    #   Infrastructure YAML (DO, Cloudflare)
│   ├── platform/                 #   Platform surface map
│   ├── vercel/                   #   Vercel project registry
│   ├── observability/            #   Telemetry posture
│   ├── advisor/                  #   Ops Advisor rulepacks + workbooks
│   └── secrets/                  #   Secret name registry (values NEVER here)
│
├── design/
│   └── tokens/                   ← Figma canonical design tokens (see §6)
│       ├── tokens.json           #   Generated by scripts/design/export_tokens.sh
│       └── primitives.json       #   Primitive token layer
│
├── scripts/                      ← Automation scripts
│   ├── ci/                       #   CI validators (Python)
│   └── ...
│
├── docs/
│   └── architecture/             ← Architecture decision docs
│
├── .github/
│   └── workflows/                ← GitHub Actions workflows
│
├── odoo19/                       ← Canonical Odoo server root (single allowed)
│   └── ...                       #   Odoo configuration + data dirs
│
├── turbo.json                    ← Turborepo pipeline (Vercel monorepo)
├── pnpm-workspace.yaml           ← pnpm workspace config
└── package.json                  ← Root package.json (workspaces root)
```

---

## §1 — addons/ Boundary Rules

**What belongs here**: Odoo addon modules only. Every subdirectory of `addons/ipai/` and `addons/local/` MUST be a valid Odoo module — i.e., it must contain a `__manifest__.py` file at its root.

**What does NOT belong here**:
- TypeScript / JavaScript source files
- Supabase migrations or Edge Functions
- Infrastructure config (Terraform, YAML)
- Non-module Python scripts

**OCA submodules** (`addons/oca/`) are managed via `.gitmodules`. Never copy OCA source into `addons/ipai/` — use `_inherit` overrides in a new `ipai_*` module.

**Enterprise parity heuristic**: `ipai_*` modules MUST NOT declare a dependency on Odoo Enterprise modules in their `__manifest__.py`. The allowed dependency list is: Odoo CE modules + OCA modules + other `ipai_*` modules. Known Enterprise module prefixes that trigger a CI failure: `account_accountant`, `sale_management` (enterprise), `purchase_management` (enterprise), `stock_enterprise`, `helpdesk`, `timesheet_grid`, `web_studio`.

**Duplicate Odoo roots**: Only ONE Odoo server root is permitted at the repo root level. The canonical name is `odoo19/`. The names `odoo/`, `odoo-ce/`, `odooenv/` at the repo root (not inside another directory) are forbidden.

---

## §2 — supabase/ Boundary Rules

**What belongs here**: Supabase control plane artifacts only — Edge Functions (Deno TypeScript), SQL migrations, and seed SQL.

**What does NOT belong here**: Odoo addon code, Next.js application code, or infrastructure config unrelated to Supabase.

**Migrations are append-only**: Never drop or truncate `ops.*` or `work.*` tables in a migration. Add columns with `ADD COLUMN IF NOT EXISTS`.

**No supabase/ under addons/**: The `supabase/` directory must not appear anywhere inside `addons/`. Any `supabase/` directory found under `addons/` is a misplace and triggers a CI failure.

---

## §3 — apps/ Boundary Rules

**What belongs here**: One directory per Vercel-deployable application. Each app directory must contain a `package.json`.

**SSOT requirement**: Every directory under `apps/` MUST have a corresponding entry in `ssot/vercel/projects.yaml`. Apps present in the filesystem but absent from the SSOT are not deployed.

**No direct DO App Platform deployments**: Apps under `apps/` deploy exclusively to Vercel. DigitalOcean App Platform is not used for apps in this directory (see `ssot/infra/digitalocean/policy.yaml`).

---

## §4 — packages/ Boundary Rules

**What belongs here**: Shared TypeScript/JavaScript libraries consumed by `apps/*` at build time. Each package must have a `package.json`.

**Never deployed directly**: `packages/*` are not standalone Vercel projects. They are build-time dependencies only.

**Cross-stack isolation**: Packages MUST NOT import from `addons/` Python code or `supabase/` Edge Functions directly. Cross-stack communication goes through the Supabase REST API or Edge Function HTTP endpoints.

---

## §5 — ssot/ Boundary Rules

**What belongs here**: YAML configuration files representing the canonical desired state of the platform. No executable code.

**File types allowed**: `.yaml` only (no `.py`, `.ts`, `.sql`, `.json`, `.sh`).

**Schema requirement**: Every YAML file in `ssot/` must declare a `schema:` field at the top (e.g., `schema: ssot.integrations.v1`).

**Values never here**: The `ssot/secrets/` subdirectory tracks secret _names_ and _metadata_ only. Secret values are stored in Supabase Vault, Vercel dashboard, or OS keychain.

---

## §6 — design/tokens/ Boundary Rules

**What belongs here**: Figma-exported design tokens in JSON format.

**Generated, never hand-edited**: `tokens.json` and `primitives.json` are generated by `scripts/design/export_tokens.sh` (Figma Variables API). Manual edits will be overwritten on the next Figma sync.

**Workflow**: Figma → `scripts/design/export_tokens.sh` → `design/tokens/*.json` → consumed by `packages/shared-ui` → consumed by `apps/*`.

---

## CI Enforcement

The CI guard `scripts/ci/check_repo_structure.py` enforces the following invariants on every pull request:

| Check | What it validates |
|-------|-------------------|
| 1 | Every directory under `addons/ipai/` and `addons/local/` contains `__manifest__.py` |
| 2 | No `supabase/` directory exists anywhere under `addons/` |
| 3 | No `ipai_*` module declares a dependency on known Enterprise module prefixes |
| 4 | Only one Odoo server root exists at the repo root (canonical: `odoo19/`) |
| 5 | Every directory under `apps/` has a `package.json` |
| 6 | No `.py`, `.ts`, `.sql` files exist directly in `ssot/` subdirectories (YAML-only) |

Run locally:

```bash
pip install pyyaml
python scripts/ci/check_repo_structure.py --repo-root .
```

---

## What Belongs Where — Quick Reference

| I need to add... | Directory | Notes |
|------------------|-----------|-------|
| New Odoo module | `addons/ipai/ipai_<domain>_<feature>/` | Must have `__manifest__.py` |
| OCA module dependency | `addons/oca/` | Via `.gitmodules` submodule only |
| Supabase migration | `supabase/migrations/` | Timestamp prefix required |
| Supabase Edge Function | `supabase/functions/<name>/` | Deno TypeScript |
| New web app (Vercel) | `apps/<name>/` | Register in `ssot/vercel/projects.yaml` |
| Shared TS library | `packages/<name>/` | Must have `package.json` |
| Integration config | `ssot/integrations/<name>.yaml` | Register in `ssot/integrations/_index.yaml` |
| Design tokens | `design/tokens/` | Run export script, do not edit manually |
| Architecture doc | `docs/architecture/` | Markdown only |
| CI validator | `scripts/ci/` | Python preferred |

---

*This document is generated and maintained by the ipai platform team.*
*Changes require updating the CI guard `scripts/ci/check_repo_structure.py` in the same PR.*
