{
  "name": "IPAI Finance Task Event Handler",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "finance-handler",
        "options": {}
      },
      "id": "webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "finance-handler"
    },
    {
      "parameters": {
        "jsCode": "const event = $input.item.json;\nconst payload = event.payload || {};\n\nlet message = '';\nlet icon = '';\n\nswitch (event.event_type) {\n  case 'finance_task.created':\n    icon = 'üìã';\n    message = `**${icon} Finance Task Created**\\n\\n**Task:** ${payload.task_name || 'Unknown'}\\n**BIR Form:** ${payload.bir_form || 'N/A'}\\n**Period:** ${payload.period_covered || 'N/A'}\\n**Employee:** ${payload.employee_code || 'N/A'}\\n**Prep Deadline:** ${payload.prep_deadline || 'N/A'}\\n\\n[View in Odoo](${$env.ODOO_BASE_URL}/web#id=${payload.task_id}&model=project.task)`;\n    break;\n    \n  case 'finance_task.in_progress':\n    icon = 'üîÑ';\n    message = `**${icon} Finance Task In Progress**\\n\\n**Task:** ${payload.task_name || 'Unknown'}\\n**BIR Form:** ${payload.bir_form || 'N/A'}\\n**Assigned to:** ${payload.assigned_to || 'Unknown'}\\n\\n[View in Odoo](${$env.ODOO_BASE_URL}/web#id=${payload.task_id}&model=project.task)`;\n    break;\n    \n  case 'finance_task.submitted':\n    icon = '‚úÖ';\n    message = `**${icon} Finance Task Submitted**\\n\\n**Task:** ${payload.task_name || 'Unknown'}\\n**BIR Form:** ${payload.bir_form || 'N/A'}\\n**Status:** ${payload.status || 'Submitted'}\\n\\n[View in Odoo](${$env.ODOO_BASE_URL}/web#id=${payload.task_id}&model=project.task)`;\n    break;\n    \n  case 'finance_task.approved':\n    icon = '‚úÖ';\n    message = `**${icon} Finance Task Approved**\\n\\n**Task:** ${payload.task_name || 'Unknown'}\\n**BIR Form:** ${payload.bir_form || 'N/A'}\\n**Status:** ${payload.status || 'Approved'}\\n\\n[View in Odoo](${$env.ODOO_BASE_URL}/web#id=${payload.task_id}&model=project.task)`;\n    break;\n    \n  case 'finance_task.filed':\n    icon = 'üìÑ';\n    message = `**${icon} Finance Task Filed**\\n\\n**Task:** ${payload.task_name || 'Unknown'}\\n**BIR Form:** ${payload.bir_form || 'N/A'}\\n**Filing Deadline:** ${payload.filing_deadline || 'N/A'}\\n\\n‚úÖ Task completed and filed with BIR.\\n\\n[View in Odoo](${$env.ODOO_BASE_URL}/web#id=${payload.task_id}&model=project.task)`;\n    break;\n    \n  case 'finance_task.overdue':\n    icon = 'üö®';\n    message = `**${icon} Finance Task OVERDUE**\\n\\n**Task:** ${payload.task_name || 'Unknown'}\\n**BIR Form:** ${payload.bir_form || 'N/A'}\\n**Days overdue:** ${payload.days_overdue || 0}\\n**Filing Deadline:** ${payload.filing_deadline || 'N/A'}\\n**Assigned to:** ${payload.assigned_to || 'Unknown'}\\n\\n**URGENT:** This task is past its deadline!\\n\\n[View in Odoo](${$env.ODOO_BASE_URL}/web#id=${payload.task_id}&model=project.task)`;\n    break;\n    \n  default:\n    icon = '‚ÑπÔ∏è';\n    message = `**${icon} Finance Task Event: ${event.event_type}**\\n\\nUnhandled event type. Raw payload:\\n\`\`\`json\\n${JSON.stringify(payload, null, 2)}\\n\`\`\``;\n}\n\nreturn { json: { message, event_id: event.id } };"
      },
      "id": "format_message",
      "name": "Format Mattermost Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.MATTERMOST_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"text\": $json.message } }}",
        "options": {}
      },
      "id": "send_mattermost",
      "name": "Send to Mattermost",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { \"ok\": true, \"event_id\": $json.event_id } }}"
      },
      "id": "respond",
      "name": "Respond",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [850, 300]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Format Mattermost Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Mattermost Message": {
      "main": [
        [
          {
            "node": "Send to Mattermost",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send to Mattermost": {
      "main": [
        [
          {
            "node": "Respond",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": ["integration", "finance"],
  "triggerCount": 1,
  "updatedAt": "2026-01-22T00:00:00.000Z",
  "versionId": "1"
}
