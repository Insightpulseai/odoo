name: DNS SSOT Apply (manual)

# MANUAL DISPATCH ONLY — never auto-triggered.
# Applies infra/dns/*.yaml records to Cloudflare via the API.
# Requires: CLOUDFLARE_API_TOKEN and CLOUDFLARE_ZONE_ID secrets.

on:
  workflow_dispatch:
    inputs:
      yaml_file:
        description: "DNS SSOT YAML file to apply"
        required: true
        default: "infra/dns/zoho_mail_dns.yaml"
        type: choice
        options:
          - infra/dns/zoho_mail_dns.yaml
      dry_run:
        description: "Dry run (preview only, no changes)"
        required: false
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

permissions:
  contents: read

jobs:
  apply-dns:
    name: Apply DNS SSOT to Cloudflare
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Guard — CF credentials present
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          if [ -z "${CLOUDFLARE_API_TOKEN}" ]; then
            echo "::error::Secret CLOUDFLARE_API_TOKEN is empty or not set."
            echo "::error::Go to repo Settings → Secrets and variables → Actions and add CLOUDFLARE_API_TOKEN."
            exit 1
          fi
          if [ -z "${CLOUDFLARE_ZONE_ID}" ]; then
            echo "::error::Secret CLOUDFLARE_ZONE_ID is empty or not set."
            exit 1
          fi
          echo "✅ CF credentials present (token=${CLOUDFLARE_API_TOKEN:0:4}…, zone=${CLOUDFLARE_ZONE_ID:0:8}…)"

      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate YAML before apply
        run: |
          python3 -c "
          import yaml, sys
          with open('${{ github.event.inputs.yaml_file }}') as f:
              d = yaml.safe_load(f)
          count = len(d.get('records', []))
          print(f'YAML valid: {count} records in ${{ github.event.inputs.yaml_file }}')
          "

      - name: Apply (or dry-run) DNS records
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          ARGS=""
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            ARGS="--dry-run"
          fi
          python3 infra/cloudflare/scripts/apply_dns_from_yaml.py \
            --file "${{ github.event.inputs.yaml_file }}" \
            $ARGS

      - name: Verify records after apply
        if: github.event.inputs.dry_run == 'false'
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ZONE_ID: ${{ secrets.CLOUDFLARE_ZONE_ID }}
        run: |
          python3 infra/cloudflare/scripts/apply_dns_from_yaml.py \
            --file "${{ github.event.inputs.yaml_file }}" \
            --verify
