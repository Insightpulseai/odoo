id: receipt_basic_v1
doc_type: receipt
description: >
  Agentic pipeline for consumer/merchant receipts. Focus on merchant, date, totals,
  tax, and line items. Handles noisy OCR and partial information.

steps:
  # 1) Classification check
  - id: classify_document
    type: llm
    prompt_ref: classify_document
    inputs:
      - ocr_text
    outputs:
      - doc_type_pred
      - doc_type_confidence
    stop_if:
      condition: "doc_type_pred != 'receipt'"
      action: "fail"

  # 2) Core extraction
  - id: extract_core_fields
    type: llm
    prompt_ref: receipt_extraction
    inputs:
      - ocr_text
    outputs:
      - merchant_name
      - merchant_address
      - receipt_number
      - transaction_date
      - transaction_time
      - total_amount
      - subtotal_amount
      - tax_amount
      - currency
      - payment_method
      - card_last4
      - line_items
      - overall_confidence

  # 3) Normalization
  - id: normalize_fields
    type: parser
    operations:
      - field: transaction_date
        parser: normalize_date
      - field: total_amount
        parser: parse_amount
      - field: subtotal_amount
        parser: parse_amount
      - field: tax_amount
        parser: parse_amount
      - field: currency
        parser: detect_currency

  # 4) Validation
  - id: validate_business_rules
    type: validation
    rule_set: receipt_default
    outputs:
      - validation_status
      - validation_errors

  # 5) Correction round if needed
  - id: correction_round
    type: llm
    when: "validation_status == 'fail' or overall_confidence < 0.9"
    prompt_ref: receipt_correction
    inputs:
      - ocr_text
      - current_fields
      - validation_errors
    outputs:
      - merchant_name
      - merchant_address
      - receipt_number
      - transaction_date
      - transaction_time
      - total_amount
      - subtotal_amount
      - tax_amount
      - currency
      - payment_method
      - card_last4
      - line_items
      - overall_confidence

  # 6) Final validation
  - id: final_validation
    type: validation
    rule_set: receipt_default
    outputs:
      - final_status
      - final_errors

target:
  min_confidence: 0.9
  require_final_status: "pass"
  on_fail: "send_to_review"
