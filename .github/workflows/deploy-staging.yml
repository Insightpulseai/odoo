# =============================================================================
# GitHub Actions: Deploy Staging
# =============================================================================
# Orchestrates staging deployment across Supabase + Vercel + Odoo.
# Uses GitHub Environments for approval gating.
#
# Required Secrets (set in GitHub Environment: staging):
#   - SUPABASE_ACCESS_TOKEN, SUPABASE_DB_PASSWORD, SUPABASE_PROJECT_ID_STAGING
#   - VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID_STAGING
#   - DO_SSH_KEY, DO_HOST_STAGING, DO_USERNAME
#   - N8N_WEBHOOK_URL (optional, for notifications)
# =============================================================================

name: Deploy Staging

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to deploy'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - supabase
          - vercel
          - odoo

concurrency:
  group: deploy-staging
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  # ===========================================================================
  # Deploy Supabase Staging
  # ===========================================================================
  deploy-supabase:
    name: Deploy Supabase (staging)
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.component == 'all' ||
      github.event.inputs.component == 'supabase' ||
      github.event_name == 'push'
    environment:
      name: staging

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link staging project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID_STAGING }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Push migrations
        run: |
          echo "## Supabase Staging Migrations" >> $GITHUB_STEP_SUMMARY
          supabase db push 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Deploy Edge Functions
        run: |
          if [ -d "supabase/functions" ] && [ "$(ls -A supabase/functions 2>/dev/null)" ]; then
            echo "## Edge Functions (staging)" >> $GITHUB_STEP_SUMMARY
            supabase functions deploy 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # ===========================================================================
  # Deploy Vercel Staging
  # ===========================================================================
  deploy-vercel:
    name: Deploy Vercel (staging)
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.component == 'all' ||
      github.event.inputs.component == 'vercel' ||
      github.event_name == 'push'
    environment:
      name: staging

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy to Vercel (staging)
        run: |
          echo "## Vercel Staging Deploy" >> $GITHUB_STEP_SUMMARY

          VERCEL_TOKEN="${{ secrets.VERCEL_TOKEN }}"
          if [ -z "$VERCEL_TOKEN" ]; then
            echo "::warning::VERCEL_TOKEN not configured. Skipping."
            echo "Skipped: VERCEL_TOKEN not set." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          vercel deploy --token "$VERCEL_TOKEN" 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID_STAGING }}

  # ===========================================================================
  # Deploy Odoo Staging
  # ===========================================================================
  deploy-odoo:
    name: Deploy Odoo (staging)
    runs-on: ubuntu-latest
    if: >
      github.event.inputs.component == 'all' ||
      github.event.inputs.component == 'odoo' ||
      github.event_name == 'push'
    environment:
      name: staging

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy to staging server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.DO_SSH_KEY }}
          SSH_HOST: ${{ secrets.DO_HOST_STAGING }}
          SSH_USER: ${{ secrets.DO_USERNAME }}
        run: |
          if [ -z "$SSH_HOST" ] || [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "::warning::SSH secrets not configured. Skipping Odoo staging deploy."
            echo "## Odoo Staging Deploy Skipped" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          echo "## Odoo Staging Deploy" >> $GITHUB_STEP_SUMMARY

          ssh -i ~/.ssh/deploy_key "$SSH_USER@$SSH_HOST" << 'DEPLOY_SCRIPT'
            set -e
            cd /opt/odoo || exit 1

            git fetch origin
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            docker compose pull
            docker compose up -d --force-recreate

            sleep 30
            curl -sf http://localhost:8069/web/health || echo "Health check pending..."
          DEPLOY_SCRIPT

          echo "Odoo staging deployed at $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Notify
  # ===========================================================================
  notify:
    name: Notify Staging Deploy
    runs-on: ubuntu-latest
    needs: [deploy-supabase, deploy-vercel, deploy-odoo]
    if: always()

    steps:
      - name: Notify via webhook
        run: |
          WEBHOOK_URL="${{ secrets.N8N_WEBHOOK_URL }}"
          if [ -z "$WEBHOOK_URL" ]; then
            echo "N8N_WEBHOOK_URL not configured, skipping"
            exit 0
          fi

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "event": "staging_deploy",
              "components": {
                "supabase": "${{ needs.deploy-supabase.result }}",
                "vercel": "${{ needs.deploy-vercel.result }}",
                "odoo": "${{ needs.deploy-odoo.result }}"
              },
              "commit": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "actor": "${{ github.actor }}",
              "run_url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }' || echo "Webhook failed (non-critical)"
