<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extend hr.expense form view -->
    <record id="hr_expense_view_form_ocr" model="ir.ui.view">
        <field name="name">hr.expense.form.ocr</field>
        <field name="model">hr.expense</field>
        <field name="inherit_id" ref="hr_expense.hr_expense_view_form"/>
        <field name="arch" type="xml">
            <!-- Add OCR button in header -->
            <xpath expr="//header" position="inside">
                <button name="action_scan_receipt" type="object"
                        string="Scan Receipt"
                        class="btn-secondary"
                        icon="fa-magic"
                        invisible="ocr_state in ('processing', 'extracted', 'applied')"/>
                <button name="action_apply_ocr_fields" type="object"
                        string="Apply OCR Fields"
                        class="btn-primary"
                        invisible="ocr_state != 'extracted'"/>
            </xpath>

            <!-- Add OCR status badge -->
            <xpath expr="//field[@name='state']" position="after">
                <field name="ocr_state" widget="badge"
                       decoration-info="ocr_state == 'processing'"
                       decoration-warning="ocr_state == 'needs_review'"
                       decoration-success="ocr_state in ('extracted', 'applied')"
                       decoration-danger="ocr_state == 'failed'"
                       invisible="not ocr_state"/>
            </xpath>

            <!-- Add duplicate warning -->
            <xpath expr="//sheet" position="before">
                <div class="alert alert-warning" role="alert" invisible="not is_duplicate_receipt">
                    <i class="fa fa-exclamation-triangle"/> 
                    <strong>Potential Duplicate Receipt:</strong>
                    This receipt may have already been submitted. Please verify before proceeding.
                </div>
            </xpath>

            <!-- Add OCR fields in a new notebook page -->
            <xpath expr="//notebook" position="inside">
                <page string="OCR Data" name="ocr_data" invisible="not ocr_result_id">
                    <group>
                        <group>
                            <field name="ocr_result_id" readonly="1"/>
                            <field name="ocr_confidence" widget="progressbar"/>
                            <field name="receipt_hash" readonly="1" groups="base.group_no_one"/>
                        </group>
                        <group>
                            <field name="is_duplicate_receipt" readonly="1"/>
                            <field name="duplicate_expense_ids" readonly="1" invisible="not is_duplicate_receipt"/>
                        </group>
                    </group>
                    <group string="Extracted Text" invisible="not ocr_extracted_text">
                        <field name="ocr_extracted_text" readonly="1" nolabel="1"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Add OCR columns to tree view -->
    <record id="hr_expense_view_tree_ocr" model="ir.ui.view">
        <field name="name">hr.expense.tree.ocr</field>
        <field name="model">hr.expense</field>
        <field name="inherit_id" ref="hr_expense.view_expenses_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="after">
                <field name="ocr_state" widget="badge" optional="hide"
                       decoration-info="ocr_state == 'processing'"
                       decoration-success="ocr_state in ('extracted', 'applied')"/>
                <field name="is_duplicate_receipt" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Add OCR filter to search view -->
    <record id="hr_expense_view_search_ocr" model="ir.ui.view">
        <field name="name">hr.expense.search.ocr</field>
        <field name="model">hr.expense</field>
        <field name="inherit_id" ref="hr_expense.view_hr_expense_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <separator/>
                <filter name="filter_ocr_extracted" string="OCR Extracted" domain="[('ocr_state', '=', 'extracted')]"/>
                <filter name="filter_ocr_needs_review" string="Needs OCR Review" domain="[('ocr_state', '=', 'needs_review')]"/>
                <filter name="filter_ocr_failed" string="OCR Failed" domain="[('ocr_state', '=', 'failed')]"/>
                <filter name="filter_duplicate" string="Potential Duplicates" domain="[('is_duplicate_receipt', '=', True)]"/>
            </xpath>
        </field>
    </record>
</odoo>
