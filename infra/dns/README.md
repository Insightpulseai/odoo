# DNS Infrastructure SSOT

**Status**: Active | **Version**: 1.0 | **Last Updated**: 2026-02-13

---

## Overview

Single source of truth for all DNS configuration under `insightpulseai.com`.

**SSOT File**: `infra/dns/subdomain-registry.yaml`

**Generated Artifacts**:
1. `infra/cloudflare/envs/prod/subdomains.auto.tfvars` (Terraform input)
2. `docs/architecture/runtime_identifiers.json` (Runtime reference)
3. `infra/dns/dns-validation-spec.json` (CI validation)

**Generator**: `scripts/generate-dns-artifacts.sh`

**CI Enforcement**: `.github/workflows/dns-sync-check.yml`

---

## Architecture

```
subdomain-registry.yaml (SSOT)
    ‚Üì generate
subdomains.auto.tfvars (Terraform input)
    +
runtime_identifiers.json (Runtime reference)
    +
dns-validation-spec.json (CI validation)
```

**Key Principle**: Never manually edit generated files. Edit YAML, run generator, commit all.

---

## Subdomain Registry Structure

```yaml
version: "1.0"
domain: insightpulseai.com
environment: production
origin_ip: 178.128.112.214

subdomains:
  - name: erp                    # Subdomain (erp.insightpulseai.com)
    type: A                      # DNS record type
    service: odoo_ce_19          # Service identifier
    port: 8069                   # Origin port
    health_check: /web/login     # Health check endpoint
    owner_system: "Odoo CE 19.0" # System owner
    cloudflare_proxied: true     # Cloudflare proxy
    tls_mode: "Full (strict)"    # TLS mode
    status: active               # Status (active, planned, deprecated)
```

---

## Workflow

### 1. Add New Subdomain

Edit `subdomain-registry.yaml`:
```yaml
subdomains:
  - name: api-v2
    type: A
    service: odoo_api_v2
    port: 8080
    health_check: /api/v2/health
    owner_system: "Odoo API v2"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    status: active
```

### 2. Run Generator

```bash
./scripts/generate-dns-artifacts.sh
```

**Output**:
```
üîÑ Generating DNS artifacts from SSOT...
   Source: infra/dns/subdomain-registry.yaml
üìù Generating Terraform variables...
‚úÖ Generated: infra/cloudflare/envs/prod/subdomains.auto.tfvars
üìù Generating runtime identifiers JSON...
‚úÖ Generated: docs/architecture/runtime_identifiers.json
üìù Generating validation spec...
‚úÖ Generated: infra/dns/dns-validation-spec.json

‚úÖ DNS artifacts generated successfully!
```

### 3. Commit and Push

```bash
git add infra/dns/ infra/cloudflare/ docs/architecture/
git commit -m "feat(infra): add api-v2 subdomain"
git push
```

**CI Validation**: `.github/workflows/dns-sync-check.yml` runs automatically

### 4. Apply Terraform

```bash
cd infra/cloudflare/envs/prod/
terraform plan   # Should show 1 new A record
terraform apply  # Creates api-v2.insightpulseai.com
```

### 5. Verify DNS

```bash
dig api-v2.insightpulseai.com +short  # Should return 178.128.112.214
curl -sf https://api-v2.insightpulseai.com/api/v2/health  # Should return 200
```

---

## Generated Files

### Terraform Variables (`subdomains.auto.tfvars`)

```hcl
# =============================================================================
# Terraform Auto-Generated Variables ‚Äî DO NOT EDIT BY HAND
# =============================================================================
# Generated by: scripts/generate-dns-artifacts.sh
# Source: infra/dns/subdomain-registry.yaml
# Last generated: 2026-02-13T12:00:00Z
# =============================================================================

# Core subdomains (A records pointing to origin_ip)
app_subdomains = [
  "erp",
  "n8n",
  "ocr",
  "auth",
  "superset",
  "api-v2"
]
```

### Runtime Identifiers JSON

```json
{
  "domain": "insightpulseai.com",
  "consolidation_date": "2026-02-13",
  "generated_at": "2026-02-13T12:00:00Z",
  "generator": "scripts/generate-dns-artifacts.sh",
  "source": "infra/dns/subdomain-registry.yaml",
  "services": {
    "api-v2": {
      "fqdn": "api-v2.insightpulseai.com",
      "record_type": "A",
      "target": "178.128.112.214",
      "cloudflare_proxied": true,
      "origin_port": 8080,
      "health_check": "/api/v2/health",
      "status": "active"
    }
  }
}
```

### Validation Spec (`dns-validation-spec.json`)

```json
{
  "version": "1.0",
  "generated_at": "2026-02-13T12:00:00Z",
  "source": "infra/dns/subdomain-registry.yaml",
  "validation_rules": {
    "terraform_file": "infra/cloudflare/envs/prod/subdomains.auto.tfvars",
    "runtime_file": "docs/architecture/runtime_identifiers.json",
    "expected_subdomain_count": 9,
    "expected_active_count": 8,
    "expected_deprecated_count": 1
  },
  "checksums": {
    "ssot_file": "abc123...",
    "terraform_file": "def456...",
    "runtime_file": "ghi789..."
  }
}
```

---

## CI/CD Integration

### GitHub Actions Workflow

**File**: `.github/workflows/dns-sync-check.yml`

**Trigger**:
- Push to `infra/dns/**`
- Push to generated files
- Pull requests modifying DNS config

**Validation**:
1. Runs generator script
2. Compares generated files with committed files
3. Fails if any differences detected
4. Validates subdomain count matches YAML

**Outcome**:
- ‚úÖ Pass: Generated files match committed files
- ‚ùå Fail: Manual edits detected, run generator and commit

---

## Deprecation Workflow

### Mark Service as Deprecated

Edit `subdomain-registry.yaml`:
```yaml
deprecated:
  - name: old-api
    deprecated_date: "2026-02-13"
    replacement: "api-v2"
    reason: "Migrated to v2 API"
    dns_removed: true
    container_removed: true
```

Remove from active subdomains:
```yaml
subdomains:
  # Remove old-api entry
```

Run generator, commit, and apply Terraform to remove DNS record.

---

## Security

### Access Control

**YAML File**: Only infrastructure team can edit
**Generated Files**: Committed to repo (public read, no manual edits)
**Terraform State**: Stored in Cloudflare (API token required)

### Validation

**CI Workflow**: Enforces no manual drift
**Pre-commit Hook**: Runs generator locally (optional)
**Terraform Plan**: Shows DNS changes before apply

---

## Troubleshooting

### Generator Fails

**Symptom**: `yq: command not found`

**Fix**:
```bash
# macOS
brew install yq

# Ubuntu
sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
sudo chmod +x /usr/local/bin/yq
```

### CI Fails on Manual Edit

**Symptom**: "Terraform variables differ from committed version"

**Fix**:
```bash
./scripts/generate-dns-artifacts.sh
git add infra/cloudflare/ docs/architecture/ infra/dns/
git commit --amend --no-edit
git push --force-with-lease
```

### Subdomain Count Mismatch

**Symptom**: "Expected 9, Actual 8"

**Fix**: Check for missing entries in YAML or JSON, re-run generator

---

## References

- **SSOT File**: `infra/dns/subdomain-registry.yaml`
- **Generator**: `scripts/generate-dns-artifacts.sh`
- **CI Workflow**: `.github/workflows/dns-sync-check.yml`
- **Terraform Module**: `infra/cloudflare/modules/dns-records/`
- **Runtime JSON**: `docs/architecture/runtime_identifiers.json`
