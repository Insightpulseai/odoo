# Cloudflare Infra — README

## Overview

Cloudflare is the **authoritative DNS** and edge proxy for `insightpulseai.com`.
All DNS records and settings are managed via this directory — **never via the dashboard**.

---

## SSOT Layout

```
infra/cloudflare/
├── zones/
│   └── insightpulseai.com/
│       ├── records.yaml          ← SSOT for DNS records (edit this)
│       └── settings.yaml         ← SSOT for zone settings (WAF, cache, etc.)
├── modules/                      ← Terraform modules (reusable)
├── envs/
│   └── prod/                     ← Terraform env (subdomains.auto.tfvars, etc.)
├── scripts/
│   ├── apply_dns_from_yaml.py    ← Idempotent YAML→Cloudflare applier
│   └── verify_cloudflare_dns_drift.py  ← Drift check (CI read-only)
└── README.md                     ← This file
```

## Generated Outputs (Output-Only — Do Not Edit)

```
artifacts/cloudflare/
└── zone_state.json               ← Live zone snapshot (generated by CI drift check)
```

> **Rule**: `artifacts/` is read-only output. The SSOT inputs live in `infra/cloudflare/zones/`.

---

## Workflows

| Workflow | Trigger | Purpose |
|----------|---------|---------|
| `cloudflare-dns-apply.yml` | Push to `main` when `infra/cloudflare/**` changes | Apply SSOT records to live zone |
| `cloudflare-dns-drift.yml` | PR check | Read-only drift detection |
| `cloudflare-authority-gate.yml` | PR touching `infra/cloudflare/**` or `infra/dns/**` | Verify CF is authoritative before allowing DNS changes |

---

## Editing DNS Records

1. Edit `zones/insightpulseai.com/records.yaml`
2. Commit + push to a branch
3. Open PR — `cloudflare-authority-gate.yml` runs (verifies NS delegation is live)
4. Merge to `main` — `cloudflare-dns-apply.yml` auto-applies changes

**Never** edit the Cloudflare dashboard; it will be overwritten on next apply.

---

## Secrets Required

| Secret | Scope | Used by |
|--------|-------|---------|
| `CF_DNS_READ_TOKEN` | Zone:DNS:Read | `cloudflare-dns-drift.yml`, `cloudflare-authority-gate.yml` |
| `CF_DNS_EDIT_TOKEN` | Zone:DNS:Edit | `cloudflare-dns-apply.yml` |
| `CF_DNS_ZONE_ID` | Zone ID string | All three workflows |

See `ssot/secrets/registry.yaml` for canonical identifier definitions.
See `docs/runbooks/SECRETS_SSOT.md` for storage and rotation procedures.

---

## Authoritative DNS Status

Cloudflare is authoritative when `dig NS insightpulseai.com` returns:
- `edna.ns.cloudflare.com`
- `keanu.ns.cloudflare.com`

CI gate (`cloudflare-authority-gate.yml`) verifies this before allowing DNS record PRs to merge.

**If not authoritative:** nameserver delegation at the domain registrar (Spacesquare) must be
switched to the above nameservers before Cloudflare records take effect.
