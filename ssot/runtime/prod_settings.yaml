version: 1
type: ssot.runtime.prod_settings
scope: odoo_runtime

# =============================================================================
# Prod Settings SSOT — InsightPulse AI
# =============================================================================
# This file is the production readiness contract for the Odoo runtime.
# It captures invariants (what must be true) and secret references (by name only).
#
# CI gate: scripts/ci/check_prod_settings_ssot.py
# Workflow: .github/workflows/prod-settings-ssot-gate.yml
#
# Rules:
# - NO plaintext secrets or credentials in this file
# - Secrets are referenced by registry ID (must exist in ssot/secrets/registry.yaml)
# - "required: true" means the gate fails if the invariant is absent from SSOT
# =============================================================================

environment: prod

# ---------------------------------------------------------------------------
# Odoo Core Runtime Invariants
# ---------------------------------------------------------------------------
odoo:
  invariants:
    web_base_url: "https://erp.insightpulseai.com"
    web_base_url_freeze: true
    proxy_mode: true

  auth:
    signup:
      allow_uninvited: false
      reset_password: true

# ---------------------------------------------------------------------------
# Email
# ---------------------------------------------------------------------------
email:
  status: required
  smtp:
    provider: zoho
    from_domain: insightpulseai.com
    # Secret names only — raw values never in repo
    # Registry IDs must exist in ssot/secrets/registry.yaml
    secrets:
      smtp_user: zoho_smtp_user
      smtp_app_password: zoho_smtp_app_password
  aliases:
    enabled: true
    catchall_domain: "insightpulseai.com"

# ---------------------------------------------------------------------------
# OCR Pipeline
# ---------------------------------------------------------------------------
ocr:
  status: required
  endpoint:
    base_url: "https://ocr.insightpulseai.com"
    health_path: "/healthz"
  secrets:
    bridge_token: ocr_bridge_token

# ---------------------------------------------------------------------------
# AI Provider Policy
# ---------------------------------------------------------------------------
ai:
  policy:
    fail_closed: true
    missing_key_http_status: 503
    missing_key_code: "AI_KEY_NOT_CONFIGURED"
    provider_priority:
      - anthropic
      - gemini
      - ollama
  policy_ssot:
    file: ssot/ai/odoo_ai.yaml
    require_fail_closed: true
  providers:
    anthropic:
      status: optional
      secret: anthropic_api_key
      dependency_gate:
        dependency_id: apexive_odoo_llm
        require_pinned_ref: true
    gemini:
      status: optional
      secret: gemini_api_key

# ---------------------------------------------------------------------------
# Identity & Auth Policy
# ---------------------------------------------------------------------------
auth:
  # Supabase is the identity system-of-record (SoR).
  # Supabase mints the invite token; Odoo sends the branded email (optional).
  # Odoo partner/user is provisioned on first post-accept login, not before.
  #
  # identity_sor: supabase | odoo
  identity_sor: supabase
  invitation:
    issuer: supabase
    email_sender: odoo   # Odoo sends branded email template; link contains Supabase-generated token
    acceptance_url: "https://ops.insightpulseai.com/auth/accept-invite"
    post_accept_provisioning:
      odoo:
        enabled: true
        mode: portal        # portal | internal (default portal for external users)
        link_key: supabase_user_id   # field on res.partner that links to Supabase identity
  mfa:
    # MFA belongs to the IdP (Supabase). Odoo TOTP is explicitly disabled to
    # prevent a parallel MFA system that would allow users to bypass Supabase MFA
    # depending on which entrypoint they use.
    enforcement: optional          # optional | required (flip required when rollout complete)
    provider: supabase             # must remain supabase while identity_sor=supabase
    totp:
      enabled: true
      required: false              # flip true when ready to enforce for all users
      issuer_label: "InsightPulseAI"
    odoo_totp:
      enabled: false               # explicit: Odoo's own TOTP module must not be activated
  #
  # Downstream contracts:
  #   - Supabase tables: orgs, org_members, roles (RLS enforced)
  #   - Odoo: res.partner.supabase_user_id = Supabase UUID (set by provisioning bridge post-login)
  #   - No standalone Odoo-only identity for cross-app users; service accounts are exempt
  #   - "Is TOTP set up?" = "Is the user enrolled in Supabase MFA?" — not Odoo 2FA
  # Platform rule reference: ssot-platform.md — Rule 9: Odoo is relying party, Supabase is IdP

# ---------------------------------------------------------------------------
# Payments
# ---------------------------------------------------------------------------
payments:
  stripe:
    enabled: true
    # mode: live is required in prod (CI gate enforces this).
    # Flip Vault secret to sk_live_... before setting mode: live.
    mode: live
    # Secret IDs only — raw sk_*/whsec_*/pk_* values never in repo
    # All IDs must exist in ssot/secrets/registry.yaml
    secrets:
      secret_key: stripe_secret_key                       # sk_live_... in Vault
      webhook_signing_secret: stripe_webhook_signing_secret  # whsec_... from Stripe Dashboard → Webhooks
    public:
      publishable_key_ref: stripe_publishable_key         # pk_live_... via Vercel env / Vault
    supabase_wrapper:
      enabled: true
      server_name: stripe_server
      schema: stripe          # foreign tables imported into this schema
    notes: >
      Stripe FDW: supabase/migrations/20260228000001_stripe_wrapper.sql.
      Server creation requires Vault secret UUID — provision out-of-band, then run follow-up migration.
      stripe_secret_key (sk_live_...) and stripe_publishable_key (pk_live_...) must both be live-mode.
      Rotate stripe_secret_key via Stripe Dashboard → API Keys → Roll key, then update Vault.

# ---------------------------------------------------------------------------
# Domain Lifecycle Truth
# ---------------------------------------------------------------------------
urls:
  lifecycle_truth:
    require_healthcheck_for_active: true
  active_required:
    - "https://erp.insightpulseai.com"
    - "https://ocr.insightpulseai.com"

# ---------------------------------------------------------------------------
# Backup Evidence References
# ---------------------------------------------------------------------------
backups:
  database:
    required: true
    evidence:
      - path: docs/ops/BACKUP_POLICY.md
        required: false  # Gate won't fail if absent; use as documentation pointer
  filestore:
    required: true
    evidence:
      - path: docs/ops/BACKUP_POLICY.md
        required: false
