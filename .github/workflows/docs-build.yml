name: docs-build

on:
  pull_request:
    paths:
      - 'docs/pages/**'
      - 'mkdocs.yml'
      - 'requirements-docs.txt'
      - '.github/workflows/docs-build.yml'
  push:
    branches: [main]
    paths:
      - 'docs/pages/**'
      - 'mkdocs.yml'
      - 'requirements-docs.txt'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: MkDocs Build (strict)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: requirements-docs.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-docs.txt

      - name: Build MkDocs (strict mode)
        run: mkdocs build --strict --clean --site-dir ./site

      - name: Verify Primer CSS exists
        run: test -f site/stylesheets/primer.css

      - name: Verify key pages exist
        run: |
          for page in index.html ee-parity-gate.html deployment-timeline.html modules.html; do
            # MkDocs may output flat files or directory-style â€” check both
            if [ -f "site/$page" ] || [ -f "site/${page%.html}/index.html" ]; then
              echo "OK: $page"
            else
              echo "FAIL: site/$page missing"; exit 1
            fi
          done
          echo "All key pages built: OK"
