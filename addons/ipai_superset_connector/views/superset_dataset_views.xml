<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Superset Dataset Views -->
    
    <record id="superset_dataset_view_form" model="ir.ui.view">
        <field name="name">superset.dataset.form</field>
        <field name="model">superset.dataset</field>
        <field name="arch" type="xml">
            <form string="Superset Dataset">
                <header>
                    <button name="action_generate_sql" type="object" 
                            string="Generate SQL" class="btn-secondary"
                            invisible="source_type == 'sql'"/>
                    <button name="action_create_view" type="object" 
                            string="Create View" class="btn-primary"
                            invisible="view_created or not view_sql"/>
                    <button name="action_sync_to_superset" type="object" 
                            string="Sync to Superset" class="btn-primary"
                            invisible="not view_created"/>
                    <button name="action_open_in_superset" type="object" 
                            string="Open in Superset" class="btn-secondary"
                            invisible="not superset_dataset_id"/>
                    <field name="sync_status" widget="statusbar" 
                           statusbar_visible="pending,synced,error"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name" placeholder="Dataset Name"/>
                        </h1>
                        <field name="technical_name" placeholder="technical_name"/>
                    </div>
                    <group>
                        <group string="Configuration">
                            <field name="connection_id"/>
                            <field name="source_type"/>
                            <field name="category"/>
                            <field name="enable_rls"/>
                            <field name="rls_filter_column" invisible="not enable_rls"/>
                        </group>
                        <group string="Status">
                            <field name="view_name" readonly="1"/>
                            <field name="view_created" readonly="1"/>
                            <field name="superset_dataset_id" readonly="1"/>
                            <field name="column_count"/>
                            <field name="last_sync"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Model" name="model" invisible="source_type != 'model'">
                            <group>
                                <field name="model_id"/>
                                <field name="include_all_fields"/>
                            </group>
                            <field name="field_ids" widget="many2many_tags" 
                                   invisible="include_all_fields"
                                   options="{'no_create': True}"/>
                        </page>
                        <page string="Custom SQL" name="sql" invisible="source_type != 'sql'">
                            <field name="custom_sql" widget="ace" 
                                   options="{'mode': 'pgsql'}"/>
                        </page>
                        <page string="Generated SQL" name="generated_sql">
                            <field name="view_sql" widget="ace" 
                                   options="{'mode': 'pgsql'}" readonly="1"/>
                        </page>
                        <page string="Description" name="description">
                            <field name="description"/>
                        </page>
                        <page string="Errors" name="errors" invisible="not sync_error">
                            <field name="sync_error" readonly="1"/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <record id="superset_dataset_view_tree" model="ir.ui.view">
        <field name="name">superset.dataset.tree</field>
        <field name="model">superset.dataset</field>
        <field name="arch" type="xml">
            <tree>
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="technical_name"/>
                <field name="category"/>
                <field name="model_id"/>
                <field name="column_count"/>
                <field name="view_created" widget="boolean"/>
                <field name="sync_status" widget="badge"
                       decoration-success="sync_status == 'synced'"
                       decoration-danger="sync_status == 'error'"
                       decoration-muted="sync_status == 'pending'"/>
                <field name="last_sync"/>
            </tree>
        </field>
    </record>

    <record id="superset_dataset_view_search" model="ir.ui.view">
        <field name="name">superset.dataset.search</field>
        <field name="model">superset.dataset</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="technical_name"/>
                <field name="model_id"/>
                <filter name="synced" string="Synced" domain="[('sync_status', '=', 'synced')]"/>
                <filter name="pending" string="Pending" domain="[('sync_status', '=', 'pending')]"/>
                <filter name="error" string="Errors" domain="[('sync_status', '=', 'error')]"/>
                <separator/>
                <filter name="sales" string="Sales" domain="[('category', '=', 'sales')]"/>
                <filter name="finance" string="Finance" domain="[('category', '=', 'finance')]"/>
                <filter name="inventory" string="Inventory" domain="[('category', '=', 'inventory')]"/>
                <group expand="0" string="Group By">
                    <filter string="Category" name="group_category" context="{'group_by': 'category'}"/>
                    <filter string="Sync Status" name="group_status" context="{'group_by': 'sync_status'}"/>
                    <filter string="Connection" name="group_connection" context="{'group_by': 'connection_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <record id="action_superset_dataset_list" model="ir.actions.act_window">
        <field name="name">Superset Datasets</field>
        <field name="res_model">superset.dataset</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first Superset dataset
            </p>
            <p>
                Datasets expose Odoo data to Superset for analysis and dashboards.
            </p>
        </field>
    </record>

    <!-- Analytics Views -->
    <record id="superset_analytics_view_tree" model="ir.ui.view">
        <field name="name">superset.analytics.view.tree</field>
        <field name="model">superset.analytics.view</field>
        <field name="arch" type="xml">
            <tree>
                <field name="sequence" widget="handle"/>
                <field name="name"/>
                <field name="technical_name"/>
                <field name="category"/>
                <field name="is_created" widget="boolean"/>
                <field name="last_refresh"/>
                <button name="action_create_view" type="object" 
                        string="Create" class="btn-link"
                        invisible="is_created"/>
                <button name="action_drop_view" type="object" 
                        string="Drop" class="btn-link text-danger"
                        invisible="not is_created"/>
            </tree>
        </field>
    </record>

    <record id="action_superset_analytics_views" model="ir.actions.act_window">
        <field name="name">Analytics Views</field>
        <field name="res_model">superset.analytics.view</field>
        <field name="view_mode">tree,form</field>
    </record>

    <!-- Menu Items -->
    <menuitem id="menu_superset_datasets"
              name="Datasets"
              parent="menu_superset_root"
              action="action_superset_dataset_list"
              sequence="20"/>
    
    <menuitem id="menu_superset_analytics_views"
              name="Analytics Views"
              parent="menu_superset_root"
              action="action_superset_analytics_views"
              sequence="30"/>

</odoo>
