name: Spec Kit Hygiene

on:
  pull_request:
    paths:
      - "automations/**"
      - "spec/**"
      - ".github/pull_request_template.md"
      - "docs/**"

jobs:
  spec-kit-hygiene:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine changed spec bundles
        id: bundles
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin "${{ github.base_ref }}" --depth=1
          CHANGED=$(git diff --name-only "origin/${{ github.base_ref }}"...HEAD | grep '^spec/' || true)
          if [ -z "$CHANGED" ]; then
            echo "bundles=" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Extract "spec/<slug>" roots from changed files
          BUNDLES=$(echo "$CHANGED" | awk -F/ 'NF>=2 {print $1"/"$2}' | sort -u | tr '\n' ' ')
          echo "bundles=$BUNDLES" >> "$GITHUB_OUTPUT"

      - name: Validate Spec Kit bundle completeness
        if: steps.bundles.outputs.bundles != ''
        shell: bash
        run: |
          set -euo pipefail
          for b in ${{ steps.bundles.outputs.bundles }}; do
            for f in constitution.md prd.md plan.md tasks.md; do
              test -f "$b/$f" || { echo "::error file=$b/$f::Missing required Spec Kit file"; exit 1; }
            done
          done

      - name: Enforce canonical paths in plan/tasks
        if: steps.bundles.outputs.bundles != ''
        shell: bash
        run: |
          set -euo pipefail
          # Ban old taxonomy roots that cause drift
          BANNED_PATTERNS=(
            "docs/development/"
            "docs/dev/"
          )
          for b in ${{ steps.bundles.outputs.bundles }}; do
            for f in plan.md tasks.md; do
              for p in "${BANNED_PATTERNS[@]}"; do
                if grep -n "$p" "$b/$f" >/dev/null 2>&1; then
                  echo "::error file=$b/$f::Found banned path root '$p'. Use docs/architecture/ or docs/deployment/ per repo taxonomy."
                  grep -n "$p" "$b/$f" || true
                  exit 1
                fi
              done
            done
          done

      - name: Heuristic DoD-style tasks enforcement
        if: steps.bundles.outputs.bundles != ''
        shell: bash
        run: |
          set -euo pipefail
          for b in ${{ steps.bundles.outputs.bundles }}; do
            t="$b/tasks.md"
            # Require at least one "Owner:" and "Deliverable:" marker to indicate DoD framing
            grep -qE '^\*\*Owner:\*\*|^Owner:' "$t" || { echo "::error file=$t::Missing Owner marker (DoD-style required)"; exit 1; }
            grep -qE '^\*\*Deliverable:\*\*|^Deliverable:' "$t" || { echo "::error file=$t::Missing Deliverable marker (DoD-style required)"; exit 1; }
            # Require "DoD:" occurrences
            grep -qE '^(\*\*DoD:\*\*|DoD:)' "$t" || { echo "::error file=$t::Missing DoD marker (DoD-style required)"; exit 1; }
          done

      - name: Discourage UI-first instructions as primary execution path
        if: steps.bundles.outputs.bundles != ''
        shell: bash
        run: |
          set -euo pipefail
          # This is intentionally a soft heuristic. It flags common UI verbs unless labeled Optional.
          UI_VERBS_REGEX='(click|open (the )?dashboard|go to (settings|the dashboard)|press (cmd|ctrl)|navigate to)'
          for b in ${{ steps.bundles.outputs.bundles }}; do
            for f in plan.md tasks.md prd.md; do
              path="$b/$f"
              # Allow lines that explicitly say Optional:
              HITS=$(grep -nEi "$UI_VERBS_REGEX" "$path" | grep -vEi 'Optional:' || true)
              if [ -n "$HITS" ]; then
                echo "::error file=$path::UI/manual steps detected without 'Optional:' qualifier. Prefer automation-first wording."
                echo "$HITS"
                exit 1
              fi
            done
          done

      - name: Check n8n Workflow Secrets
        shell: bash
        run: |
          set -euo pipefail
          # Install ripgrep for pattern matching
          sudo apt-get update && sudo apt-get install -y ripgrep

          # Run n8n secret hygiene check
          chmod +x scripts/ci/check_n8n_workflow_secrets.sh
          if ! ./scripts/ci/check_n8n_workflow_secrets.sh ci; then
            echo "‚ùå n8n workflow secret check failed"
            exit 1
          fi
