id: po_basic_v1
doc_type: purchase_order
description: >
  Agentic pipeline for standard purchase orders. Focus on supplier, PO metadata,
  required dates, and line items with quantities and prices.

steps:
  # 1) Classification
  - id: classify_document
    type: llm
    prompt_ref: classify_document
    inputs:
      - ocr_text
    outputs:
      - doc_type_pred
      - doc_type_confidence
    stop_if:
      condition: "doc_type_pred != 'purchase_order'"
      action: "fail"

  # 2) Core extraction
  - id: extract_core_fields
    type: llm
    prompt_ref: po_extraction
    inputs:
      - ocr_text
    outputs:
      - supplier_name
      - supplier_address
      - po_number
      - po_date
      - requested_delivery_date
      - total_amount
      - subtotal_amount
      - tax_amount
      - currency
      - buyer_name
      - buyer_reference
      - line_items
      - overall_confidence

  # 3) Normalization
  - id: normalize_fields
    type: parser
    operations:
      - field: po_date
        parser: normalize_date
      - field: requested_delivery_date
        parser: normalize_date
      - field: total_amount
        parser: parse_amount
      - field: subtotal_amount
        parser: parse_amount
      - field: tax_amount
        parser: parse_amount
      - field: currency
        parser: detect_currency

  # 4) Validation
  - id: validate_business_rules
    type: validation
    rule_set: po_default
    outputs:
      - validation_status
      - validation_errors

  # 5) Correction round
  - id: correction_round
    type: llm
    when: "validation_status == 'fail' or overall_confidence < 0.9"
    prompt_ref: po_correction
    inputs:
      - ocr_text
      - current_fields
      - validation_errors
    outputs:
      - supplier_name
      - supplier_address
      - po_number
      - po_date
      - requested_delivery_date
      - total_amount
      - subtotal_amount
      - tax_amount
      - currency
      - buyer_name
      - buyer_reference
      - line_items
      - overall_confidence

  # 6) Final validation
  - id: final_validation
    type: validation
    rule_set: po_default
    outputs:
      - final_status
      - final_errors

target:
  min_confidence: 0.9
  require_final_status: "pass"
  on_fail: "send_to_review"
