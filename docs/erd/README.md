# ERD Artifacts

Auto-generated schema artifacts for the Odoo PostgreSQL database.

| File | Generator | Description |
|------|-----------|-------------|
| `odoo.dbml` | `scripts/erd/export_dbml.py` | Full schema as DBML — tables, columns, PKs, FKs |
| `odoo_crosswalk.json` | `scripts/erd/export_crosswalk.py` | ORM model ↔ SQL table/column mapping |

> **Do not edit by hand.** These files are generated. Regenerate with:
> ```bash
> bash scripts/erd/generate_all.sh
> ```

---

## Prerequisites

```bash
# Install Python dependencies
pip install psycopg2-binary pyyaml

# Set database connection
export DATABASE_URL="postgresql://postgres:pass@localhost:5432/odoo"
# OR use individual PG* vars:
export PGHOST=localhost PGPORT=5432 PGDATABASE=odoo PGUSER=postgres PGPASSWORD=pass
```

---

## Run Commands

```bash
# Full generation (DBML + crosswalk, ORM step auto-detected)
bash scripts/erd/generate_all.sh

# DBML only (pg_catalog → odoo.dbml)
python3 scripts/erd/export_dbml.py

# Crosswalk only (requires odoo.dbml + docs/data_model/schema.json)
python3 scripts/erd/export_crosswalk.py

# Skip ORM export (CI mode — no live Odoo DB)
SKIP_ORM_EXPORT=1 bash scripts/erd/generate_all.sh
```

---

## Scoping Filters

`export_dbml.py` supports optional scoping via environment variables:

| Var | Default | Purpose |
|-----|---------|---------|
| `ERD_SCHEMAS` | `public` | Comma-separated schemas to include |
| `ERD_TABLE_INCLUDE_REGEX` | *(none)* | Only include tables matching this Python regex |
| `ERD_TABLE_EXCLUDE_REGEX` | *(none)* | Exclude tables matching this Python regex |
| `ERD_DBML_OUT` | `docs/erd/odoo.dbml` | Output path |

Example — include only `res_*` and `account_*` tables:
```bash
ERD_TABLE_INCLUDE_REGEX="^(res_|account_)" python3 scripts/erd/export_dbml.py
```

---

## CI Drift Gate

The workflow `.github/workflows/erd-drift-check.yml` regenerates these artifacts
and fails if the committed copies differ from the regenerated ones.

**To keep CI green**: re-run `generate_all.sh` and commit the updated artifacts
whenever the database schema changes.

---

## Using DBML

DBML files can be visualised at [dbdiagram.io](https://dbdiagram.io) — paste the
contents of `odoo.dbml` into the editor. Alternatively use the
[dbml-renderer](https://github.com/softwaretechnik-berlin/dbml-renderer) CLI to
generate SVG locally:

```bash
npx dbml-renderer -i docs/erd/odoo.dbml -o docs/erd/odoo.svg
```

---

## Crosswalk JSON Structure

```json
{
  "meta": { "generated_by": "...", "dbml_source": "...", "schema_source": "..." },
  "models": [
    {
      "model":   "res.partner",
      "table":   "res_partner",
      "matched": true,
      "fields": [
        { "field": "name", "type": "char", "column": "name", "matched": true }
      ]
    }
  ],
  "unmatched_models": [],
  "unmatched_tables": []
}
```

`matched: false` entries indicate ORM models whose SQL table was not found in
the DBML — usually transient models, abstract models, or models from modules
not installed in the target database.

---

*Generated by `scripts/erd/export_dbml.py` and `scripts/erd/export_crosswalk.py`.*
*Drift checked by `.github/workflows/erd-drift-check.yml`.*
