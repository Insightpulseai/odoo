# =============================================================================
# Unified CI Green Aggregate
# =============================================================================
# Single workflow that runs the unified CI script, enforcing "no drift" policy.
# This workflow mirrors what ./scripts/ci/run_all.sh does locally.
#
# Triggers: Pull requests and pushes to main
# =============================================================================

name: CI Green Aggregate

on:
  pull_request:
  push:
    branches: [main, develop]
  workflow_dispatch: # Manual trigger

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci-all:
    name: Unified CI Gates
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for drift checks

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: "9"

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-docs.txt ]; then pip install -r requirements-docs.txt; fi

      - name: Install Node dependencies
        run: pnpm install --frozen-lockfile || pnpm install

      - name: Install tree (for TREE.md generation)
        run: |
          if ! command -v tree &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y tree
          fi

      - name: Run unified CI script
        run: |
          chmod +x scripts/ci/run_all.sh
          ./scripts/ci/run_all.sh

      - name: Verify no uncommitted drift
        run: |
          echo "== Checking for uncommitted drift =="
          if git diff --exit-code; then
            echo "✓ No drift detected"
          else
            echo "✗ Drift detected! The following files changed after running CI:"
            git diff --stat
            echo ""
            echo "Please run ./scripts/ci/run_all.sh locally and commit the changes."
            exit 1
          fi
