# ═══════════════════════════════════════════════════════════════════════════════
# ODOO CE 19 + EE PARITY - DEV SANDBOX (odoo-dev-sandbox)
# ═══════════════════════════════════════════════════════════════════════════════
#
# Purpose: Isolated development environment for ipai_* custom modules
# Image:   ghcr.io/jgtolentino/odoo-ce:19.0-ee-parity (CE19 + OCA + IPAI Enterprise Bridge)
# SSOT:    docker/docker-compose.ce19.yml (canonical image definition)
# Usage:   docker compose up -d
# Access:  http://localhost:8069
# Docs:    docs/runbooks/DEV_SANDBOX.md
#
# ═══════════════════════════════════════════════════════════════════════════════

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # PostgreSQL 16 - Dev Database
  # ─────────────────────────────────────────────────────────────────────────────
  db:
    image: postgres:16-alpine
    container_name: odoo-dev-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-odoo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-odoo_dev_password}
      POSTGRES_DB: postgres
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - odoo-dev-db-data:/var/lib/postgresql/data
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-odoo}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - odoo-dev-net

  # ─────────────────────────────────────────────────────────────────────────────
  # Odoo CE 19 + EE Parity - Dev Instance with Hot Reload
  # ─────────────────────────────────────────────────────────────────────────────
  odoo:
    image: odoo:${ODOO_IMAGE_TAG:-18.0}
    container_name: odoo-dev
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      - HOST=db
      - PORT=5432
      - USER=${POSTGRES_USER:-odoo}
      - PASSWORD=${POSTGRES_PASSWORD:-odoo_dev_password}
    volumes:
      # Custom addons (ipai_* modules with hot-reload)
      - ./addons:/mnt/extra-addons:ro

      # OCA modules (symlink or clone to oca-addons/)
      - ./oca-addons:/mnt/oca:ro

      # Odoo filestore (attachments, images)
      - odoo-dev-filestore:/var/lib/odoo

      # Custom config
      - ./config/odoo.conf:/etc/odoo/odoo.conf:ro
    ports:
      - "${ODOO_PORT:-8069}:8069"
      - "${ODOO_LONGPOLLING_PORT:-8072}:8072"
    command: >
      --dev=reload,qweb,werkzeug,xml
      --limit-time-real=9999
      --limit-time-cpu=9999
    networks:
      - odoo-dev-net

  # ─────────────────────────────────────────────────────────────────────────────
  # pgAdmin - Database Management UI (optional, profile: tools)
  # ─────────────────────────────────────────────────────────────────────────────
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: odoo-dev-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@localhost.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    volumes:
      - odoo-dev-pgadmin:/var/lib/pgadmin
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    depends_on:
      - db
    networks:
      - odoo-dev-net
    profiles:
      - tools

  # ─────────────────────────────────────────────────────────────────────────────
  # Mailpit - Email Testing (optional, profile: tools)
  # ─────────────────────────────────────────────────────────────────────────────
  mailpit:
    image: axllent/mailpit:latest
    container_name: odoo-dev-mailpit
    restart: unless-stopped
    ports:
      - "${MAILPIT_WEB_PORT:-8025}:8025"
      - "${MAILPIT_SMTP_PORT:-1025}:1025"
    networks:
      - odoo-dev-net
    profiles:
      - tools

# ═══════════════════════════════════════════════════════════════════════════════
# VOLUMES - Persistent data
# ═══════════════════════════════════════════════════════════════════════════════
volumes:
  odoo-dev-db-data:
    name: odoo-dev-db-data
  odoo-dev-filestore:
    name: odoo-dev-filestore
  odoo-dev-pgadmin:
    name: odoo-dev-pgadmin

# ═══════════════════════════════════════════════════════════════════════════════
# NETWORK - Isolated dev network
# ═══════════════════════════════════════════════════════════════════════════════
networks:
  odoo-dev-net:
    name: odoo-dev-net
    driver: bridge
