name: Service Health Check (All Services)

on:
  schedule:
    # Every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      scope:
        description: 'Which services to check'
        required: true
        default: 'all'
        type: choice
        options:
          - production
          - staging
          - all

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: Run service health checks
        id: health
        continue-on-error: true
        run: |
          chmod +x scripts/verify-service-health.sh
          SCOPE="${{ inputs.scope || 'all' }}"
          scripts/verify-service-health.sh --${SCOPE} 2>&1 | tee health-report.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"

      - name: Generate JSON report
        if: always()
        run: |
          SCOPE="${{ inputs.scope || 'all' }}"
          scripts/verify-service-health.sh --${SCOPE} --json > health-report.json 2>/dev/null || true

      - name: Upload health report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: service-health-${{ github.run_id }}
          path: |
            health-report.txt
            health-report.json
          retention-days: 30

      - name: Post summary
        if: always()
        run: |
          echo "## Service Health Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "**Scope:** ${{ inputs.scope || 'all' }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat health-report.txt >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

      - name: Notify on failure
        if: steps.health.outputs.exit_code != '0'
        env:
          N8N_WEBHOOK_URL: ${{ secrets.N8N_WEBHOOK_URL }}
        run: |
          if [ -n "${N8N_WEBHOOK_URL:-}" ]; then
            curl -sS -X POST "$N8N_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "{
                \"source\": \"github_actions\",
                \"workflow\": \"service-health-check\",
                \"status\": \"DEGRADED\",
                \"scope\": \"${{ inputs.scope || 'all' }}\",
                \"run_url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
                \"timestamp\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"
              }"
          fi

      - name: Fail if checks failed
        if: steps.health.outputs.exit_code != '0'
        run: exit 1
