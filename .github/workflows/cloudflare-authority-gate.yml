name: Cloudflare Authority Gate

# =============================================================================
# Prevents DNS record changes from merging when Cloudflare is NOT the
# authoritative DNS for insightpulseai.com.
#
# Why: Committing DNS records to infra/cloudflare/ has zero effect if the
# domain's nameservers still point to the old registrar (Spacesquare).
# This gate makes that condition explicit and visible on every PR.
#
# Pass: Cloudflare NS delegation is live -> PR may merge.
# Fail: Old NS delegation -> PR blocked with actionable message.
#
# Secrets required: none (NS/SOA check is a public DNS query).
# Bypass: If NS delegation is genuinely in progress, add label "cf-ns-pending"
#         to the PR -- the gate will warn but not block.
# =============================================================================

on:
  pull_request:
    paths:
      - "infra/cloudflare/**"
      - "infra/dns/**"
      - "ssot/secrets/registry.yaml"
  workflow_dispatch:
    inputs:
      domain:
        description: "Domain to check (default: insightpulseai.com)"
        required: false
        default: "insightpulseai.com"

permissions:
  contents: read
  pull-requests: write

jobs:
  authority-check:
    name: Verify Cloudflare is authoritative
    runs-on: ubuntu-latest
    env:
      VERIFY_DOMAIN: ${{ github.event.inputs.domain || 'insightpulseai.com' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Python dependencies
        run: pip install pyyaml --quiet

      - name: DNS provider claim gate
        id: provider_claims
        run: |
          python3 scripts/ci/check_dns_provider_claims.py \
            2>&1 | tee /tmp/provider_claims_check.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Post PR comment (provider claim failures)
        if: steps.provider_claims.outputs.exit_code != '0' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LOG=$(cat /tmp/provider_claims_check.log 2>/dev/null || echo "Log unavailable")
          {
            echo '## DNS Provider Claim Gate - FAILED'
            echo ''
            echo 'One or more DNS records have `lifecycle: active` but an unclaimed `provider_claim`.'
            echo 'This means Terraform would provision a CNAME that cannot resolve until the'
            echo 'provider (e.g. Vercel) claims the domain.'
            echo ''
            echo '### Remediation'
            echo ''
            echo '**Option A — Keep `lifecycle: planned` until claimed** (safe, no DNS change):'
            echo '1. Ensure the record has `lifecycle: planned` in `infra/dns/subdomain-registry.yaml`'
            echo '2. Claim the domain in the provider dashboard (Vercel → Domains → Add custom domain)'
            echo '3. Update `provider_claim.status: claimed` in the SSOT file'
            echo '4. Change `lifecycle: active` in the same commit'
            echo '5. Re-run this gate'
            echo ''
            echo '**Option B — Already claimed** (update SSOT to reflect reality):'
            echo '1. Confirm the domain is claimed in the provider dashboard'
            echo '2. Update `provider_claim.status: claimed` in `infra/dns/subdomain-registry.yaml`'
            echo '3. The gate will pass on the next push'
            echo ''
            echo '---'
            echo '*Check output:*'
            echo '```'
            echo "$LOG"
            echo '```'
          } > /tmp/claims_comment.md
          gh pr comment "${{ github.event.pull_request.number }}" --body-file /tmp/claims_comment.md

      - name: Fail gate (provider claims not satisfied)
        if: steps.provider_claims.outputs.exit_code != '0'
        run: |
          echo "::error::DNS provider claim gate failed — active records have unclaimed provider_claim."
          echo "::error::See PR comment or /tmp/provider_claims_check.log for details."
          exit 1

      - name: Install dig (dnsutils)
        run: sudo apt-get install -y dnsutils

      - name: Check Cloudflare authority
        id: authority
        run: |
          python3 scripts/cloudflare/verify_authoritative.py \
            --domain "$VERIFY_DOMAIN" \
            2>&1 | tee /tmp/authority_check.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Read check result
        id: result
        run: |
          if grep -q "PASS" /tmp/authority_check.log; then
            echo "authoritative=true" >> "$GITHUB_OUTPUT"
          else
            echo "authoritative=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for bypass label
        id: bypass
        if: steps.result.outputs.authoritative == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LABELS=$(gh pr view "${{ github.event.pull_request.number }}" \
            --json labels --jq '.labels[].name' 2>/dev/null || echo "")
          if echo "$LABELS" | grep -q "cf-ns-pending"; then
            echo "bypassed=true" >> "$GITHUB_OUTPUT"
            echo "Bypass label 'cf-ns-pending' found -- gate warning only, not blocking."
          else
            echo "bypassed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Post PR comment (if not authoritative)
        if: steps.result.outputs.authoritative == 'false' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LOG=$(head -c 2000 /tmp/authority_check.log 2>/dev/null || echo "Log unavailable")
          {
            echo '## Cloudflare Authority Gate - FAILED'
            echo ''
            echo 'Cloudflare is NOT currently the authoritative DNS for `insightpulseai.com`.'
            echo ''
            echo 'DNS record changes committed to `infra/cloudflare/zones/` will have no effect'
            echo 'until Cloudflare nameservers are delegated.'
            echo ''
            echo '### Required action (one-time, at registrar)'
            echo ''
            echo '1. Log into Spacesquare (domain registrar)'
            echo '2. Set nameservers to:'
            echo '   - `edna.ns.cloudflare.com`'
            echo '   - `keanu.ns.cloudflare.com`'
            echo '3. Wait for NS propagation (up to 24-48 hours)'
            echo '4. Re-run this check: trigger the Cloudflare Authority Gate workflow manually'
            echo ''
            echo '### While delegation is pending'
            echo ''
            echo 'Add label `cf-ns-pending` to this PR to convert the gate from blocking to warning-only.'
            echo 'DNS record commits are still safe to merge -- they will apply once delegation completes.'
            echo ''
            echo '---'
            echo '*Check log:*'
            echo '```'
            echo "$LOG"
            echo '```'
          } > /tmp/cf_comment.md
          gh pr comment "${{ github.event.pull_request.number }}" --body-file /tmp/cf_comment.md

      - name: Fail gate (if not authoritative and not bypassed)
        if: steps.result.outputs.authoritative == 'false' && steps.bypass.outputs.bypassed != 'true'
        run: |
          echo "::error::Cloudflare is NOT authoritative for $VERIFY_DOMAIN."
          echo "::error::DNS record changes will have no effect until NS delegation is complete."
          echo "::error::See PR comment for remediation steps, or add label 'cf-ns-pending' to bypass."
          exit 1

      - name: Warn (bypassed)
        if: steps.result.outputs.authoritative == 'false' && steps.bypass.outputs.bypassed == 'true'
        run: |
          echo "::warning::Cloudflare is NOT authoritative for $VERIFY_DOMAIN (bypass active via 'cf-ns-pending' label)."
          echo "::warning::DNS record commits will apply once NS delegation completes."

      - name: Pass
        if: steps.result.outputs.authoritative == 'true'
        run: |
          echo "Cloudflare is authoritative for $VERIFY_DOMAIN -- DNS changes will apply on merge."
