# =============================================================================
# CI: odoo-mobile-ios Swift build + test
# =============================================================================
# Job 1 (macos-swift-clt): swift build + swift test on macOS CLT
#   - No Xcode required; runs via Command Line Tools only
#   - Covers all unit tests (transport + biometric + offline + auth + routing)
#
# Job 2 (ios-simulator): xcodebuild test with iOS Simulator
#   - Requires Xcode 16.x (canonical: 16.4)
#   - Uses scripts/mobile/verify_xcode.sh for consistent Xcode detection
#   - Fails LOUD when Xcode is absent (no silent continue-on-error masking)
#   - MANUAL_REQUIRED for local runs: xcodes install "16.4" (Apple ID needed)
# =============================================================================

name: odoo-mobile-ios — Swift Tests

on:
  push:
    branches: [main, "feat/**", "chore/**"]
    paths:
      - "apps/odoo-mobile-ios/**"
      - "scripts/mobile/verify_xcode.sh"
      - ".github/workflows/odoo-mobile-ios-swift-tests.yml"
  pull_request:
    branches: [main]
    paths:
      - "apps/odoo-mobile-ios/**"
      - "scripts/mobile/verify_xcode.sh"
      - ".github/workflows/odoo-mobile-ios-swift-tests.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # ---------------------------------------------------------------------------
  # Job 1: macOS CLT — swift build + swift test (deterministic, no Xcode)
  # ---------------------------------------------------------------------------
  macos-swift-clt:
    name: swift test (macOS CLT)
    runs-on: macos-15
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Swift version
        run: swift --version

      - name: Build
        working-directory: apps/odoo-mobile-ios
        run: swift build

      - name: Test
        working-directory: apps/odoo-mobile-ios
        run: |
          swift test 2>&1 | tee /tmp/swift_test.log
          grep -q "Test run started" /tmp/swift_test.log || (echo "ERROR: no test output" && exit 1)
          if grep -q "Test run had" /tmp/swift_test.log; then
            FAILURES=$(grep "Test run had" /tmp/swift_test.log | grep -oE "[0-9]+ failure" || true)
            if [ -n "$FAILURES" ]; then
              echo "FAIL: $FAILURES"
              exit 1
            fi
          fi
          echo "✅ All tests passed"

      - name: Upload test log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swift-test-log
          path: /tmp/swift_test.log
          retention-days: 7

  # ---------------------------------------------------------------------------
  # Job 2: iOS Simulator — xcodebuild test
  # Fails LOUD when Xcode 16.x is missing (no continue-on-error masking).
  # MANUAL_REQUIRED for local runs: xcodes install "16.4" (Apple ID required)
  # ---------------------------------------------------------------------------
  ios-simulator:
    name: xcodebuild test (iOS 18 Simulator)
    runs-on: macos-15
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check and select Xcode 16.x
        id: xcode-check
        run: |
          chmod +x scripts/mobile/verify_xcode.sh
          scripts/mobile/verify_xcode.sh
          # Capture selected version for subsequent steps
          XCODE_VER=$(xcodebuild -version | head -1 | awk '{print $2}')
          echo "xcode_version=${XCODE_VER}" >> "$GITHUB_OUTPUT"

      - name: List available simulators
        run: xcrun simctl list devices available | grep "iPhone 16" | head -5

      - name: xcodebuild test (iPhone 16 / iOS 18)
        working-directory: apps/odoo-mobile-ios
        run: |
          xcodebuild test \
            -scheme OdooMobile \
            -destination "platform=iOS Simulator,name=iPhone 16,OS=latest" \
            -resultBundlePath /tmp/odoo-mobile-ios.xcresult \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            2>&1 | tee /tmp/xcodebuild_test.log
          if grep -qE "(FAIL|TEST BUILD FAILED)" /tmp/xcodebuild_test.log; then
            echo "FAIL: xcodebuild tests reported failures"
            exit 1
          fi
          echo "✅ xcodebuild tests passed (Xcode ${{ steps.xcode-check.outputs.xcode_version }})"

      - name: Upload xcresult bundle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-xcresult
          path: /tmp/odoo-mobile-ios.xcresult
          retention-days: 7

      - name: Upload xcodebuild log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcodebuild-test-log
          path: /tmp/xcodebuild_test.log
          retention-days: 7
