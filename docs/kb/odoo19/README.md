# Odoo 19 Knowledge Base (KB) Platform

> **Status**: Enforced by CI (`odoo-docs-platform-gate.yml`)
> **Type**: Deterministic, Layered Documentation System
> **Upstream**: `odoo/documentation:19.0` (Pinned)

This directory contains the Knowledge Base for Odoo 19, constructed via a **Copy ‚Üí Patch ‚Üí Verify** loop.

## 1. Architecture & Contracts

The KB is composed of three layers with strict precedence:

| Priority | Layer        | Path                                               | Writable? | Purpose                                               |
| :------- | :----------- | :------------------------------------------------- | :-------- | :---------------------------------------------------- |
| **1**    | **Override** | `templates/odooops-console/.../upstream_overrides` | ‚úÖ Yes    | Local patches that shadow upstream content.           |
| **2**    | **Stack**    | `templates/odooops-console/.../stack`              | ü§ñ Bot    | Documentation generated from the running environment. |
| **3**    | **Upstream** | `docs/kb/odoo19/upstream`                          | ‚ùå **NO** | Immutable vendor copy. **NEVER EDIT MANUALLY.**       |

### Immutability Contract

- The `upstream` directory is a **read-only mirror**.
- To change upstream content, you must add a file to the **Override** layer with the _exact same relative path_.
- CI will fail if `upstream` is modified without updating `UPSTREAM_PIN.json`.

### Canonical IDs

Every document is assigned a stable **Canonical ID** that persists regardless of which layer provides the content:

```text
kb://odoo19/<slug>
```

- **Slug**: The URL-friendly path (e.g., `developer/reference/orm`).
- If `upstream/content/foo.rst` moves to `overrides/foo.md`, the ID remains `kb://odoo19/foo`.
- All indexing and linking should preferebly use Canonical IDs.

## 2. Operational Workflows

### How to Patch Upstream Docs

1. Find the upstream file path (e.g., `upstream/content/developer/api.rst`).
2. Create a matching file in overrides (e.g., `upstream_overrides/developer/api.md`).
   - _Note: You can use `.md` to override `.rst`._
3. Run `python3 scripts/kb/index_odoo_docs.py` to regenerate the index.
4. Verify `manifest.json` shows the file coming from `layer: override`.

### How to Update Upstream Pin

1. Run `python3 scripts/kb/vendor_odoo_docs.py --commit <SHA>`.
2. This will:
   - Git checkout the new commit in `upstream/`.
   - Update `UPSTREAM_PIN.json`.
3. Commit both changes together.

## 3. Artifacts (`index/`)

The `index/` directory contains machine-readable artifacts generated by `index_odoo_docs.py`:

- **manifest.json**: Complete inventory with `build_info` provenance and checksums.
- **index.json**: Search index with Canonical IDs.
- **nav.json**: Computed navigation tree.
- **topics.json**: Topic-to-File mappings.

## 4. Troubleshooting CI

| Failure             | Cause                                                     | Fix                                                      |
| :------------------ | :-------------------------------------------------------- | :------------------------------------------------------- |
| **Pin Integrity**   | `upstream/` contents don't match `UPSTREAM_PIN.json`      | Re-run vendoring or revert manual changes to upstream.   |
| **Index Integrity** | `manifest.json` is missing `build_info` or `canonical_id` | Re-run `scripts/kb/index_odoo_docs.py`.                  |
| **Resolver Tests**  | `npm test` fails                                          | Check `loader.ts` logic if you changed precedence rules. |
