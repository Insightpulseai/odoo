name: CI

on:
  push:
    branches: [ main, "18.0", "18.0-*", "claude/*" ]
  pull_request:
    branches: [ main, "18.0", "18.0-*" ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

env:
  ODOO_VERSION: "18.0"
  PYTHON_VERSION: "3.10"
  DB_NAME: "odoo"
  DAGGER_CACHE: "false"

jobs:
  preflight:
    name: Preflight Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Hydrate OCA repos
        run: |
          if [ -f scripts/oca_hydrate.sh ]; then
            echo "Hydrating OCA repositories from lockfile..."
            bash scripts/oca_hydrate.sh --tier 4
          else
            echo "No oca_hydrate.sh found; skipping OCA hydration"
          fi

      - name: Environment Info
        run: |
          echo "========================================"
          echo "  Environment Information"
          echo "========================================"
          echo "Python: $(python3 --version)"
          echo "Node: $(node --version || echo 'Not installed')"
          echo "Git: $(git --version)"
          echo "Date: $(date -u)"
          echo ""

      - name: Validate Submodules
        run: |
          echo "Checking submodule configuration..."
          if git submodule status 2>&1 | grep -q "^fatal"; then
            echo "::error::Submodule configuration error!"
            git submodule status
            exit 1
          fi
          echo "✅ Submodules configured correctly"

      - name: Validate Addons Paths
        run: |
          echo "Validating OCA monorepo paths..."
          for dir in addons/ipai addons/oca external-src archive/addons; do
            if [ -d "$dir" ]; then
              COUNT=$(find "$dir" -name "__manifest__.py" 2>/dev/null | wc -l)
              echo "  $dir: $COUNT Odoo modules found"
            else
              echo "  $dir: directory not found (optional)"
            fi
          done

      - name: Block Enterprise View Modes
        run: |
          echo "Scanning for Enterprise-only view modes (gantt)..."
          GANTT_MATCHES=""
          for dir in addons/ipai addons/oca; do
            if [ -d "$dir" ]; then
              GANTT_MATCHES="$GANTT_MATCHES$(grep -Rn 'view_mode.*gantt\|view_type.*gantt' "$dir" --include="*.xml" --include="*.py" 2>/dev/null || true)"
            fi
          done
          if [ -n "$GANTT_MATCHES" ]; then
            echo "::error::Found gantt view references (Enterprise-only in CE):"
            echo "$GANTT_MATCHES"
            exit 1
          fi
          echo "✅ No Enterprise view modes found"

      - name: Check Missing web_icon
        run: |
          echo "Checking for missing web_icon references..."
          ISSUES=0
          for addon_dir in addons/ipai addons/oca; do
            if [ -d "$addon_dir" ]; then
              for manifest in $addon_dir/*/__manifest__.py; do
                if [ -f "$manifest" ]; then
                  ICON_PATH=$(grep -o "'web_icon':\s*['\"][^'\"]*['\"]" "$manifest" 2>/dev/null | sed "s/'web_icon':\s*['\"]//;s/['\"]$//" || true)
                  if [ -n "$ICON_PATH" ]; then
                    MODULE_DIR=$(dirname "$manifest")
                    if [[ "$ICON_PATH" == *"/"* ]]; then
                      FULL_PATH="$addon_dir/$ICON_PATH"
                    else
                      FULL_PATH="$MODULE_DIR/$ICON_PATH"
                    fi
                    if [ ! -f "$FULL_PATH" ]; then
                      echo "::error::Missing icon: $FULL_PATH (referenced in $manifest)"
                      ISSUES=$((ISSUES + 1))
                    fi
                  fi
                fi
              done
            fi
          done
          if [ $ISSUES -gt 0 ]; then
            exit 1
          fi
          echo "✅ All web_icon references valid"

      - name: Validate Module Structure
        run: |
          echo "Validating module manifests..."
          ISSUES=0
          for addon_dir in addons/ipai addons/oca; do
            if [ -d "$addon_dir" ]; then
              for module_dir in $addon_dir/*/; do
                if [ -d "$module_dir" ]; then
                  MODULE_NAME=$(basename "$module_dir")
                  # Skip non-module directories (OCA repos, scripts, etc.)
                  # Only validate if it looks like a module (has __manifest__.py OR __openerp__.py)
                  if [ -f "$module_dir/__manifest__.py" ] || [ -f "$module_dir/__openerp__.py" ]; then
                    # It's a module, validate required files
                    if [ ! -f "$module_dir/__manifest__.py" ] && [ ! -f "$module_dir/__openerp__.py" ]; then
                      echo "::error::Missing __manifest__.py or __openerp__.py in $MODULE_NAME"
                      ISSUES=$((ISSUES + 1))
                    fi
                    if [ ! -f "$module_dir/__init__.py" ]; then
                      echo "::error::Missing __init__.py in $MODULE_NAME"
                      ISSUES=$((ISSUES + 1))
                    fi
                  else
                    # Not a module, skip validation (likely an OCA repo containing modules)
                    echo "ℹ️  Skipping $MODULE_NAME (not a module directory)"
                  fi
                fi
              done
            fi
          done
          if [ $ISSUES -gt 0 ]; then
            exit 1
          fi
          echo "✅ All module structures valid"

      - name: Validate Manifest Icons
        run: python3 scripts/validate_manifest.py

  lint:
    name: Lint & Static Checks
    runs-on: ubuntu-latest
    needs: preflight

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install base tooling
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit black isort pylint flake8
          # Optional OCA tools if you use them:
          # pip install oca-maintainer-tools

      - name: Run pre-commit
        run: |
          if [ -f .pre-commit-config.yaml ]; then
            pre-commit run --all-files
          else
            echo "No pre-commit config; skipping."
          fi

      - name: Enterprise contamination check
        run: |
          set -e
          echo "Scanning for Odoo Enterprise/IAP dependencies..."

          # Check for Enterprise imports in Python files
          enterprise_imports=""
          if [ -d addons ]; then
            enterprise_imports=$(grep -Rn "from odoo\.addons\..*_enterprise" addons 2>/dev/null || true)
            enterprise_imports="$enterprise_imports$(grep -Rn "import odoo\.addons\..*_enterprise" addons 2>/dev/null || true)"
          fi
          if [ -d oca ]; then
            enterprise_imports="$enterprise_imports$(grep -Rn "from odoo\.addons\..*_enterprise" oca 2>/dev/null || true)"
            enterprise_imports="$enterprise_imports$(grep -Rn "import odoo\.addons\..*_enterprise" oca 2>/dev/null || true)"
          fi

          # Check for Enterprise modules in manifest dependencies
          enterprise_depends=""
          if [ -d addons ]; then
            enterprise_depends=$(grep -A5 '"depends"' addons/*/__manifest__.py 2>/dev/null | grep -i "enterprise\|web_studio\|documents\|iap" || true)
          fi
          if [ -d oca ]; then
            enterprise_depends="$enterprise_depends$(grep -A5 '"depends"' oca/*/__manifest__.py 2>/dev/null | grep -i "enterprise\|web_studio\|documents\|iap" || true)"
          fi

          # Check for common Enterprise keywords
          enterprise_keywords=""
          if [ -d addons ]; then
            enterprise_keywords=$(grep -Rn --include="*.py" "web_studio\|documents_\|iap_" addons 2>/dev/null || true)
          fi
          if [ -d oca ]; then
            enterprise_keywords="$enterprise_keywords$(grep -Rn --include="*.py" "web_studio\|documents_\|iap_" oca 2>/dev/null || true)"
          fi

          if [ -n "$enterprise_imports" ] || [ -n "$enterprise_depends" ] || [ -n "$enterprise_keywords" ]; then
            echo "::error::Possible Odoo Enterprise/IAP dependency detected."
            echo "Enterprise imports:"
            echo "$enterprise_imports"
            echo "Enterprise depends:"
            echo "$enterprise_depends"
            echo "Enterprise keywords:"
            echo "$enterprise_keywords"
            echo ""
            echo "Remove these references or move them to a separate, non-CE repo."
            exit 1
          fi
          echo "✅ No Enterprise/IAP dependencies found."

      - name: odoo.com URL check
        run: |
          set -e
          echo "Scanning for odoo.com URLs in code..."

          odoo_urls=""
          for dir in addons oca; do
            if [ -d "$dir" ]; then
              odoo_urls="$odoo_urls$(grep -Rn --include="*.py" --include="*.xml" 'href=.*odoo\.com\|url.*=.*odoo\.com\|https\?://.*\.odoo\.com' "$dir" 2>/dev/null || true)"
            fi
          done

          if [ -n "$odoo_urls" ]; then
            echo "::warning::Found odoo.com URLs in code – consider replacing with InsightPulse/OCA links."
            echo "$odoo_urls"
          else
            echo "✅ No odoo.com URLs found."
          fi

      - name: Python syntax check
        run: |
          echo "Checking Python syntax..."
          for dir in addons oca; do
            if [ -d "$dir" ]; then
              python -m compileall "$dir" 2>/dev/null || echo "Some modules in $dir failed syntax check"
            fi
          done

  tests:
    name: ${{ matrix.test-suite.name }}
    runs-on: ubuntu-latest
    needs: preflight
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - name: "Unit Tests"
            tags: "/unit"
            description: "Fast unit tests"
          - name: "Integration Tests"
            tags: "/integration"
            description: "Database integration tests"
          - name: "All Tests"
            tags: ""
            description: "Complete test suite"
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
          POSTGRES_DB: odoo
        options: >-
          --health-cmd="pg_isready -U odoo"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports: ["5432:5432"]

    env:
      # DB connection for Odoo
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: odoo
      PGPASSWORD: odoo
      PGDATABASE: odoo

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Hydrate OCA repos
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          if [ -f scripts/oca_hydrate.sh ]; then
            echo "Hydrating OCA repositories from lockfile..."
            bash scripts/oca_hydrate.sh --tier 4
          fi

      - name: Install Odoo and dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel

          # Install system dependencies for Odoo and C extension builds
          sudo apt-get install -y \
            build-essential \
            python3-dev \
            libpq-dev \
            libsasl2-dev \
            libldap2-dev \
            libssl-dev \
            libxml2-dev \
            libxslt1-dev \
            libjpeg-dev \
            libfreetype6-dev \
            liblcms2-dev \
            libwebp-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libxcb1-dev \
            libev-dev \
            libc-ares-dev \
            libffi-dev

          # Clone Odoo 18.0 from official repository
          git clone --depth 1 --branch 18.0 https://github.com/odoo/odoo.git /tmp/odoo

          # Pin Cython < 3.0 for gevent compatibility (Cython 3.x has stricter cdef exception handling)
          pip install "Cython<3.0"

          # Install gevent with pre-built wheel to avoid Cython compilation issues
          pip install --only-binary :all: gevent || pip install gevent

          # Install Odoo Python dependencies
          pip install -r /tmp/odoo/requirements.txt

          # Install testing and coverage tools
          pip install coverage pytest-cov

          # Install custom module requirements if exists
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: List addons
        run: |
          echo "Custom addons:"
          if [ -d addons ]; then
            ls -1 addons || true
          else
            echo "addons directory not found"
          fi
          echo ""
          echo "OCA addons:"
          if [ -d oca ]; then
            ls -1 oca || true
          else
            echo "oca directory not found (using OCA submodules in external-src instead)"
          fi

      - name: Run Odoo tests for custom modules
        run: |
          # Get list of installable modules from addons/
          MODULES=""
          if [ -d addons ]; then
            MODULES=$(find addons -name "__manifest__.py" -exec dirname {} \; | xargs -I {} basename {} | tr '\n' ',' | sed 's/,$//')
          fi

          if [ -z "$MODULES" ]; then
            echo "No modules found to test"
            exit 0
          fi

          echo "========================================="
          echo "Test Suite: ${{ matrix.test-suite.description }}"
          echo "Test Tags: ${{ matrix.test-suite.tags }}"
          echo "Testing modules: $MODULES"
          echo "========================================="

          # Build addons path dynamically (OCA monorepo structure - flattened)
          ADDONS_PATH="/tmp/odoo/addons"

          # Add IPAI modules
          if [ -d addons/ipai ]; then
            ADDONS_PATH="$ADDONS_PATH,addons/ipai"
          fi

          # Add OCA modules (flattened structure preferred, fallback to external-src)
          if [ -d addons/oca ] && [ "$(find addons/oca -maxdepth 1 -type d | wc -l)" -gt 1 ]; then
            # Use flattened OCA modules if populated
            ADDONS_PATH="$ADDONS_PATH,addons/oca"
          elif [ -d external-src ]; then
            # Fallback: enumerate external-src repos for source validation
            for subdir in external-src/*/; do
              if [ -d "$subdir" ]; then
                ADDONS_PATH="$ADDONS_PATH,$subdir"
              fi
            done
          fi

          # Prepare test command
          TEST_CMD="/tmp/odoo/scripts/odoo.sh -d $DB_NAME -i $MODULES --stop-after-init --log-level=test --test-enable --addons-path=$ADDONS_PATH"

          # Add test tags if specified
          if [ -n "${{ matrix.test-suite.tags }}" ]; then
            TEST_CMD="$TEST_CMD --test-tags=${{ matrix.test-suite.tags }}"
          fi

          # Run tests with coverage if this is the full test suite
          if [ "${{ matrix.test-suite.name }}" == "All Tests" ]; then
            echo "Running with coverage analysis..."
            coverage run --source=addons/ipai --omit='*/tests/*' /tmp/odoo/scripts/odoo.sh \
              -d "$DB_NAME" \
              -i "$MODULES" \
              --stop-after-init \
              --log-level=test \
              --test-enable \
              --addons-path="$ADDONS_PATH"

            # Generate coverage report
            echo ""
            echo "========================================="
            echo "Coverage Report"
            echo "========================================="
            coverage report -m
            coverage html -d coverage_html
          else
            # Run tests without coverage for faster execution
            eval $TEST_CMD
          fi

      - name: Upload coverage report
        if: matrix.test-suite.name == 'All Tests'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage_html/
          retention-days: 30

      - name: Comment coverage on PR
        if: matrix.test-suite.name == 'All Tests' && github.event_name == 'pull_request'
        run: |
          COVERAGE_PCT=$(coverage report | tail -1 | awk '{print $NF}')
          echo "Test coverage: $COVERAGE_PCT"
          # Coverage percentage can be used in PR comments if needed

  openupgrade-smoke:
    name: OpenUpgrade Smoke (optional)
    if: github.ref == 'refs/heads/18.0'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install OpenUpgrade tools
        run: |
          python -m pip install --upgrade pip
          pip install openupgradelib

      - name: Check migration scripts
        run: |
          if [ -d openupgrade_scripts ]; then
            echo "Found openupgrade_scripts; running import check..."
            python -m compileall openupgrade_scripts
          else
            echo "No openupgrade_scripts directory; skipping."
          fi

  performance:
    name: Performance Tests
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: preflight
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: odoo
          POSTGRES_PASSWORD: odoo
          POSTGRES_DB: odoo
        options: >-
          --health-cmd="pg_isready -U odoo"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
        ports: ["5432:5432"]

    env:
      PGHOST: localhost
      PGPORT: 5432
      PGUSER: odoo
      PGPASSWORD: odoo
      PGDATABASE: odoo

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          sudo apt-get update
          sudo apt-get install -y build-essential python3-dev libpq-dev libev-dev libc-ares-dev libffi-dev

          # Clone Odoo
          git clone --depth 1 --branch 18.0 https://github.com/odoo/odoo.git /tmp/odoo

          # Pin Cython < 3.0 for gevent compatibility
          pip install "Cython<3.0"

          # Install gevent with pre-built wheel to avoid Cython compilation issues
          pip install --only-binary :all: gevent || pip install gevent

          pip install -r /tmp/odoo/requirements.txt

          # Install performance testing tools
          pip install locust psutil memory_profiler

      - name: Module installation performance test
        run: |
          echo "========================================="
          echo "Performance Test: Module Installation"
          echo "========================================="

          MODULES=""
          if [ -d addons ]; then
            MODULES=$(find addons -name "__manifest__.py" -exec dirname {} \; | xargs -I {} basename {} | tr '\n' ',' | sed 's/,$//')
          fi

          if [ -z "$MODULES" ]; then
            echo "No modules found to test"
            exit 0
          fi

          # Build addons path dynamically
          ADDONS_PATH="/tmp/odoo/addons,addons"
          if [ -d oca ]; then
            ADDONS_PATH="$ADDONS_PATH,oca"
          fi
          if [ -d external-src ]; then
            for subdir in external-src/*/; do
              if [ -d "$subdir" ]; then
                ADDONS_PATH="$ADDONS_PATH,$subdir"
              fi
            done
          fi

          # Time the installation
          START_TIME=$(date +%s)

          /tmp/odoo/scripts/odoo.sh \
            -d "$DB_NAME" \
            -i "$MODULES" \
            --stop-after-init \
            --log-level=warn \
            --addons-path="$ADDONS_PATH"

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))

          echo ""
          echo "========================================="
          echo "Performance Results"
          echo "========================================="
          echo "Module installation took: ${DURATION} seconds"
          echo "Modules tested: $MODULES"

          # Warn if installation takes too long
          if [ $DURATION -gt 300 ]; then
            echo "::warning::Module installation took longer than 5 minutes (${DURATION}s)"
          fi

      - name: Database size check
        run: |
          echo "========================================="
          echo "Database Size Analysis"
          echo "========================================="

          psql -h localhost -U odoo -d odoo -c "
            SELECT
              pg_size_pretty(pg_database_size('odoo')) as database_size,
              pg_size_pretty(pg_total_relation_size('ir_model')) as ir_model_size;
          "

  repo-structure:
    name: Repository Structure Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install tree command
        run: sudo apt-get update && sudo apt-get install -y tree

      - name: Regenerate repo tree
        run: |
          if [ -f scripts/gen_repo_tree.sh ]; then
            ./scripts/gen_repo_tree.sh
          else
            echo "No gen_repo_tree.sh script found; skipping."
          fi

      - name: Check if repo tree is up to date
        run: |
          if [ -f spec.md ]; then
            if ! git diff --quiet spec.md; then
              echo "::warning::Repo tree in spec.md is out of date. Run ./scripts/gen_repo_tree.sh and commit."
              echo "Expected diff:"
              git diff spec.md
            else
              echo "✅ Repo tree is up to date"
            fi
          else
            echo "No spec.md found; skipping tree check."
          fi
