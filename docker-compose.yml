# Smart Delta 3-Edition Odoo CE Deployment
# Core, Marketing, Accounting editions share Postgres but have different module sets
#
# Extended Platform Configuration:
# - OCA modules mounted from ./addons/oca/
# - IPAI modules mounted from ./addons/ipai/
# - Use profiles for tiered initialization

version: '3.8'

services:
  # ===== SHARED POSTGRES =====
  postgres:
    image: postgres:15-alpine
    container_name: odoo-postgres
    environment:
      POSTGRES_USER: odoo
      POSTGRES_PASSWORD: odoo
      POSTGRES_DB: postgres
    volumes:
      - odoo-postgres-data:/var/lib/postgresql/data
    networks:
      - odoo-network
    restart: unless-stopped

  # ===== CORE EDITION (Port 8069) =====
  # Init service - CE Core Modules (one-time installation of all CE modules)
  odoo-core-ce-init:
    image: odoo:18.0
    container_name: odoo-core-ce-init
    depends_on:
      - postgres
    environment:
      - HOST=postgres
      - USER=odoo
      - PASSWORD=odoo
      - DB_NAME=odoo_core
    volumes:
      - ./addons/ipai:/mnt/extra-addons/ipai:ro
      - ./addons/oca:/mnt/extra-addons/oca:ro
      - odoo-core-web-data:/var/lib/odoo
    # Install all CE core modules in dependency order
    command: >
      odoo -d odoo_core -i
      base,web,base_setup,base_import,bus,mail,digest,iap,web_tour,web_editor,portal,resource,calendar,
      contacts,sales_team,crm,sale,sale_management,sale_crm,
      analytic,account,account_payment,
      purchase,purchase_requisition,
      stock,stock_account,stock_landed_costs,stock_picking_batch,
      sale_stock,sale_purchase,purchase_stock,
      mrp,maintenance,
      project,project_todo,hr_timesheet,sale_timesheet,
      hr,hr_contract,hr_holidays,hr_attendance,hr_expense,hr_recruitment,hr_skills,
      website,website_sale,website_crm,website_blog,website_forum,website_slides,website_event,
      mass_mailing,im_livechat,
      point_of_sale,
      survey,lunch,fleet,repair
      --stop-after-init
    networks:
      - odoo-network
    restart: "no"
    profiles: ["ce-init"]

  # Init service - IPAI custom modules (after CE modules are installed)
  odoo-core-init:
    image: odoo:18.0
    container_name: odoo-core-init
    depends_on:
      - postgres
    environment:
      - HOST=postgres
      - USER=odoo
      - PASSWORD=odoo
      - DB_NAME=odoo_core
    volumes:
      - ./addons/ipai:/mnt/extra-addons/ipai:ro
      - ./addons/oca:/mnt/extra-addons/oca:ro
      - odoo-core-web-data:/var/lib/odoo
    command: ["odoo", "-d", "odoo_core", "-i", "ipai_dev_studio_base,ipai_workspace_core,ipai_ce_branding", "--stop-after-init"]
    networks:
      - odoo-network
    restart: "no"
    profiles: ["init"]

  # Init service - Extended Platform OCA modules
  odoo-core-extended-init:
    image: odoo:18.0
    container_name: odoo-core-extended-init
    depends_on:
      - postgres
    environment:
      - HOST=postgres
      - USER=odoo
      - PASSWORD=odoo
      - DB_NAME=odoo_core
    volumes:
      - ./addons/ipai:/mnt/extra-addons/ipai:ro
      - ./addons/oca:/mnt/extra-addons/oca:ro
      - odoo-core-web-data:/var/lib/odoo
    # Phase 1-4: Foundation + UX + Queue + Reporting
    command: >
      odoo -d odoo_core -i
      base_view_inheritance_extension,auditlog,date_range,
      web_responsive,web_dialog_size,
      queue_job,
      report_xlsx,mis_builder,account_financial_report,
      spreadsheet_oca,spreadsheet_dashboard_oca,
      base_rest,
      mail_activity_board,mail_debrand,
      ipai_design_system_apps_sdk,ipai_ask_ai,ipai_command_center
      --stop-after-init
    networks:
      - odoo-network
    restart: "no"
    profiles: ["extended-init"]

  # Runtime service (normal operation)
  odoo-core:
    image: odoo:18.0
    container_name: odoo-core
    depends_on:
      - postgres
    ports:
      - "8069:8069"
    environment:
      - HOST=postgres
      - USER=odoo
      - PASSWORD=odoo
      - DB_NAME=odoo_core
    volumes:
      - ./addons/ipai:/mnt/extra-addons/ipai:ro
      - ./addons/oca:/mnt/extra-addons/oca:ro
      - odoo-core-web-data:/var/lib/odoo
      - ./config/odoo-core.conf:/etc/odoo/odoo.conf:ro
    command: ["odoo", "-d", "odoo_core", "--proxy-mode"]
    dns:
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - odoo-network
    restart: unless-stopped

  # ===== MARKETING EDITION (Port 8070) =====
  # Init service (one-time module installation)
  odoo-marketing-init:
    image: odoo:18.0
    container_name: odoo-marketing-init
    depends_on:
      - postgres
    environment:
      - HOST=postgres
      - USER=odoo
      - PASSWORD=odoo
      - DB_NAME=odoo_marketing
    volumes:
      - ./addons/ipai:/mnt/extra-addons/ipai:ro
      - ./addons/oca:/mnt/extra-addons/oca:ro
      - odoo-marketing-web-data:/var/lib/odoo
    command: ["odoo", "-d", "odoo_marketing", "-i", "ipai_dev_studio_base,ipai_workspace_core,ipai_ce_branding,ipai_industry_marketing_agency", "--stop-after-init"]
    networks:
      - odoo-network
    restart: "no"
    profiles: ["init"]

  # Runtime service (normal operation)
  odoo-marketing:
    image: odoo:18.0
    container_name: odoo-marketing
    depends_on:
      - postgres
    ports:
      - "8070:8069"
    environment:
      - HOST=postgres
      - USER=odoo
      - PASSWORD=odoo
      - DB_NAME=odoo_marketing
    volumes:
      - ./addons/ipai:/mnt/extra-addons/ipai:ro
      - ./addons/oca:/mnt/extra-addons/oca:ro
      - odoo-marketing-web-data:/var/lib/odoo
    command: ["odoo", "-d", "odoo_marketing"]
    dns:
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - odoo-network
    restart: unless-stopped

  # ===== ACCOUNTING EDITION (Port 8071) =====
  # Init service (one-time module installation)
  odoo-accounting-init:
    image: odoo:18.0
    container_name: odoo-accounting-init
    depends_on:
      - postgres
    environment:
      - HOST=postgres
      - USER=odoo
      - PASSWORD=odoo
      - DB_NAME=odoo_accounting
    volumes:
      - ./addons/ipai:/mnt/extra-addons/ipai:ro
      - ./addons/oca:/mnt/extra-addons/oca:ro
      - odoo-accounting-web-data:/var/lib/odoo
    command: ["odoo", "-d", "odoo_accounting", "-i", "ipai_dev_studio_base,ipai_workspace_core,ipai_ce_branding,ipai_industry_accounting_firm", "--stop-after-init"]
    networks:
      - odoo-network
    restart: "no"
    profiles: ["init"]

  # Runtime service (normal operation)
  odoo-accounting:
    image: odoo:18.0
    container_name: odoo-accounting
    depends_on:
      - postgres
    ports:
      - "8071:8069"
    environment:
      - HOST=postgres
      - USER=odoo
      - PASSWORD=odoo
      - DB_NAME=odoo_accounting
    volumes:
      - ./addons/ipai:/mnt/extra-addons/ipai:ro
      - ./addons/oca:/mnt/extra-addons/oca:ro
      - odoo-accounting-web-data:/var/lib/odoo
    command: ["odoo", "-d", "odoo_accounting"]
    dns:
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - odoo-network
    restart: unless-stopped

volumes:
  odoo-postgres-data:
  odoo-core-web-data:
  odoo-marketing-web-data:
  odoo-accounting-web-data:

networks:
  odoo-network:
    driver: bridge
