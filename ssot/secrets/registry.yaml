# schema: ssot.secrets.v1
# Single source of truth for secret IDENTIFIERS used by InsightPulse AI.
#
# This file tracks:
#   - Secret names (not values)
#   - Purpose and scope
#   - Approved storage locations
#   - Which files/services consume each secret
#
# NEVER include secret values in this file.
# Values live in: macOS Keychain, GitHub Actions Secrets, Supabase Vault, Vercel env vars
#
# Workflow: docs/runbooks/SECRETS_SSOT.md

version: "1.0.0"
schema: ssot.secrets.v1
last_reviewed: "2026-02-27"

schema_rules:
  required_fields:
    - purpose
    - approved_stores
    - consumers
  consumer_format: "store:identifier"
  consumer_stores:
    - github_actions
    - vercel_env
    - supabase_vault
    - os_keychain
    - odoo_config_parameter
    - terraform          # infra/cloudflare/** Terraform configs
    - scripts            # scripts/infra/** automation scripts
    - acme_sh            # acme.sh DNS-01 cert issuance (reads CF_Key + CF_Email)

secrets:
  cf_dns_read_token:
    purpose: "Cloudflare DNS Zone:Read — CI drift gate"
    approved_stores:
      - github_actions
    github_secret_name: CF_DNS_READ_TOKEN
    consumers:
      - github_actions:.github/workflows/cloudflare-dns-drift.yml
      - github_actions:.github/workflows/domain-lint.yml
    rotation_policy: "Annually or on team member offboarding"
    notes: "Read-only token. Minimal blast radius."

  cf_dns_edit_token:
    purpose: "Cloudflare DNS Zone:Edit — Terraform apply via CI"
    approved_stores:
      - github_actions
    github_secret_name: CF_DNS_EDIT_TOKEN
    consumers:
      - github_actions:infra/cloudflare/envs/prod/
      - github_actions:.github/workflows/dns-ssot-apply.yml
    rotation_policy: "Annually or on team member offboarding"
    notes: "Edit-scoped token. Only used by Terraform apply workflow."

  zoho_client_id:
    purpose: "Zoho Mail API OAuth2 client ID"
    approved_stores:
      - os_keychain
      - supabase_vault
    vault_secret_name: zoho_client_id
    consumers:
      - supabase_vault:zoho_client_id
      - odoo_config_parameter:addons/ipai/ipai_zoho_mail_api/
    rotation_policy: "On Zoho app credential reset"
    notes: "Pair with zoho_client_secret and zoho_refresh_token."

  zoho_client_secret:
    purpose: "Zoho Mail API OAuth2 client secret"
    approved_stores:
      - os_keychain
      - supabase_vault
    vault_secret_name: zoho_client_secret
    consumers:
      - supabase_vault:zoho_client_secret
      - odoo_config_parameter:addons/ipai/ipai_zoho_mail_api/
    rotation_policy: "On Zoho app credential reset"
    notes: "Pair with zoho_client_id and zoho_refresh_token."

  zoho_refresh_token:
    purpose: "Zoho Mail API OAuth2 long-lived refresh token"
    approved_stores:
      - os_keychain
      - supabase_vault
    vault_secret_name: zoho_refresh_token
    consumers:
      - supabase_vault:zoho_refresh_token
      - odoo_config_parameter:addons/ipai/ipai_zoho_mail_api/
    rotation_policy: "Every 6 months or when access is revoked"
    notes: "Used to obtain short-lived access tokens. Rotate proactively."

  supabase_service_role_key:
    purpose: "Supabase service role key (full RLS bypass — use sparingly)"
    approved_stores:
      - os_keychain
      - github_actions
    github_secret_name: SUPABASE_SERVICE_ROLE_KEY
    consumers:
      - github_actions:SUPABASE_SERVICE_ROLE_KEY
      - os_keychain:local-dev
    rotation_policy: "Quarterly or on team member offboarding"
    notes: "Bypasses all RLS. Scope usage to CI/migration scripts only."

  supabase_anon_key:
    purpose: "Supabase anonymous key (public — safe to expose client-side)"
    approved_stores:
      - os_keychain
      - vercel_env
    vercel_env_name: NEXT_PUBLIC_SUPABASE_ANON_KEY
    consumers:
      - vercel_env:apps/ops-console
      - os_keychain:local-dev
    rotation_policy: "On Supabase project reset only"
    notes: "Public key — low sensitivity. Subject to RLS policies."

  gemini_api_key:
    purpose: "Google Gemini API key — Ops Console AI route (/api/ai/gemini)"
    approved_stores:
      - github_actions
      - vercel_env
    github_secret_name: GEMINI_API_KEY
    vercel_env_name: GEMINI_API_KEY
    consumers:
      - vercel_env:apps/ops-console
      - vercel_env:platform/ai/providers/gemini
      - github_actions:GEMINI_API_KEY
    rotation_policy: "Annually or on security incident"
    notes: "Required for Gemini bridge. Set in Vercel env vars for ops-console deployment."

  slack_bot_token:
    purpose: "Slack bot token for ipai_slack_connector notifications"
    approved_stores:
      - os_keychain
      - supabase_vault
    vault_secret_name: slack_bot_token
    consumers:
      - supabase_vault:slack_bot_token
      - odoo_config_parameter:addons/ipai/ipai_slack_connector/
    rotation_policy: "On Slack app reinstallation or security incident"
    notes: "xoxb- prefix token. Scopes: chat:write, channels:read."

  slack_signing_secret:
    purpose: "Slack signing secret for webhook verification"
    approved_stores:
      - os_keychain
      - supabase_vault
    vault_secret_name: slack_signing_secret
    consumers:
      - supabase_vault:slack_signing_secret
      - odoo_config_parameter:addons/ipai/ipai_slack_connector/
    rotation_policy: "On Slack app reinstallation or security incident"
    notes: "Used to verify that webhook payloads come from Slack."

  github_token:
    purpose: "GitHub PAT for API access (repo operations, workflow triggers)"
    approved_stores:
      - os_keychain
      - github_actions
    github_secret_name: GITHUB_TOKEN
    consumers:
      - github_actions:GITHUB_TOKEN
      - os_keychain:local-dev
    rotation_policy: "Annually or on team member offboarding"
    notes: "Use fine-grained PAT scoped to this repo only."

  do_access_token:
    purpose: "DigitalOcean API token — App Platform + Droplet management"
    approved_stores:
      - os_keychain
      - github_actions
    github_secret_name: DO_ACCESS_TOKEN
    consumers:
      - github_actions:DO_ACCESS_TOKEN
      - os_keychain:local-dev
    rotation_policy: "Annually or on team member offboarding"
    notes: "Scoped to fin-workspace project where possible."

  anthropic_api_key:
    purpose: "Anthropic Claude API key — Odoo LLM provider + SoW workspace-ask-docs Edge Function"
    approved_stores:
      - odoo_config_parameter
      - supabase_vault
      - os_keychain
    consumers:
      - odoo_config_parameter:anthropic.api_key
      - supabase_vault:ANTHROPIC_API_KEY          # workspace-ask-docs Edge Function (primary LLM)
      - os_keychain:local-dev
    rotation_policy: "Annually or on API key compromise"
    notes: >
      Used by:
        1. llm_anthropic Odoo provider module (Apexive, ported to 19.0) — Odoo Settings → LLM → Providers.
        2. supabase/functions/workspace-ask-docs — SoW RAG answer generation (preferred provider).
           Returns 503 KEY_MISSING if absent and OPENAI_API_KEY is also absent.
      Key must support Claude 4.5/4.6 family (claude-sonnet-4-6, claude-opus-4-6).
      Never commit to git; never inject via Dockerfile ENV in tracked compose files.
      SSOT ref: ssot/secrets/registry.yaml#anthropic_api_key
      See: spec/ipai-llm-supabase-bridge/, docs/architecture/SOW_BOUNDARY.md

  openai_api_key:
    purpose: "OpenAI API key — workspace embedding (text-embedding-3-small) + LLM fallback"
    approved_stores:
      - supabase_vault
    consumers:
      - supabase_vault:OPENAI_API_KEY
    rotation_policy: "Annually or on API key compromise"
    notes: >
      Single Vault secret consumed by two SoW Edge Functions:
        1. supabase/functions/workspace-indexer — generates text-embedding-3-small vectors
           (1536 dims) for work.search_index. Indexing proceeds without vectors if key absent.
        2. supabase/functions/workspace-ask-docs — pgvector similarity search + GPT-4o-mini fallback
           if ANTHROPIC_API_KEY is absent. If both keys absent, function returns 503 KEY_MISSING.
      Embedding model: text-embedding-3-small (1536 dims, matches work.search_index.embedding column).
      NOT consumed by apps/workspace (Vercel) — workspace app routes through the Edge Function proxy.
      SSOT ref: ssot/secrets/registry.yaml#openai_api_key
      See: docs/architecture/SOW_BOUNDARY.md

  llm_bridge_webhook_secret:
    purpose: "HMAC-SHA256 shared secret for ipai_llm_supabase_bridge webhook signing"
    approved_stores:
      - supabase_vault
      - odoo_config_parameter
    consumers:
      - supabase_vault:LLM_BRIDGE_WEBHOOK_SECRET
      - odoo_config_parameter:ipai_llm_supabase_bridge.webhook_secret
    rotation_policy: "Rotate on team member offboarding or suspected exposure"
    notes: >
      Must be identical on both sides: Supabase Edge Function reads from Vault;
      Odoo bridge reads from ir.config_parameter (set via Settings UI).
      Minimum 32 random bytes (base64 or hex). Generate with:
        python3 -c "import secrets; print(secrets.token_hex(32))"
      See: spec/ipai-llm-supabase-bridge/

  # ---------------------------------------------------------------------------
  # Cloudflare infra credentials (DNS automation, cert issuance)
  # scope: infra — NOT for runtime app use. See storage_policy below.
  # ---------------------------------------------------------------------------
  cloudflare_global_api_key:
    purpose: >
      Cloudflare Global API Key (37-char hex, email+key auth) used for
      acme.sh DNS-01 cert issuance and ad-hoc Cloudflare API operations.
      Used as CF_Key (acme.sh) and TF_VAR_cloudflare_api_token (Terraform local).
    scope: infra
    approved_stores:
      - os_keychain
      - github_actions
    github_secret_name: CF_GLOBAL_API_KEY
    os_keychain_service: cloudflare-global-api-key
    os_keychain_account: default
    storage_policy:
      local: os_keychain   # load via scripts/infra/load_cloudflare_env.sh
      ci: github_actions_secret
      runtime: prohibited
    prohibited_consumers:
      - supabase_vault     # infra key — not for runtime Edge Function use
      - odoo_config_parameter  # Odoo must never call CF DNS APIs directly
      - vercel_env         # not a runtime secret
    consumers:
      - os_keychain:local-dev  # loaded by scripts/infra/load_cloudflare_env.sh
      - github_actions:CF_GLOBAL_API_KEY
      - scripts:scripts/infra/load_cloudflare_env.sh
      - acme_sh:CF_Key  # acme.sh reads CF_Key + CF_Email env vars for DNS-01
    rotation_policy: "Annually or on team member offboarding"
    notes: >
      Pair with CF_Email (Jgtolentino.rn@gmail.com) when authenticating via
      X-Auth-Key / X-Auth-Email headers. For new tooling prefer a scoped
      API token (cf_dns_edit_token) over the global key where possible.
      Load locally with:
        source scripts/infra/load_cloudflare_env.sh

  cloudflare_zone_id:
    purpose: >
      Cloudflare Zone ID for insightpulseai.com (73f587aee652fc24fd643aec00dcca81).
      Not a secret per se, but stored alongside API credentials to keep infra
      config out of source code.
    scope: infra
    approved_stores:
      - os_keychain
      - github_actions
    github_secret_name: CF_DNS_ZONE_ID
    os_keychain_service: cloudflare-zone-id
    os_keychain_account: insightpulseai.com
    storage_policy:
      local: os_keychain
      ci: github_actions_secret
      runtime: prohibited
    prohibited_consumers:
      - supabase_vault
      - odoo_config_parameter
    consumers:
      - github_actions:.github/workflows/cloudflare-dns-apply.yml
      - github_actions:.github/workflows/dns-ssot-apply.yml
      - terraform:infra/cloudflare/envs/prod/
      - scripts:scripts/infra/load_cloudflare_env.sh
    rotation_policy: "Static — only changes if domain is moved to a new CF account"
    notes: >
      Zone ID is readable from the Cloudflare dashboard Overview page.
      Treat as semi-sensitive: not a credential but uniquely identifies
      the zone and should not appear in public PR descriptions or logs.

  # ---------------------------------------------------------------------------
  # Email SMTP credentials (Zoho Mail bridge)
  # scope: runtime — consumed by Odoo SMTP configuration and ipai_mail_bridge_zoho
  # ---------------------------------------------------------------------------
  zoho_smtp_user:
    purpose: "Zoho Mail SMTP username (e.g. noreply@insightpulseai.com) for Odoo outbound email"
    scope: runtime
    approved_stores:
      - odoo_config_parameter
      - os_keychain
    consumers:
      - odoo_config_parameter:ir.mail_server.smtp_user
      - os_keychain:local-dev
    rotation_policy: "On Zoho mail account change or security incident"
    notes: >
      Used by the ipai_mail_bridge_zoho module to authenticate outbound SMTP.
      Pair with zoho_smtp_app_password.
      Set in Odoo Settings → Technical → Outgoing Mail Servers.
      Referenced in ssot/runtime/prod_settings.yaml.

  zoho_smtp_app_password:
    purpose: "Zoho Mail SMTP app-specific password for Odoo outbound email (not the account password)"
    scope: runtime
    approved_stores:
      - odoo_config_parameter
      - os_keychain
    consumers:
      - odoo_config_parameter:ir.mail_server.smtp_pass
      - os_keychain:local-dev
    rotation_policy: "Annually or on security incident — generate from Zoho Security → App Passwords"
    notes: >
      Must be an app-specific password, NOT the Zoho account login password.
      Generate in Zoho Mail → Settings → Security → App Passwords.
      Pair with zoho_smtp_user. Referenced in ssot/runtime/prod_settings.yaml.

  # ---------------------------------------------------------------------------
  # OCR microservice credentials
  # scope: runtime — consumed by Odoo OCR bridge module
  # ---------------------------------------------------------------------------
  supabase_management_token:
    purpose: "Supabase Management API Personal Access Token (PAT) — used by CI to verify runtime auth config (MFA state, project settings)"
    scope: infra
    approved_stores:
      - github_actions
      - os_keychain
    github_secret_name: SUPABASE_MANAGEMENT_TOKEN
    os_keychain_service: supabase-management-token
    storage_policy:
      local: os_keychain
      ci: github_actions_secret
      runtime: prohibited
    prohibited_consumers:
      - odoo_config_parameter
      - supabase_vault
    consumers:
      - github_actions:.github/workflows/prod-mfa-runtime-gate.yml
      - os_keychain:local-dev
    rotation_policy: "Annually or on team member offboarding"
    notes: >
      sbp_... format PAT. Used exclusively for read-only Management API calls
      (GET /v1/projects/{ref}/config/auth). Requires project ref SUPABASE_PROJECT_REF.
      Generate in Supabase Dashboard → Account → Access Tokens.
      Distinct from supabase_service_role_key (project-level key vs account-level PAT).

  stripe_secret_key:
    purpose: "Stripe secret API key for server-side use (Supabase Stripe FDW + Edge Functions). ROTATE if exposed."
    scope: runtime
    approved_stores:
      - supabase_vault
      - os_keychain
    vault_secret_name: stripe_secret_key
    storage_policy:
      local: os_keychain
      ci: supabase_vault
      runtime: supabase_vault
    prohibited_consumers:
      - odoo_config_parameter  # Odoo does not call Stripe directly
      - github_actions          # Never inject Stripe secret keys into CI env
    consumers:
      - supabase_vault:stripe_secret_key   # consumed by Stripe FDW server (api_key_id)
    rotation_policy: "Immediately on exposure; quarterly for live keys; on team member offboarding"
    notes: >
      sk_test_... (test) | sk_live_... (prod — required when payments.stripe.mode=live).
      Store in Supabase Vault; FDW references via api_key_id (UUID), never the raw key.
      Rotate in Stripe Dashboard → API Keys → Roll key. Update Vault secret after rotation.
      See: ssot/runtime/prod_settings.yaml payments.stripe.secrets.secret_key

  stripe_webhook_signing_secret:
    purpose: "Stripe webhook signing secret (whsec_...) for Edge Function signature verification"
    scope: runtime
    approved_stores:
      - supabase_vault
      - os_keychain
    vault_secret_name: stripe_webhook_signing_secret
    storage_policy:
      local: os_keychain
      ci: supabase_vault
      runtime: supabase_vault
    prohibited_consumers:
      - odoo_config_parameter
      - github_actions
    consumers:
      - supabase_vault:stripe_webhook_signing_secret   # consumed by supabase/functions/stripe-webhook/
    rotation_policy: "On webhook endpoint rotation or signing secret regeneration in Stripe Dashboard"
    notes: >
      whsec_... format. Obtained from: Stripe Dashboard → Webhooks → endpoint → Signing secret.
      Used by Supabase Edge Function to verify Stripe event signatures via
      stripe.webhooks.constructEvent. Separate from stripe_secret_key — rotate independently.
      See: ssot/runtime/prod_settings.yaml payments.stripe.secrets.webhook_signing_secret

  stripe_publishable_key:
    purpose: "Stripe publishable key (pk_live_... or pk_test_...) for client-side Stripe.js / checkout"
    scope: runtime
    approved_stores:
      - supabase_vault
      - vercel_env
      - os_keychain
    vault_secret_name: stripe_publishable_key
    vercel_env_name: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
    storage_policy:
      local: os_keychain
      ci: vercel_env
      runtime: vercel_env   # safe to expose to browser; still centralized via Vault/env
    prohibited_consumers:
      - odoo_config_parameter
    consumers:
      - vercel_env:apps/ops-console
      - supabase_vault:stripe_publishable_key
    rotation_policy: "On Stripe account compromise or key rollover"
    notes: >
      pk_test_... (test) | pk_live_... (prod). Safe to expose in browser / client-side JS.
      Must match the mode of stripe_secret_key (both test or both live — never mix).
      Set as NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY in Vercel for ops-console.
      See: ssot/runtime/prod_settings.yaml payments.stripe.public.publishable_key_ref

  ocr_bridge_token:
    purpose: "Shared bearer token for Odoo → PaddleOCR microservice authentication"
    scope: runtime
    approved_stores:
      - odoo_config_parameter
      - os_keychain
    consumers:
      - odoo_config_parameter:ipai_ocr_bridge.bridge_token
      - os_keychain:local-dev
    rotation_policy: "Rotate on team member offboarding or suspected exposure"
    notes: >
      Used by the OCR bridge module to authenticate requests to ocr.insightpulseai.com.
      Minimum 32 random bytes. Generate with:
        python3 -c "import secrets; print(secrets.token_hex(32))"
      Set as BEARER_TOKEN env var on the ocr-prod container and as
      ir.config_parameter in Odoo. Referenced in ssot/runtime/prod_settings.yaml.
