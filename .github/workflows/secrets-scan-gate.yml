name: Secrets Scan Gate

# =============================================================================
# Scans changed files for plaintext secrets (tokens, passwords, private keys).
#
# Policy: Only env var refs, GitHub Secrets refs, and Supabase Vault refs are
# permitted. No hardcoded credentials anywhere in tracked files.
#
# Scanner: scripts/check_no_plaintext_secrets.py
# Policy doc: docs/runbooks/SECRETS_SSOT.md
# Identifier SSOT: ssot/secrets/registry.yaml
# Allowlist SSOT: ssot/secrets/allowlist_regex.txt
#
# Output format: path:line:SEVERITY:pattern-id (grep-compatible)
# =============================================================================

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main
  merge_group:

permissions:
  contents: read
  pull-requests: write

jobs:
  secrets-scan:
    name: Scan for plaintext secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full depth for diff)
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Run secrets scanner
        id: scan
        run: |
          python3 scripts/check_no_plaintext_secrets.py --diff \
            2>&1 | tee /tmp/secrets_scan.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
          # Emit stable annotations for inline PR review
          grep -E "^[^[:space:]].+:[0-9]+:(CRITICAL|HIGH|MEDIUM|LOW):" /tmp/secrets_scan.log | \
            while IFS=: read -r file line severity rest; do
              echo "::error file=${file},line=${line}::${severity}: ${rest}"
            done || true
        continue-on-error: true

      - name: Post PR comment if secrets detected
        if: steps.scan.outputs.exit_code != '0' && github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LOG=$(head -c 3000 /tmp/secrets_scan.log 2>/dev/null || echo "Log unavailable")
          {
            echo '## Secrets Scan Gate - FAILED'
            echo ''
            echo 'Potential plaintext secrets were detected in changed files.'
            echo ''
            echo '### What to do'
            echo ''
            echo '1. **Remove** the secret value from the file'
            echo '2. **Store** it in an approved location:'
            echo '   - Local dev: OS keychain (macOS Keychain / GNOME Keyring)'
            echo '   - CI: GitHub Actions Secret (`${{ secrets.NAME }}`)'
            echo '   - Platform/automation: Supabase Vault (`vault_secret_name: <key>`)'
            echo '3. **Reference** only the name/identifier in code and config'
            echo '4. **Rotate** any secret that was committed (even briefly)'
            echo ''
            echo '### Reference'
            echo ''
            echo '- Policy: `docs/runbooks/SECRETS_SSOT.md`'
            echo '- Registry: `ssot/secrets/registry.yaml`'
            echo '- False-positive allowlist: `ssot/secrets/allowlist_regex.txt`'
            echo ''
            echo '---'
            echo '*Scanner output:*'
            echo '```'
            echo "$LOG"
            echo '```'
          } > /tmp/secrets_comment.md
          gh pr comment "${{ github.event.pull_request.number }}" --body-file /tmp/secrets_comment.md

      - name: Fail on detected secrets
        if: steps.scan.outputs.exit_code != '0'
        run: |
          cat /tmp/secrets_scan.log
          echo "::error::Plaintext secrets detected. Remove credentials and use approved secret stores."
          echo "::error::See docs/runbooks/SECRETS_SSOT.md for policy."
          exit 1

      - name: Pass
        if: steps.scan.outputs.exit_code == '0'
        run: |
          echo "âœ… No plaintext secrets detected."
