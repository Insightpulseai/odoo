name: Branch Hygiene — Auto-prune stale agent branches

# Safety contract:
#   - schedule → ALWAYS dry-run (observe + report only; never deletes)
#   - workflow_dispatch dry_run=false → requires confirm="YES" to delete
#   - merge_group → does NOT run (no write ops needed at merge time)
#
# SSOT: ssot/policy/branch_hygiene.yaml
# Script: scripts/ci/branch_hygiene.py
# Report: reports/ci/branch_hygiene_report.json (artifact uploaded on every run)

on:
  schedule:
    # Nightly at 03:00 UTC (11:00 Asia/Manila) — report-only mode
    - cron: "0 3 * * *"
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run — log only, do not delete (always true for scheduled runs)"
        type: boolean
        required: true
        default: true
      confirm:
        description: "Type YES to allow deletions when dry_run=false (safety double-lock)"
        type: string
        required: false
        default: ""
      older_than_days:
        description: "Treat branches older than N days as stale (default: 14)"
        type: number
        required: false
        default: 14
      comment:
        description: "Post a job-summary comment after run (dispatch only)"
        type: boolean
        required: false
        default: false

# Minimal permissions — only write for actual deletes; reads for audit
permissions:
  contents: write      # Required only when dry_run=false + confirm=YES
  pull-requests: read  # Required to check for open PRs before any action

jobs:
  prune-stale-branches:
    name: Prune stale agent branches
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run branch hygiene
        id: prune
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          # Scheduled runs are ALWAYS dry-run at the workflow layer (first lock)
          DRY_RUN: >-
            ${{ github.event_name == 'schedule' && 'true'
                || (inputs.dry_run == true && 'true' || 'false') }}
          # Confirm token passed through; script validates it (second lock)
          CONFIRM: >-
            ${{ github.event_name == 'schedule' && ''
                || inputs.confirm }}
          MAX_AGE_DAYS: >-
            ${{ github.event_name == 'schedule' && '14'
                || inputs.older_than_days }}
        run: |
          mkdir -p reports/ci
          python3 scripts/ci/branch_hygiene.py \
            --dry-run="${DRY_RUN}" \
            --confirm="${CONFIRM}" \
            --max-age-days="${MAX_AGE_DAYS}"

      - name: Upload report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          # Stable artifact name (not run-number-suffixed) so dashboards can query it
          name: branch-hygiene-report
          path: reports/ci/branch_hygiene_report.json
          retention-days: 30
          overwrite: true
          if-no-files-found: warn

      - name: Write job summary
        if: always()
        env:
          REPORT: reports/ci/branch_hygiene_report.json
        run: |
          if [ ! -f "${REPORT}" ]; then
            echo "## Branch Hygiene — no report generated" >> "${GITHUB_STEP_SUMMARY}"
            exit 0
          fi
          python3 - <<'PYEOF'
          import json, os

          report_path = os.environ["REPORT"]
          summary_path = os.environ["GITHUB_STEP_SUMMARY"]

          with open(report_path) as f:
              r = json.load(f)

          dry = r.get("dry_run", True)
          label = "Would delete" if dry else "Deleted"
          mode_str = "**Report-only (dry run)** — no branches were deleted" \
                     if dry else "**Live** — branches were deleted"

          lines = [
              "## Branch Hygiene Run\n",
              f"Mode: {mode_str}  ",
              f"Max age: {r.get('max_age_days', '?')} days\n",
              "| Metric | Count |",
              "|--------|-------|",
              f"| {label} | {len(r['deleted'])} |",
              f"| Skipped (open PR) | {len(r['skipped_open_pr'])} |",
              f"| Skipped (protected) | {len(r['skipped_other'])} |",
              f"| Skipped (too new) | {len(r['skipped_too_new'])} |",
              f"| Errors | {len(r['errors'])} |",
              "",
          ]

          if r["deleted"]:
              lines.append(f"### {label}\n")
              for b in r["deleted"]:
                  lines.append(f"- `{b['name']}` (age: {b.get('age_days', '?')}d)")
              lines.append("")

          if r["errors"]:
              lines.append("### Errors\n")
              for e in r["errors"]:
                  lines.append(f"- `{e['name']}`: {e['error']}")
              lines.append("")

          with open(summary_path, "a") as f:
              f.write("\n".join(lines) + "\n")
          PYEOF
