name: Deploy Supabase Secrets

on:
  workflow_dispatch:  # Manual trigger only (security)
  push:
    paths:
      - 'scripts/supabase/set_edge_secrets.sh'
      - 'scripts/supabase/configure_auth_*.sh'
      - '.github/workflows/supabase-secrets-deploy.yml'

jobs:
  deploy-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq python3

      - name: Deploy Edge Secrets
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OCR_BASE_URL: ${{ secrets.OCR_BASE_URL }}
          OCR_API_KEY: ${{ secrets.OCR_API_KEY }}
          N8N_BASE_URL: ${{ secrets.N8N_BASE_URL }}
          SUPERSET_BASE_URL: ${{ secrets.SUPERSET_BASE_URL }}
          MCP_BASE_URL: ${{ secrets.MCP_BASE_URL }}
        run: ./scripts/supabase/set_edge_secrets.sh

      - name: Configure Auth SMTP and URLs
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          AUTH_SITE_URL: ${{ secrets.AUTH_SITE_URL }}
          AUTH_ADDITIONAL_REDIRECT_URLS: ${{ secrets.AUTH_ADDITIONAL_REDIRECT_URLS }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
          SMTP_SENDER_NAME: InsightPulseAI
          SMTP_HOST: smtppro.zoho.com
          SMTP_PORT: 587
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
        run: ./scripts/supabase/configure_auth_smtp_and_urls.sh

      - name: Configure Email Templates
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: ./scripts/supabase/configure_auth_email_templates.sh

      - name: Verify Configuration
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: ./scripts/supabase/verify_auth_config.sh

      - name: Deploy Secret Smoke Function
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          supabase link --project-ref "$SUPABASE_PROJECT_REF"
          supabase functions deploy secret-smoke

      - name: Test Secret Smoke Function
        env:
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          response=$(supabase functions invoke secret-smoke)
          echo "$response" | jq .
          if ! echo "$response" | jq -e '.ok == true' > /dev/null; then
            echo "❌ Secret smoke test failed"
            exit 1
          fi
          echo "✅ Secret smoke test passed"
