# Secrets Audit Workflow
# Verifies secrets are properly configured across platforms
# Runs on PRs to main and manual dispatch

name: Secrets Audit

on:
  pull_request:
    branches: [main]
    paths:
      - 'scripts/check_secrets.sh'
      - 'scripts/secret-scan.sh'
      - 'config/secrets_expected.example.env'
      - '.github/workflows/secrets-audit.yml'
  workflow_dispatch:
    inputs:
      full_check:
        description: 'Run full secrets check including external services'
        required: false
        default: 'false'
        type: boolean

env:
  REPO_ROOT: ${{ github.workspace }}

jobs:
  repo-scan:
    name: Repository Secret Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run secret scan
        run: |
          chmod +x scripts/secret-scan.sh
          scripts/secret-scan.sh

  structure-check:
    name: Secrets Structure Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check secrets inventory exists
        run: |
          if [[ -f config/secrets_expected.example.env ]]; then
            echo "✓ Secrets inventory exists"
          else
            echo "✗ Missing config/secrets_expected.example.env"
            exit 1
          fi

      - name: Check .env files are gitignored
        run: |
          # Verify common .env patterns are in .gitignore
          patterns=(".env" ".env.local" ".env.*.local" "*.tfvars")
          missing=0
          for pattern in "${patterns[@]}"; do
            if grep -qE "^${pattern}$|^\*\*/${pattern}$" .gitignore 2>/dev/null; then
              echo "✓ $pattern is gitignored"
            else
              echo "⚠ $pattern may not be properly gitignored"
            fi
          done

      - name: Check no hardcoded secrets in config
        run: |
          # Scan for potential hardcoded secrets in tracked files
          if grep -rE "(password|secret|token|key)=.{8,}" \
               --include="*.env.example" \
               --include="*.tfvars.example" \
               config/ infra/ 2>/dev/null; then
            echo "⚠ Potential hardcoded values found in example files"
            echo "Ensure these are placeholders, not real secrets"
          else
            echo "✓ No obvious hardcoded secrets in example files"
          fi

  github-secrets:
    name: GitHub Secrets Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check required repo secrets exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Checking GitHub repo secrets..."
          # This only checks if we can list secrets, not their values
          gh secret list --repo ${{ github.repository }} || echo "Unable to list secrets"

      - name: Verify critical secrets are set
        run: |
          # Check that critical secrets are available (as env vars in this job)
          # This doesn't expose values, just confirms they're non-empty
          critical_secrets=(
            "GITHUB_TOKEN"
          )

          for secret in "${critical_secrets[@]}"; do
            if [[ -n "${!secret:-}" ]]; then
              echo "✓ $secret is set"
            else
              echo "✗ $secret is NOT set"
            fi
          done

  full-audit:
    name: Full Secrets Audit
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.full_check == 'true' }}
    needs: [repo-scan, structure-check]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CLIs
        run: |
          npm install -g supabase vercel

      - name: Setup GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh auth status

      - name: Run full secrets audit
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          chmod +x scripts/check_secrets.sh
          scripts/check_secrets.sh

  summary:
    name: Audit Summary
    runs-on: ubuntu-latest
    needs: [repo-scan, structure-check, github-secrets]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## Secrets Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Repo Scan | ${{ needs.repo-scan.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Structure | ${{ needs.structure-check.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Secrets | ${{ needs.github-secrets.result == 'success' && '✅' || '❌' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Run with 'full_check: true' for complete external service audit_" >> $GITHUB_STEP_SUMMARY
