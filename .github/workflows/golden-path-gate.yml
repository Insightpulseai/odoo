name: Golden Path Gate

on:
  pull_request:
    paths:
      - "apps/**"
      - "packages/**"

permissions:
  contents: read

jobs:
  # ─────────────────────────────────────────────
  # Detect which apps/packages changed in this PR
  # ─────────────────────────────────────────────
  detect-changes:
    name: Detect changed surfaces
    runs-on: ubuntu-latest
    outputs:
      ops_console: ${{ steps.filter.outputs.ops_console }}
      packages: ${{ steps.filter.outputs.packages }}
      any_app: ${{ steps.filter.outputs.any_app }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ops_console:
              - "apps/ops-console/**"
            packages:
              - "packages/**"
            any_app:
              - "apps/**"

  # ─────────────────────────────────────────────
  # Workspace registration check (always-on for apps/packages)
  # ─────────────────────────────────────────────
  workspace-registration:
    name: Workspace registration
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_app == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Check pnpm-workspace.yaml includes apps/*
        run: |
          if ! grep -q '"apps/\*"' pnpm-workspace.yaml && ! grep -q "'apps/\*'" pnpm-workspace.yaml && ! grep -q "apps/\*" pnpm-workspace.yaml; then
            echo "::error::pnpm-workspace.yaml must include apps/* pattern"
            exit 1
          fi
          echo "✅ pnpm-workspace.yaml includes apps/*"

      - name: Check each changed app has vercel.json with ignoreCommand
        run: |
          CHANGED_APPS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^apps/' | cut -d/ -f1-2 | sort -u)
          FAIL=0
          for app_dir in $CHANGED_APPS; do
            if [ -f "$app_dir/package.json" ]; then
              # It's a real app (has package.json)
              if [ ! -f "$app_dir/vercel.json" ]; then
                echo "::warning::$app_dir/vercel.json missing — add it before production deploy"
              elif ! grep -q "ignoreCommand" "$app_dir/vercel.json"; then
                echo "::warning::$app_dir/vercel.json has no ignoreCommand — builds may run unnecessarily"
              else
                echo "✅ $app_dir has vercel.json with ignoreCommand"
              fi
            fi
          done

  # ─────────────────────────────────────────────
  # ops-console surface checks
  # ─────────────────────────────────────────────
  ops-console-gate:
    name: ops-console golden path
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.ops_console == 'true'
    defaults:
      run:
        working-directory: apps/ops-console
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/ops-console/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: ESLint
        run: npm run lint

      - name: Prettier format check
        run: npx prettier --check .

      - name: Check bundle budget (build required)
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1
          # Stub env vars so build doesn't fail on missing secrets
          NEXT_PUBLIC_SUPABASE_URL: "https://placeholder.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "placeholder"

      - name: Verify .vercelignore exists and excludes monorepo noise
        working-directory: apps/ops-console
        run: |
          if [ ! -f ".vercelignore" ]; then
            echo "::warning::apps/ops-console/.vercelignore is missing — uploads will include entire monorepo"
          else
            echo "✅ .vercelignore present"
          fi

  # ─────────────────────────────────────────────
  # Package surface checks
  # ─────────────────────────────────────────────
  packages-gate:
    name: packages golden path
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.packages == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install workspace deps
        run: pnpm install --frozen-lockfile

      - name: Type-check all packages
        run: pnpm --filter "./packages/**" run --if-present typecheck

      - name: Test all packages
        run: pnpm --filter "./packages/**" run --if-present test

  # ─────────────────────────────────────────────
  # UI change preview URL reminder
  # ─────────────────────────────────────────────
  ui-preview-reminder:
    name: UI preview URL reminder
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.ops_console == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Check PR body for Preview URL
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Soft-check: warn if no preview URL is in the PR body
          if echo "$PR_BODY" | grep -qiE "(vercel\.app|preview\.vercel\.app|deploy-preview|vercel\.live)"; then
            echo "✅ PR body contains a Vercel Preview URL"
          else
            echo "::warning::No Vercel Preview URL found in PR body. Add the Preview URL before requesting review. See docs/ops/VERCEL_PREVIEWS.md"
          fi

      - name: Check PR body for screenshot on UI changes
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          HAS_IMAGE=$(echo "$PR_BODY" | grep -cE "(!\[|<img|screenshot|screen recording)" || true)
          if [ "$HAS_IMAGE" -gt 0 ]; then
            echo "✅ PR body contains screenshot/image evidence"
          else
            echo "::warning::UI changes detected but no screenshot found in PR body. See docs/design/DESIGN_ENGINEERING_WORKFLOW.md §4"
          fi

  # ─────────────────────────────────────────────
  # Summary job — required check for branch protection
  # ─────────────────────────────────────────────
  golden-path-summary:
    name: Golden Path ✅
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - workspace-registration
      - ops-console-gate
      - packages-gate
      - ui-preview-reminder
    if: always()
    steps:
      - name: Evaluate results
        run: |
          # Allow skipped jobs (path not matched); fail on actual failures
          RESULTS='${{ toJSON(needs) }}'
          echo "Job results: $RESULTS"

          # Check for any 'failure' result (skipped/success are OK)
          if echo "$RESULTS" | python3 -c "
          import sys, json
          data = json.load(sys.stdin)
          failures = [k for k,v in data.items() if v.get('result') == 'failure']
          if failures:
              print('FAILED jobs:', failures)
              sys.exit(1)
          print('All gates passed or skipped')
          "; then
            echo "✅ Golden Path gate passed"
          else
            echo "❌ Golden Path gate failed — see individual job logs"
            exit 1
          fi
