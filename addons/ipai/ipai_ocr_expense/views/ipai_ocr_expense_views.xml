<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extend Expense Form with OCR Fields -->
    <record id="view_expense_ocr_form" model="ir.ui.view">
        <field name="name">hr.expense.form.ocr</field>
        <field name="model">hr.expense</field>
        <field name="inherit_id" ref="hr_expense.hr_expense_view_form"/>
        <field name="priority">50</field>
        <field name="arch" type="xml">
            <!-- Add OCR buttons to header -->
            <xpath expr="//header" position="inside">
                <button name="action_scan_receipt" string="Digitize Receipt (AI)"
                        type="object" class="oe_highlight"
                        invisible="not receipt_image or digitization_status in ('completed', 'validated', 'pending')"
                        icon="fa-magic"/>
                <button name="action_apply_ai_data" string="Apply AI Data"
                        type="object" class="btn-secondary"
                        invisible="digitization_status != 'completed' or ai_data_applied"
                        icon="fa-check"/>
                <button name="action_validate_ocr" string="Validate"
                        type="object" class="btn-success"
                        invisible="digitization_status != 'completed'"
                        icon="fa-thumbs-up"/>
                <button name="action_reset_ocr" string="Reset OCR"
                        type="object" class="btn-link"
                        invisible="digitization_status == 'not_started'"
                        icon="fa-refresh"/>
            </xpath>

            <!-- Add confidence alert before sheet -->
            <xpath expr="//sheet" position="before">
                <div class="alert alert-warning" role="alert"
                     invisible="not needs_review">
                    <strong>AI Review Needed:</strong>
                    Confidence score is low (<field name="ai_confidence_score" readonly="1"/>%).
                    Please verify the extracted amounts before submission.
                </div>
                <div class="alert alert-info" role="alert"
                     invisible="digitization_status != 'pending'">
                    <i class="fa fa-spinner fa-spin"/> Scanning receipt... Please wait.
                </div>
                <div class="alert alert-success" role="alert"
                     invisible="digitization_status != 'validated'">
                    <i class="fa fa-check-circle"/> Receipt digitization validated.
                </div>
            </xpath>

            <!-- Add OCR button box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" type="object" name="action_scan_receipt"
                        icon="fa-file-image-o"
                        invisible="not receipt_image">
                    <field name="digitization_status" widget="badge"
                        decoration-info="digitization_status == 'pending'"
                        decoration-success="digitization_status in ('completed', 'validated')"
                        decoration-danger="digitization_status == 'failed'"/>
                </button>
            </xpath>

            <!-- Add Receipt Upload and AI Data page -->
            <xpath expr="//notebook" position="inside">
                <page string="Receipt Digitization" name="ocr_data">
                    <group>
                        <group string="Receipt Upload">
                            <field name="receipt_image" widget="image"
                                   options="{'size': [200, 200]}"/>
                            <field name="receipt_filename" invisible="1"/>
                            <field name="digitization_status" readonly="1"/>
                            <field name="ocr_token" readonly="1" invisible="not ocr_token"/>
                        </group>
                        <group string="AI Extracted Data"
                               invisible="digitization_status not in ('completed', 'validated')">
                            <field name="ai_total_amount" readonly="1"/>
                            <field name="ai_vendor_name" readonly="1"/>
                            <field name="ai_expense_date" readonly="1"/>
                            <field name="ai_confidence_score" readonly="1" widget="progressbar"/>
                            <field name="ai_data_applied" readonly="1"/>
                            <field name="needs_review" invisible="1"/>
                        </group>
                    </group>
                    <group string="Extracted Text"
                           invisible="not ai_raw_text">
                        <field name="ai_raw_text" readonly="1" nolabel="1"
                               widget="text" class="o_field_text"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Expense List View with OCR Status -->
    <record id="view_expense_ocr_tree" model="ir.ui.view">
        <field name="name">hr.expense.tree.ocr</field>
        <field name="model">hr.expense</field>
        <field name="inherit_id" ref="hr_expense.view_expenses_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="after">
                <field name="digitization_status" widget="badge" optional="show"
                    decoration-info="digitization_status == 'pending'"
                    decoration-success="digitization_status in ('completed', 'validated')"
                    decoration-danger="digitization_status == 'failed'"
                    decoration-muted="digitization_status == 'not_started'"/>
                <field name="ai_confidence_score" widget="progressbar" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Search View with OCR Filters -->
    <record id="view_expense_ocr_search" model="ir.ui.view">
        <field name="name">hr.expense.search.ocr</field>
        <field name="model">hr.expense</field>
        <field name="inherit_id" ref="hr_expense.view_hr_expense_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <separator/>
                <filter string="Needs OCR" name="needs_ocr"
                        domain="[('receipt_image', '!=', False), ('digitization_status', '=', 'not_started')]"/>
                <filter string="OCR Pending" name="ocr_pending"
                        domain="[('digitization_status', '=', 'pending')]"/>
                <filter string="Digitized" name="ocr_completed"
                        domain="[('digitization_status', 'in', ('completed', 'validated'))]"/>
                <filter string="Needs Review" name="needs_review"
                        domain="[('needs_review', '=', True)]"/>
                <filter string="OCR Failed" name="ocr_failed"
                        domain="[('digitization_status', '=', 'failed')]"/>
                <separator/>
                <group expand="0" string="Group By">
                    <filter string="OCR Status" name="group_ocr_status"
                            context="{'group_by': 'digitization_status'}"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- OCR Queue Action -->
    <record id="action_expense_ocr_queue" model="ir.actions.act_window">
        <field name="name">OCR Processing Queue</field>
        <field name="res_model">hr.expense</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('receipt_image', '!=', False)]</field>
        <field name="context">{
            'search_default_needs_ocr': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No expenses with receipts pending OCR
            </p>
            <p>
                Upload receipt images to expenses and use AI to extract data automatically.
            </p>
        </field>
    </record>

    <!-- Needs Review Action -->
    <record id="action_expense_needs_review" model="ir.actions.act_window">
        <field name="name">Expenses Needing Review</field>
        <field name="res_model">hr.expense</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('needs_review', '=', True)]</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No expenses needing review
            </p>
            <p>
                Expenses with low OCR confidence scores will appear here for manual verification.
            </p>
        </field>
    </record>
</odoo>
