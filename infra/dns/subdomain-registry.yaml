# =============================================================================
# DNS Subdomain Registry — Single Source of Truth
# =============================================================================
# This file is the CANONICAL source for all subdomains under insightpulseai.com.
# All DNS configuration (Terraform, runtime JSON, monitoring) is generated from this file.
#
# Generation: ./scripts/generate-dns-artifacts.sh
# Validation: .github/workflows/dns-sync-check.yml (CI enforces sync)
#
# DO NOT manually edit generated files:
#   - infra/cloudflare/envs/prod/subdomains.auto.tfvars
#   - docs/architecture/runtime_identifiers.json
#   - infra/dns/dns-validation-spec.json
# =============================================================================
#
# lifecycle field (schema: ssot.dns.v1)
# --------------------------------------
# active  → Terraform provisions/maintains the record.
# planned → Record is defined in SSOT but Terraform SKIPS it.
#           Use for records awaiting provider onboarding (e.g., Vercel domain claim).
#           Transition to active only after all provider_claim.status == "claimed".
#
# provider_claim field (optional)
# --------------------------------
# Required when the record cannot resolve correctly until an external provider
# (e.g., Vercel) claims the domain. The CI gate script
# scripts/ci/check_dns_provider_claims.py fails if lifecycle=active + status=unclaimed.
#   provider: vercel | digitalocean | other
#   project:  provider project/app identifier
#   domain:   full custom hostname being claimed
#   status:   unclaimed | claimed
# =============================================================================

version: "1.0"
domain: insightpulseai.com
environment: production
origin_ip: 178.128.112.214

# =============================================================================
# Subdomain Definitions
# =============================================================================
# Each subdomain entry must specify:
#   - name: subdomain (e.g., "erp" for erp.insightpulseai.com)
#   - type: DNS record type (A, CNAME, TXT)
#   - service: human-readable service identifier
#   - For A records: origin_port, health_check
#   - For CNAME records: target (full FQDN)
# =============================================================================

subdomains:
  # ---------------------------------------------------------------------------
  # Core Business Systems (A Records → 178.128.112.214)
  # ---------------------------------------------------------------------------
  - name: erp
    type: A
    service: odoo_ce_19
    port: 8069
    health_check: /web/login
    owner_system: "Odoo CE 19.0"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active

  - name: n8n
    type: A
    service: n8n_workflow_automation
    port: 5678
    health_check: /healthz
    owner_system: "n8n automation"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active

  - name: ocr
    type: A
    service: paddleocr_microservice
    port: 8080
    health_check: /health
    owner_system: "PaddleOCR microservice"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active

  - name: auth
    type: A
    service: authentication_service
    port: 3000
    health_check: /.well-known/openid-configuration
    owner_system: "Authentication service"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active

  - name: superset
    type: A
    service: apache_superset_bi
    port: 8088
    health_check: /health
    owner_system: "Apache Superset BI"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    database: "DO managed PostgreSQL: odoo-db-sgp1/superset"
    lifecycle: active
    status: active

  # ---------------------------------------------------------------------------
  # App Platform Services (CNAME Records → DO App Platform)
  # ---------------------------------------------------------------------------
  - name: mcp
    type: CNAME
    service: mcp_gateway
    target: pulse-hub-web-an645.ondigitalocean.app
    health_check: /healthz
    owner_system: "MCP coordination (11 servers)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    drift_note: "Cloudflare currently has A record (178.128.112.214) — WRONG. Must be CNAME. Will be fixed on next Terraform apply."

  # ---------------------------------------------------------------------------
  # Additional Subdomains (for www, api, etc.)
  # ---------------------------------------------------------------------------
  - name: www
    type: A
    service: website_redirect
    port: 80
    health_check: /
    owner_system: "Redirect to apex"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active

  - name: api
    type: A
    service: api_gateway
    port: 8000
    health_check: /api/health
    owner_system: "API Gateway"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: planned
    status: planned

  # ---------------------------------------------------------------------------
  # Vercel Deployments (CNAME → cname.vercel-dns.com)
  # ---------------------------------------------------------------------------
  - name: ops
    type: CNAME
    service: ops_console_vercel
    target: cname.vercel-dns.com
    health_check: /api/health
    owner_system: "OdooOps Console (Next.js on Vercel)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    # lifecycle=planned: Terraform will NOT provision this record until
    # provider_claim.status transitions to "claimed". To claim:
    #   1. Go to Vercel project settings → Domains → Add ops.insightpulseai.com
    #   2. Vercel confirms delegation (CNAME points to cname.vercel-dns.com)
    #   3. Update provider_claim.status below to "claimed"
    #   4. Change lifecycle to "active"
    #   5. Commit → CI gate passes → Terraform applies the record
    lifecycle: planned
    status: active
    provider_claim:
      provider: vercel
      project: odooops-console
      domain: ops.insightpulseai.com
      status: unclaimed

  # ---------------------------------------------------------------------------
  # Staging Environment (A Records → 178.128.112.214)
  # ---------------------------------------------------------------------------
  - name: stage-erp
    type: A
    service: odoo_ce_19_staging
    port: 8069
    health_check: /web/login
    owner_system: "Odoo CE 19.0 (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    environment: staging

  - name: stage-api
    type: A
    service: api_gateway_staging
    port: 8000
    health_check: /api/health
    owner_system: "API Gateway (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    environment: staging

  - name: stage-auth
    type: A
    service: authentication_service_staging
    port: 3000
    health_check: /.well-known/openid-configuration
    owner_system: "Authentication service (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    environment: staging

  - name: stage-mcp
    type: A
    service: mcp_gateway_staging
    port: 3000
    health_check: /healthz
    owner_system: "MCP coordination (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    environment: staging

  - name: stage-n8n
    type: A
    service: n8n_workflow_automation_staging
    port: 5678
    health_check: /healthz
    owner_system: "n8n automation (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    environment: staging

  - name: stage-superset
    type: A
    service: apache_superset_bi_staging
    port: 8088
    health_check: /health
    owner_system: "Apache Superset BI (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    environment: staging

  - name: stage-ocr
    type: A
    service: paddleocr_microservice_staging
    port: 8080
    health_check: /health
    owner_system: "PaddleOCR microservice (staging)"
    cloudflare_proxied: false
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    environment: staging

# =============================================================================
# Deprecated Services (Archived for Reference)
# =============================================================================
deprecated:
  - name: affine
    deprecated_date: "2026-02-09"
    replacement: null
    reason: "Service no longer needed"
    dns_removed: true
    container_removed: true

  # Mailgun email routing — replaced by Zoho Mail SMTP (2026-02)
  # Remove from Cloudflare: email.mg CNAME, mg SPF TXT, mx._domainkey.mg DKIM TXT, _dmarc.mg DMARC TXT
  - name: mg
    deprecated_date: "2026-02-01"
    replacement: "Zoho Mail (mx.zoho.com / mx2 / mx3)"
    reason: "Mailgun deprecated; outbound mail now routes through Zoho Mail SMTP bridge (ipai_zoho_mail_api)"
    dns_removed: false
    records_to_remove:
      - type: CNAME
        name: email.mg
        content: mailgun.org
      - type: TXT
        name: mg
        content: "v=spf1 include:mailgun.org ~all"
      - type: TXT
        name: mx._domainkey.mg
        content: "k=rsa; p=MIGfMA0..."
      - type: TXT
        name: _dmarc.mg
        content: "v=DMARC1; p=none; ..."
    notes: "4 records still present in Cloudflare as of 2026-02-27 — remove via Terraform apply"
