# ssot/secrets/registry.yaml
#
# Secret NAME registry — identifier metadata only. No values. No credentials.
#
# Policy (from CLAUDE.md § Secrets Policy):
#   - Values live in Supabase Vault (prod/runtime), GitHub Actions Secrets (CI),
#     or OS Keychain/Keyring (local dev).
#   - This file registers the name, store location, rotation policy, scope, and owner.
#   - CI gate: grep -r for literal secret values in git diff must return zero results.
#
# Schema fields:
#   name:      Canonical identifier (used as Vault secret name / GH Actions secret name)
#   store:     supabase_vault | github_actions | keychain
#   rotation:  manual | scheduled_90d | scheduled_365d | on_team_change
#   scope:     local | ci | prod | ci_and_prod
#   owner:     Team or role responsible for rotation
#   used_by:   List of callers (Edge Functions, workers, scripts)
#   notes:     Optional. Reason for store choice if non-obvious.
#
# To add a new secret:
#   1. Add entry below (identifier only, never the value)
#   2. Store the value in the approved store (Vault UI, gh secret set, Keychain)
#   3. Reference in code as env var: Deno.env.get('NAME') / process.env.NAME / ${NAME}
#   4. Commit this file

---
version: "1.0.0"
updated: "2026-02-27"
policy_ref: "CLAUDE.md#secrets-policy-non-negotiable"

secrets:
  # ── OCR / AI Services ──────────────────────────────────────────────────────
  - name: IPAI_OCR_ENDPOINT_URL
    store: supabase_vault
    rotation: manual
    scope: prod
    owner: devops
    used_by:
      - supabase/functions/expense-policy-check/
      - addons/ipai/ipai_expense_ocr/models/hr_expense_mixin.py
    notes: >
      Currently also in ir.config_parameter (Odoo); Phase 2 migration moves it
      fully to Vault. Edge Functions read via Deno.env.

  # ── Iceberg / ETL ──────────────────────────────────────────────────────────
  - name: ODOO_PG_CDC_URL
    store: github_actions
    rotation: on_team_change
    scope: ci_and_prod
    owner: devops
    used_by:
      - infra/supabase-etl/odoo-expense.toml
      - .github/workflows/supabase-etl-expense.yml
    notes: postgres://odoo_cdc:<pw>@<host>:5432/odoo?sslmode=require — never log

  - name: ICEBERG_CATALOG_URI
    store: github_actions
    rotation: manual
    scope: ci_and_prod
    owner: devops
    used_by:
      - infra/supabase-etl/odoo-expense.toml

  - name: ICEBERG_WAREHOUSE
    store: github_actions
    rotation: manual
    scope: ci_and_prod
    owner: devops
    used_by:
      - infra/supabase-etl/odoo-expense.toml

  - name: ICEBERG_NAMESPACE
    store: github_actions
    rotation: manual
    scope: ci_and_prod
    owner: devops
    used_by:
      - infra/supabase-etl/odoo-expense.toml
    notes: Target namespace — odoo_ops

  - name: ICEBERG_S3_ENDPOINT
    store: github_actions
    rotation: manual
    scope: ci_and_prod
    owner: devops
    used_by:
      - infra/supabase-etl/odoo-expense.toml
    notes: DO Spaces SGP1 endpoint or MinIO

  - name: ICEBERG_REGION
    store: github_actions
    rotation: manual
    scope: ci_and_prod
    owner: devops
    used_by:
      - infra/supabase-etl/odoo-expense.toml

  - name: ICEBERG_ACCESS_KEY_ID
    store: supabase_vault
    rotation: scheduled_365d
    scope: prod
    owner: devops
    used_by:
      - infra/supabase-etl/odoo-expense.toml
    notes: S3/DO Spaces access key — rotate annually or on personnel change

  - name: ICEBERG_SECRET_ACCESS_KEY
    store: supabase_vault
    rotation: scheduled_365d
    scope: prod
    owner: devops
    used_by:
      - infra/supabase-etl/odoo-expense.toml

  - name: ICEBERG_S3_PATH_STYLE
    store: github_actions
    rotation: manual
    scope: ci_and_prod
    owner: devops
    used_by:
      - infra/supabase-etl/odoo-expense.toml
    notes: Non-sensitive config flag (true for DO Spaces/MinIO); in GH Actions for consistency

  # ── Mail ───────────────────────────────────────────────────────────────────
  - name: ZOHO_MAIL_BRIDGE_URL
    store: supabase_vault
    rotation: manual
    scope: prod
    owner: devops
    used_by:
      - addons/ipai/ipai_mail_bridge_zoho/

  - name: ZOHO_MAIL_BRIDGE_SECRET
    store: supabase_vault
    rotation: on_team_change
    scope: prod
    owner: devops
    used_by:
      - addons/ipai/ipai_mail_bridge_zoho/

  # ── Supabase Platform ──────────────────────────────────────────────────────
  - name: SUPABASE_SERVICE_ROLE_KEY
    store: github_actions
    rotation: on_team_change
    scope: ci_and_prod
    owner: devops
    used_by:
      - .github/workflows/supabase-db-push.yml
      - supabase/functions/
    notes: Service role — full DB access. Rotate on any team member departure.

  - name: SUPABASE_ANON_KEY
    store: github_actions
    rotation: manual
    scope: ci_and_prod
    owner: devops
    used_by:
      - apps/ops-console/
      - web/ai-control-plane/

  # ── n8n ────────────────────────────────────────────────────────────────────
  - name: N8N_API_KEY
    store: supabase_vault
    rotation: on_team_change
    scope: prod
    owner: devops
    used_by:
      - scripts/automations/deploy_n8n_all.py
      - supabase/functions/webhook-ingest/
