# CI Minimal Set - Workflow Reduction Plan

**Date:** 2026-01-05
**Purpose:** Reduce GitHub Actions to only necessary CI gates for PRs

---

## Executive Summary

The repository has **39 workflows**, of which **25 run on PRs**. This is excessive and causes:
- Slow CI feedback loops
- Resource waste on non-essential checks
- Build/Deploy workflows running on PRs (incorrect)

**Target:** Reduce PR-blocking gates to **5-7 essential workflows**.

---

## Current State Analysis

### A) Workflows Running on PRs That Should NOT (Build/Deploy)

| Workflow | Current Trigger | Fix |
|----------|-----------------|-----|
| `build-unified-image.yml` | push + **pull_request** | Remove PR trigger |
| `build-seeded-image.yml` | push + **pull_request** | Remove PR trigger |

### B) Core CI Gates - KEEP on PRs (5-7 max)

| Workflow | Purpose | Keep? |
|----------|---------|-------|
| `ci.yml` | Core lint/tests/preflight | **YES** |
| `workflow-yaml-validate.yml` | Validate workflow YAML syntax | **YES** |
| `repo-structure.yml` | Repo structure validation | **YES** |
| `spec-kit-enforce.yml` | Spec bundle enforcement | **YES** |
| `all-green-gates.yml` | Aggregate gate check | **YES** (consolidates checks) |

### C) Workflows to Move to push-main-only or schedule

| Workflow | Current | New Trigger |
|----------|---------|-------------|
| `diagrams-qa.yml` | PR + push | push main only |
| `diagrams-drawio-enforce.yml` | PR + push | push main only |
| `icons-drift.yml` | PR + push | push main only |
| `module-catalog-drift.yml` | PR + push | push main only |
| `docs-architecture-sync.yml` | PR + push | push main only |
| `go-live-manifest-gate.yml` | PR + push | push main only |
| `ipai-module-matrix.yml` | PR + push | push main only |
| `seeds-validate.yml` | PR + push | push main only |
| `audit-contract.yml` | PR + push | push main only |
| `lakehouse-smoke.yml` | PR + push | push main only |
| `ipai-ai-studio-smoke.yml` | PR + push | push main only |
| `spec-and-parity.yml` | PR + push | push main only |
| `notion-sync-ci.yml` | PR + push | push main only |
| `databricks-dab-ci.yml` | PR + push | push main only |
| `control-room-ci.yml` | PR + push | push main only |
| `ipai-prod-checks.yml` | PR + push | push main only |
| `infra-validate.yml` | PR + push | push main only |
| `ipai-dynamic-qg.yml` | PR + push | push main only |
| `agent-preflight.yml` | PR | push main only |
| `odoo-module-install-gate.yml` | PR + push | push main only (heavy) |

### D) Workflows Already Correct (schedule/dispatch/main-only)

| Workflow | Trigger | Status |
|----------|---------|--------|
| `deploy-production.yml` | push main + workflow_run + dispatch | OK |
| `deploy-odoo-prod.yml` | push main + dispatch | OK |
| `deploy-finance-ppm.yml` | push main + dispatch | OK |
| `deploy-ipai-control-center-docs.yml` | push main + dispatch | OK |
| `superset-bump.yml` | dispatch + repository_dispatch | OK |
| `health-check.yml` | schedule + dispatch | OK |
| `docs-crawler-cron.yml` | schedule + dispatch | OK |
| `directional-sync.yml` | schedule + dispatch | OK |
| `fin-workspace-weekly-sync.yml` | schedule + dispatch | OK |
| `finance-ppm-health.yml` | dispatch + push main | OK |
| `odoo-import-artifacts.yml` | dispatch only | OK (needs robustness fix) |
| `auto-sitemap-tree.yml` | push main + dispatch | OK |

---

## Target CI Minimal Set (PR-Blocking)

After reduction, these workflows run on PRs:

1. **`ci.yml`** - Core linting, tests, preflight checks
2. **`workflow-yaml-validate.yml`** - Workflow YAML syntax validation
3. **`repo-structure.yml`** - Repository structure validation
4. **`spec-kit-enforce.yml`** - Spec bundle enforcement
5. **`all-green-gates.yml`** - Aggregate gate (spec/policy/syntax)

**Total: 5 workflows** (down from 25)

---

## Key Issues to Fix

### 1. odoo-import-artifacts.yml - Robustness Issue
The conditional `if: ${{ !secrets.IMPORT_SOURCE_URL }}` doesn't work in GitHub Actions.
Secrets are not exposed to conditionals - they always appear as empty strings.

**Fix:** Use environment variable check in shell instead of step conditional.

### 2. Build Workflows on PRs
`build-unified-image.yml` and `build-seeded-image.yml` run expensive Docker builds on PRs.
These should only run on push to main or manual dispatch.

---

## Implementation Checklist

- [ ] Remove `pull_request` trigger from `build-unified-image.yml`
- [ ] Remove `pull_request` trigger from `build-seeded-image.yml`
- [ ] Fix `odoo-import-artifacts.yml` to handle missing secrets gracefully
- [ ] Convert 20 non-essential workflows to push-main-only
- [ ] Verify minimal set passes on test PR

---

*Generated by CI reduction analysis*
