<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Enhanced Kanban View for CRM Pipeline -->
    <record id="ipai_crm_lead_kanban_inherit" model="ir.ui.view">
        <field name="name">crm.lead.kanban.ipai.pipeline</field>
        <field name="model">crm.lead</field>
        <field name="inherit_id" ref="crm.crm_case_kanban_view_leads"/>
        <field name="arch" type="xml">
            <!-- Add IPAI pipeline class to kanban -->
            <xpath expr="//kanban" position="attributes">
                <attribute name="class">ipai-crm-pipeline</attribute>
            </xpath>

            <!-- Add stage rule indicator to kanban cards -->
            <xpath expr="//templates//div[hasclass('oe_kanban_content')]" position="inside">
                <div class="ipai-stage-rule-indicator mt-1" t-if="!record.stage_rule_validated.raw_value">
                    <span class="ipai-badge ipai-badge-warning">
                        <i class="fa fa-exclamation-triangle me-1"/>
                        <t t-esc="record.stage_missing_fields.value"/>
                    </span>
                </div>
            </xpath>

            <!-- Add quick actions panel -->
            <xpath expr="//templates//div[hasclass('oe_kanban_content')]" position="inside">
                <div class="ipai-quick-actions">
                    <a class="ipai-quick-action" role="button" t-att-title="'Log Call'" name="action_quick_call" type="object">
                        <i class="fa fa-phone"/> Call
                    </a>
                    <a class="ipai-quick-action" role="button" t-att-title="'Schedule Meeting'" name="action_quick_meeting" type="object">
                        <i class="fa fa-calendar"/> Meet
                    </a>
                    <a class="ipai-quick-action" role="button" t-att-title="'Send Email'" name="action_quick_email" type="object">
                        <i class="fa fa-envelope"/> Email
                    </a>
                </div>
            </xpath>

            <!-- Add days in stage indicator -->
            <xpath expr="//templates//div[hasclass('oe_kanban_bottom_left')]" position="inside">
                <span t-if="record.days_in_stage.raw_value > 0" class="ms-2 text-muted">
                    <i class="fa fa-clock-o"/> <t t-esc="record.days_in_stage.value"/>d
                </span>
            </xpath>
        </field>
    </record>

    <!-- Enhanced Form View for CRM Lead -->
    <record id="ipai_crm_lead_form_inherit" model="ir.ui.view">
        <field name="name">crm.lead.form.ipai.pipeline</field>
        <field name="model">crm.lead</field>
        <field name="inherit_id" ref="crm.crm_lead_view_form"/>
        <field name="arch" type="xml">
            <!-- Add IPAI form class -->
            <xpath expr="//form" position="attributes">
                <attribute name="class">ipai-form</attribute>
            </xpath>

            <!-- Add stage rule validation banner -->
            <xpath expr="//sheet" position="before">
                <div class="alert alert-warning" role="alert"
                     invisible="stage_rule_validated">
                    <i class="fa fa-exclamation-triangle me-2"/>
                    <strong>Stage Requirements:</strong>
                    Please fill in the following fields:
                    <field name="stage_missing_fields"/>
                </div>
            </xpath>

            <!-- Add quick actions header buttons -->
            <xpath expr="//header" position="inside">
                <button name="action_quick_call" type="object"
                        string="Log Call" class="btn-secondary"
                        icon="fa-phone"/>
                <button name="action_quick_meeting" type="object"
                        string="Schedule Meeting" class="btn-secondary"
                        icon="fa-calendar"/>
                <button name="action_quick_email" type="object"
                        string="Send Email" class="btn-secondary"
                        icon="fa-envelope"/>
            </xpath>

            <!-- Add pipeline metrics group -->
            <xpath expr="//group[@name='opportunity_stage']" position="after">
                <group name="ipai_pipeline_metrics" string="Pipeline Metrics">
                    <field name="days_in_stage" readonly="1"/>
                    <field name="stage_entry_date" readonly="1"/>
                    <field name="last_call_date" readonly="1"/>
                    <field name="last_meeting_date" readonly="1"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Pipeline Dashboard Action -->
    <record id="ipai_crm_pipeline_action" model="ir.actions.act_window">
        <field name="name">IPAI Pipeline</field>
        <field name="res_model">crm.lead</field>
        <field name="view_mode">kanban,tree,form,pivot,graph,calendar,activity</field>
        <field name="domain">[('type', '=', 'opportunity')]</field>
        <field name="context">{
            'default_type': 'opportunity',
            'search_default_assigned_to_me': 1,
        }</field>
        <field name="search_view_id" ref="crm.crm_lead_view_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first opportunity!
            </p>
            <p>
                Track your sales pipeline with IPAI's enhanced CRM features:
                quick actions, stage rules, and activity tracking.
            </p>
        </field>
    </record>

    <!-- Menu Entry -->
    <menuitem id="ipai_crm_pipeline_menu"
              name="IPAI Pipeline"
              parent="crm.crm_menu_root"
              action="ipai_crm_pipeline_action"
              sequence="5"/>
</odoo>
