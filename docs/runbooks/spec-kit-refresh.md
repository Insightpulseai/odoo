# Spec Kit Refresh Runbook

**SSOT reference**: `ssot/tooling/spec-kit.yaml`
**Policy**: `docs/policies/spec-kit.md`
**CI gate**: `.github/workflows/spec-kit-drift.yml`

---

## When to refresh

1. A new version of `specify` is released and you want to adopt it.
2. The CI drift gate fails on a PR (`spec-kit-drift` job is red).
3. A template path listed in `ssot/tooling/spec-kit.yaml#template_paths` has been edited
   outside a `chore/spec-kit-refresh-*` PR (this violates policy — refresh to reconcile).

---

## Blessed refresh command

```bash
npx specify@1.3.0 init --here --force --ignore-agent-tools
```

- `--here`: Run in the repo root.
- `--force`: Overwrite existing templates without prompting.
- `--ignore-agent-tools`: Do not regenerate `.claude/commands/speckit.*.md` — those are
  managed separately. Remove this flag only if you want to also refresh the commands.

---

## Expected changed paths

After running the refresh command, only these paths should change:

```
.specify/templates/
.specify/scripts/
.claude/commands/speckit.*.md   (only if --ignore-agent-tools is NOT passed)
```

If any other paths change, investigate before committing.

---

## What never changes via refresh

```
spec/<slug>/     ← Spec bundles are authored SSOT — never regenerated by the CLI.
```

The CLI does not touch `spec/` at all. If `git diff` shows changes under `spec/`,
something went wrong — discard them.

---

## Verification checklist

1. `git diff --stat` shows only expected template paths.
2. No changes under `spec/`.
3. `python3 -c "import yaml, sys; yaml.safe_load(open('ssot/tooling/spec-kit.yaml'))"` — exits 0.
4. CI passes on the PR (`spec-kit-drift` + `all-green-gates`).

---

## Version bump procedure

1. Update `spec_kit.cli.version` in `ssot/tooling/spec-kit.yaml`.
2. Update `spec_kit.cli.install` to match (`npm install -g specify@<new_version>`).
3. Run the blessed refresh command with the new version.
4. Verify the checklist above.
5. Open a PR with label `chore/spec-kit-refresh` on a branch named
   `chore/spec-kit-refresh-<new_version>`.

---

## Rollback

If a refresh introduces breaking changes to templates, revert to the previous version:

```bash
git checkout HEAD -- .specify/templates/ .specify/scripts/
# Optionally restore commands
git checkout HEAD -- .claude/commands/speckit.*.md
```

Update `ssot/tooling/spec-kit.yaml` to pin the working version, then open a new PR.
