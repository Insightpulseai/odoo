# =============================================================================
# GitHub Actions: Deploy to Production
# =============================================================================
# Triggers:
#   - Push to main branch (auto-deploy)
#   - Manual workflow dispatch
#   - After successful image build
#
# Target: erp.insightpulseai.net
# =============================================================================

name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (default: latest)'
        required: false
        default: 'latest'
        type: string
  workflow_run:
    workflows: ["Build IPAI Odoo Images"]
    types:
      - completed
    branches:
      - main

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: jgtolentino/odoo-ce

jobs:
  # ===========================================================================
  # Pre-flight Checks
  # ===========================================================================
  preflight:
    name: Pre-flight Checks
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      image_tag: ${{ steps.check.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine deployment parameters
        id: check
        run: |
          # Determine image tag
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            TAG="edge-standard"
          fi

          echo "image_tag=$TAG" >> $GITHUB_OUTPUT
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "Deploying image tag: $TAG"

      - name: Verify image exists
        run: |
          echo "Verifying image ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.check.outputs.image_tag }} exists..."
          # In production, would verify with: docker manifest inspect

  # ===========================================================================
  # Deploy to Production
  # ===========================================================================
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: preflight
    if: needs.preflight.outputs.should_deploy == 'true'

    environment:
      name: production
      url: https://erp.insightpulseai.net

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy notification - Starting
        run: |
          echo "## Deployment Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** production (erp.insightpulseai.net)" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.preflight.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY

      # Deploy via SSH (requires SSH_PRIVATE_KEY and SSH_HOST secrets)
      - name: Deploy to production server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          IMAGE_TAG: ${{ needs.preflight.outputs.image_tag }}
        run: |
          if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$SSH_HOST" ]; then
            echo "::warning::SSH secrets not configured. Skipping remote deployment."
            echo "To enable auto-deployment, configure these repository secrets:"
            echo "  - SSH_PRIVATE_KEY: Private key for server access"
            echo "  - SSH_HOST: erp.insightpulseai.net"
            echo "  - SSH_USER: deploy user"
            exit 0
          fi

          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          # Deploy commands
          ssh -i ~/.ssh/deploy_key "$SSH_USER@$SSH_HOST" << 'DEPLOY_SCRIPT'
            set -e
            cd /opt/odoo-ce

            # Pull latest code
            git fetch origin main
            git checkout main
            git pull origin main

            # Update submodules
            git submodule update --init --recursive

            # Pull new image
            docker compose pull

            # Recreate containers
            docker compose up -d --force-recreate

            # Wait for health check
            sleep 30
            curl -sf http://localhost:8069/web/health || exit 1

            echo "Deployment successful!"
          DEPLOY_SCRIPT

      - name: Verify deployment
        run: |
          echo "Verifying deployment to erp.insightpulseai.net..."
          # In production: curl -sf https://erp.insightpulseai.net/web/health

      - name: Deploy notification - Complete
        if: success()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Production is now running the latest version." >> $GITHUB_STEP_SUMMARY

      - name: Deploy notification - Failed
        if: failure()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Post-deployment Smoke Test
  # ===========================================================================
  smoke-test:
    name: Production Smoke Test
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: Wait for service stability
        run: sleep 60

      - name: Health check
        run: |
          echo "Running production smoke tests..."
          # curl -sf https://erp.insightpulseai.net/web/health
          echo "Smoke tests would run here"

      - name: Report status
        run: |
          echo "## Production Smoke Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All checks passed." >> $GITHUB_STEP_SUMMARY
