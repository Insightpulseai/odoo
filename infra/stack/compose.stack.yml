services:
  caddy:
    image: caddy:2-alpine
    container_name: ipai-caddy
    restart: unless-stopped
    env_file: .env
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ../caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    networks: [edge]

  # --- Odoo (DO Managed Postgres; no local DB container) ---
  odoo:
    image: ${ODOO_IMAGE}
    container_name: ipai-odoo
    restart: unless-stopped
    env_file: .env
    depends_on: []
    volumes:
      - ../../${ODOO_CONF_HOST_PATH}:/etc/odoo/odoo.conf:ro
      - odoo_filestore:/var/lib/odoo
      # IPAI custom modules (addons_path: /mnt/extra-addons)
      - ../../addons/ipai:/mnt/extra-addons:ro
      # OCA repos — each path listed in infra/odoo.conf addons_path must be mounted here.
      # Hydrated by git-aggregator (oca-aggregate.yml); never committed to repo.
      # CI guard: scripts/validate_addons_path.py enforces compose ↔ addons_path parity.
      - ../../addons/oca/account-financial-reporting:/mnt/oca/account-financial-reporting:ro
      - ../../addons/oca/account-financial-tools:/mnt/oca/account-financial-tools:ro
      - ../../addons/oca/account-reconcile:/mnt/oca/account-reconcile:ro
      - ../../addons/oca/ai:/mnt/oca/ai:ro
      - ../../addons/oca/automation:/mnt/oca/automation:ro
      - ../../addons/oca/bank-payment:/mnt/oca/bank-payment:ro
      - ../../addons/oca/bank-statement-import:/mnt/oca/bank-statement-import:ro
      - ../../addons/oca/connector:/mnt/oca/connector:ro
      - ../../addons/oca/contract:/mnt/oca/contract:ro
      - ../../addons/oca/dms:/mnt/oca/dms:ro
      - ../../addons/oca/helpdesk:/mnt/oca/helpdesk:ro
      - ../../addons/oca/hr:/mnt/oca/hr:ro
      - ../../addons/oca/hr-expense:/mnt/oca/hr-expense:ro
      - ../../addons/oca/knowledge:/mnt/oca/knowledge:ro
      - ../../addons/oca/mail:/mnt/oca/mail:ro
      - ../../addons/oca/manufacture:/mnt/oca/manufacture:ro
      - ../../addons/oca/mis-builder:/mnt/oca/mis-builder:ro
      - ../../addons/oca/partner-contact:/mnt/oca/partner-contact:ro
      - ../../addons/oca/payroll:/mnt/oca/payroll:ro
      - ../../addons/oca/project:/mnt/oca/project:ro
      - ../../addons/oca/purchase-workflow:/mnt/oca/purchase-workflow:ro
      - ../../addons/oca/queue:/mnt/oca/queue:ro
      - ../../addons/oca/reporting-engine:/mnt/oca/reporting-engine:ro
      - ../../addons/oca/rest-framework:/mnt/oca/rest-framework:ro
      - ../../addons/oca/sale-workflow:/mnt/oca/sale-workflow:ro
      - ../../addons/oca/server-auth:/mnt/oca/server-auth:ro
      - ../../addons/oca/server-backend:/mnt/oca/server-backend:ro
      - ../../addons/oca/server-brand:/mnt/oca/server-brand:ro
      - ../../addons/oca/server-env:/mnt/oca/server-env:ro
      - ../../addons/oca/server-tools:/mnt/oca/server-tools:ro
      - ../../addons/oca/server-ux:/mnt/oca/server-ux:ro
      - ../../addons/oca/social:/mnt/oca/social:ro
      - ../../addons/oca/spreadsheet:/mnt/oca/spreadsheet:ro
      - ../../addons/oca/storage:/mnt/oca/storage:ro
      - ../../addons/oca/timesheet:/mnt/oca/timesheet:ro
      - ../../addons/oca/web:/mnt/oca/web:ro
    networks: [edge]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8069/web/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10

  # --- n8n (DO Managed Postgres) ---
  n8n:
    image: ${N8N_IMAGE}
    container_name: ipai-n8n
    restart: unless-stopped
    env_file: .env
    environment:
      - N8N_HOST=${N8N_DOMAIN}
      - N8N_PORT=5678
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://${N8N_DOMAIN}/
      - GENERIC_TIMEZONE=${N8N_TIMEZONE}
      - TZ=${N8N_TIMEZONE}
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY}

      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=${DO_PG_HOST}
      - DB_POSTGRESDB_PORT=${DO_PG_PORT}
      - DB_POSTGRESDB_DATABASE=${DB_N8N}
      - DB_POSTGRESDB_USER=${DO_PG_USER}
      - DB_POSTGRESDB_PASSWORD=${DO_PG_PASSWORD}
      - DB_POSTGRESDB_SSL_ENABLED=true

      # Optional hardening
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=false
    networks: [edge]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10

  # --- Redis (Superset) ---
  redis:
    image: ${REDIS_IMAGE}
    container_name: ipai-redis
    restart: unless-stopped
    env_file: .env
    ports:
      - "127.0.0.1:${REDIS_PORT}:6379"
    networks: [edge]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 20s
      timeout: 3s
      retries: 10

  # --- Superset (DO Managed Postgres metadata + Redis) ---
  superset:
    image: ${SUPERSET_IMAGE}
    container_name: ipai-superset
    restart: unless-stopped
    env_file: .env
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - SUPERSET_CONFIG_PATH=/app/pythonpath/superset_config.py
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ../superset/superset_config.py:/app/pythonpath/superset_config.py:ro
      - ../superset/entrypoint.sh:/entrypoint.sh:ro
      - superset_home:/app/superset_home
    entrypoint: ["/entrypoint.sh"]
    command: ["gunicorn", "-w", "2", "-k", "gthread", "--timeout", "120", "-b", "0.0.0.0:8088", "superset.app:create_app()"]
    networks: [edge]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8088/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10

  # --- OCR API (stateless; stores outputs elsewhere later) ---
  ocr:
    build:
      context: ../../services/ocr
      dockerfile: Dockerfile
    image: ${OCR_IMAGE}
    container_name: ipai-ocr
    restart: unless-stopped
    env_file: .env
    environment:
      - OCR_ENGINE=${OCR_ENGINE}
    networks: [edge]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 10

networks:
  edge:
    name: ipai-edge

volumes:
  caddy_data:
  caddy_config:
  odoo_filestore:
  superset_home:
