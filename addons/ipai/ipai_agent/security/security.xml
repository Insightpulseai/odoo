<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data noupdate="1">

        <!-- ── Category ─────────────────────────────────────── -->
        <record id="module_category_ipai_agent" model="ir.module.category">
            <field name="name">IPAI Agent</field>
            <field name="sequence">90</field>
        </record>

        <!-- ── Groups ───────────────────────────────────────── -->

        <!-- User: can trigger runs, view own runs -->
        <record id="group_ipai_agent_user" model="res.groups">
            <field name="name">Agent User</field>
            <field name="category_id" ref="module_category_ipai_agent"/>
            <field name="comment">Can trigger IPAI agent runs and view their own run history.</field>
        </record>

        <!-- Approver: can approve/reject waiting_approval runs -->
        <record id="group_ipai_agent_approver" model="res.groups">
            <field name="name">Agent Approver</field>
            <field name="category_id" ref="module_category_ipai_agent"/>
            <field name="implied_ids" eval="[(4, ref('group_ipai_agent_user'))]"/>
            <field name="comment">Can approve or reject runs pending human review.</field>
        </record>

        <!-- Admin: full access including tool/policy configuration -->
        <record id="group_ipai_agent_admin" model="res.groups">
            <field name="name">Agent Admin</field>
            <field name="category_id" ref="module_category_ipai_agent"/>
            <field name="implied_ids" eval="[(4, ref('group_ipai_agent_approver'))]"/>
            <field name="comment">Full CRUD on runs, tools, and policies. Manages ir.config_parameter secrets.</field>
        </record>

    </data>

    <!--
        Record rules (NOT noupdate — must re-apply on module upgrade).

        Multi-company (General settings alignment):
        - Users see only their own runs within their active companies.
        - Approvers/Admins see all runs within their active companies.
        - Record rules are additive (OR'd): a user in approver group gets
          the union of user rule + approver rule = all company runs.

        Domain variables available in record rule evaluation:
          user         — current res.users record
          company_ids  — list of active company IDs for the user
    -->
    <data>

        <!-- Users: own runs only, scoped to active companies -->
        <record id="rule_ipai_agent_run_own" model="ir.rule">
            <field name="name">ipai.agent.run: own runs (user)</field>
            <field name="model_id" ref="model_ipai_agent_run"/>
            <field name="groups" eval="[(4, ref('group_ipai_agent_user'))]"/>
            <field name="domain_force">
                [('requested_by', '=', user.id), ('company_id', 'in', company_ids)]
            </field>
            <field name="perm_read">1</field>
            <field name="perm_write">1</field>
            <field name="perm_create">1</field>
            <field name="perm_unlink">1</field>
        </record>

        <!-- Approvers + Admins: all runs within active companies -->
        <record id="rule_ipai_agent_run_company" model="ir.rule">
            <field name="name">ipai.agent.run: company scope (approver+)</field>
            <field name="model_id" ref="model_ipai_agent_run"/>
            <field name="groups" eval="[(4, ref('group_ipai_agent_approver'))]"/>
            <field name="domain_force">[('company_id', 'in', company_ids)]</field>
            <field name="perm_read">1</field>
            <field name="perm_write">1</field>
            <field name="perm_create">1</field>
            <field name="perm_unlink">1</field>
        </record>

    </data>

</odoo>
