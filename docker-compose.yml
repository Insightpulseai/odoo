# =============================================================================
# Docker Compose: Odoo CE - Canonical Development Environment
# =============================================================================
# This is the ROOT entry point for local development.
#
# Usage:
#   docker compose up -d                    # Start Odoo + PostgreSQL
#   docker compose logs -f odoo-core        # View Odoo logs
#   docker compose exec odoo-core odoo --version  # Check version
#   docker compose down                     # Stop services
#   docker compose down -v                  # Stop and remove volumes
#
# Profiles:
#   docker compose --profile tools up -d    # Include pgAdmin + Mailpit
#   docker compose --profile init up        # Run module initialization
#
# Other compose files:
#   docker-compose.dev.yml     - Full dev stack (Superset, n8n, MCP)
#   docker-compose.odoo19.yml  - Minimal Odoo 19 only
#   docker-compose.shell.yml   - Browser web shell (GAP 4)
#   deploy/docker-compose.prod.yml - Production configuration
# =============================================================================

name: odoo-ce

services:
  # ===========================================================================
  # PostgreSQL 16 - Database Backend
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: odoo-ce-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-odoo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-odoo}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5433}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-odoo}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - odoo-net

  # ===========================================================================
  # Odoo CE 19 - Core ERP System
  # ===========================================================================
  odoo-core:
    image: odoo:19
    container_name: odoo-ce-core
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - HOST=postgres
      - PORT=5432
      - USER=${POSTGRES_USER:-odoo}
      - PASSWORD=${POSTGRES_PASSWORD:-odoo}
    volumes:
      # Odoo data persistence
      - odoo_data:/var/lib/odoo
      - odoo_config:/etc/odoo
      # Custom addons (IPAI modules)
      - ./addons/ipai:/mnt/extra-addons/ipai:ro
      # OCA modules (if available)
      - ./addons/OCA:/mnt/extra-addons/OCA:ro
    ports:
      - "${ODOO_PORT:-8069}:8069"
      - "${ODOO_LONGPOLL_PORT:-8072}:8072"
    command: >
      odoo
      --db_host=postgres
      --db_port=5432
      --db_user=${POSTGRES_USER:-odoo}
      --db_password=${POSTGRES_PASSWORD:-odoo}
      --database=${ODOO_DB:-odoo_dev}
      --addons-path=/usr/lib/python3/dist-packages/odoo/addons,/mnt/extra-addons/ipai,/mnt/extra-addons/OCA
      --log-level=${ODOO_LOG_LEVEL:-info}
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8069/web/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    networks:
      - odoo-net

  # ===========================================================================
  # pgAdmin 4 - Database Administration (optional, via --profile tools)
  # ===========================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: odoo-ce-pgadmin
    profiles: ["tools"]
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@localhost}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - odoo-net

  # ===========================================================================
  # Mailpit - Local Email Testing (optional, via --profile tools)
  # ===========================================================================
  mailpit:
    image: axllent/mailpit:latest
    container_name: odoo-ce-mailpit
    profiles: ["tools"]
    restart: unless-stopped
    ports:
      - "${MAILPIT_WEB_PORT:-8025}:8025"
      - "${MAILPIT_SMTP_PORT:-1025}:1025"
    networks:
      - odoo-net

  # ===========================================================================
  # Module Initialization (one-time, via --profile init)
  # ===========================================================================
  odoo-init:
    image: odoo:19
    container_name: odoo-ce-init
    profiles: ["init"]
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - HOST=postgres
      - PORT=5432
      - USER=${POSTGRES_USER:-odoo}
      - PASSWORD=${POSTGRES_PASSWORD:-odoo}
    volumes:
      - odoo_data:/var/lib/odoo
      - ./addons/ipai:/mnt/extra-addons/ipai:ro
      - ./addons/OCA:/mnt/extra-addons/OCA:ro
    command: >
      odoo
      --db_host=postgres
      --db_port=5432
      --db_user=${POSTGRES_USER:-odoo}
      --db_password=${POSTGRES_PASSWORD:-odoo}
      --database=${ODOO_DB:-odoo_dev}
      --addons-path=/usr/lib/python3/dist-packages/odoo/addons,/mnt/extra-addons/ipai,/mnt/extra-addons/OCA
      -i base
      --stop-after-init
      --without-demo=all
    networks:
      - odoo-net

volumes:
  postgres_data:
    name: odoo-ce-postgres-data
  odoo_data:
    name: odoo-ce-odoo-data
  odoo_config:
    name: odoo-ce-odoo-config
  pgadmin_data:
    name: odoo-ce-pgadmin-data

networks:
  odoo-net:
    name: odoo-ce-network
    driver: bridge
