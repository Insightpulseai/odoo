# ==============================================================================
# Docker Compose Dev Container Override
# ==============================================================================
# Dev-specific overrides for VS Code Dev Containers
# This file extends the main docker-compose.yml with dev-friendly settings
#
# Used by: .devcontainer/devcontainer.json
# Extends: ../docker-compose.yml
# ==============================================================================

version: '3.8'

services:
  # ===========================================================================
  # Odoo — Dev Container Overrides
  # ===========================================================================
  odoo:
    # Override to enable full dev mode
    working_dir: /workspaces/odoo
    environment:
      - ODOO_DEV_MODE=all
      - ODOO_LOG_LEVEL=debug

    # Dev-specific command with all debugging enabled.
    # addons-path uses /workspaces/odoo for ipai (hot-reload from canonical root)
    # and /mnt/oca/* for OCA repos (mounted via main docker-compose.yml).
    command: >
      odoo
      --db_host=db
      --db_port=5432
      --db_user=${POSTGRES_USER:-odoo}
      --db_password=${POSTGRES_PASSWORD:-odoo}
      --database=${ODOO_DB:-odoo_dev}
      --addons-path=/usr/lib/python3/dist-packages/odoo/addons,/mnt/oca/server-tools,/mnt/oca/server-ux,/mnt/oca/web,/mnt/oca/automation,/mnt/oca/account-financial-tools,/mnt/oca/account-financial-reporting,/mnt/oca/project,/mnt/oca/queue,/mnt/oca/reporting-engine,/mnt/oca/sale-workflow,/mnt/oca/purchase-workflow,/mnt/oca/server-backend,/mnt/oca/mis-builder,/mnt/oca/spreadsheet,/mnt/oca/knowledge,/mnt/oca/dms,/mnt/oca/rest-framework,/mnt/oca/social,/mnt/oca/account-reconcile,/mnt/oca/hr-expense,/mnt/oca/contract,/mnt/oca/timesheet,/mnt/oca/connector,/mnt/oca/storage,/mnt/oca/ai,/workspaces/odoo/addons/ipai
      --log-level=debug
      --dev=all
      --log-handler=:DEBUG

    # Mount workspace for Dev Container (single repo root — no duplicate addons mounts)
    volumes:
      - ../:/workspaces/odoo:cached
      - odoo-web-data:/var/lib/odoo

  # ===========================================================================
  # PostgreSQL — Dev Container Overrides
  # ===========================================================================
  db:
    # Expose port for direct database access from host
    ports:
      - "${POSTGRES_PORT:-5433}:5432"

    # Dev-friendly PostgreSQL settings
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-odoo}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-odoo}
      POSTGRES_DB: ${POSTGRES_DB:-odoo}

  # ===========================================================================
  # Redis — Dev Container Overrides
  # ===========================================================================
  redis:
    # Expose port for inspection tools
    ports:
      - "6379:6379"

volumes:
  odoo-web-data:
    name: odoo-devcontainer-data
