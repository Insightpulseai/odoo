name: Cloudflare Authority Gate

# =============================================================================
# Prevents DNS record changes from merging when Cloudflare is NOT the
# authoritative DNS for insightpulseai.com.
#
# Why: Committing DNS records to infra/cloudflare/ has zero effect if the
# domain's nameservers still point to the old registrar (Spacesquare).
# This gate makes that condition explicit and visible on every PR.
#
# Pass: Cloudflare NS delegation is live → PR may merge.
# Fail: Old NS delegation → PR blocked with actionable message.
#
# Secrets required: none (NS/SOA check is a public DNS query).
# Bypass: If NS delegation is genuinely in progress, add label "cf-ns-pending"
#         to the PR — the gate will warn but not block.
# =============================================================================

on:
  pull_request:
    paths:
      - "infra/cloudflare/**"
      - "infra/dns/**"
      - "ssot/secrets/registry.yaml"
  workflow_dispatch:
    inputs:
      domain:
        description: "Domain to check (default: insightpulseai.com)"
        required: false
        default: "insightpulseai.com"

permissions:
  contents: read
  pull-requests: write

jobs:
  authority-check:
    name: Verify Cloudflare is authoritative
    runs-on: ubuntu-latest
    env:
      VERIFY_DOMAIN: ${{ github.event.inputs.domain || 'insightpulseai.com' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dig (dnsutils)
        run: sudo apt-get install -y dnsutils

      - name: Check Cloudflare authority
        id: authority
        run: |
          python3 scripts/cloudflare/verify_authoritative.py \
            --domain "$VERIFY_DOMAIN" \
            2>&1 | tee /tmp/authority_check.log
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
        continue-on-error: true

      - name: Read check result
        id: result
        run: |
          if grep -q "✅ PASS" /tmp/authority_check.log; then
            echo "authoritative=true" >> "$GITHUB_OUTPUT"
          else
            echo "authoritative=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check for bypass label
        id: bypass
        if: steps.result.outputs.authoritative == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LABELS=$(gh pr view "${{ github.event.pull_request.number }}" \
            --json labels --jq '.labels[].name' 2>/dev/null || echo "")
          if echo "$LABELS" | grep -q "cf-ns-pending"; then
            echo "bypassed=true" >> "$GITHUB_OUTPUT"
            echo "⚠️  Bypass label 'cf-ns-pending' found — gate warning only, not blocking."
          else
            echo "bypassed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Post PR comment (if not authoritative)
        if: steps.result.outputs.authoritative == 'false' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ❌ Cloudflare Authority Gate — FAILED

**Cloudflare is NOT currently the authoritative DNS for \`insightpulseai.com\`.**

DNS record changes committed to \`infra/cloudflare/zones/\` will have **no effect** until Cloudflare nameservers are delegated.

### Required action (one-time, at registrar)

1. Log into **Spacesquare** (domain registrar)
2. Set nameservers to:
   - \`edna.ns.cloudflare.com\`
   - \`keanu.ns.cloudflare.com\`
3. Wait for NS propagation (up to 24-48 hours)
4. Re-run this check: trigger the **Cloudflare Authority Gate** workflow manually

### While delegation is pending

Add label **\`cf-ns-pending\`** to this PR to convert the gate from blocking to warning-only.
DNS record commits are still safe to merge — they will apply once delegation completes.

---
*Check log:*
\`\`\`
${require('fs').readFileSync('/tmp/authority_check.log', 'utf8').slice(0, 2000)}
\`\`\`
`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });

      - name: Fail gate (if not authoritative and not bypassed)
        if: steps.result.outputs.authoritative == 'false' && steps.bypass.outputs.bypassed != 'true'
        run: |
          echo "::error::Cloudflare is NOT authoritative for $VERIFY_DOMAIN."
          echo "::error::DNS record changes will have no effect until NS delegation is complete."
          echo "::error::See PR comment for remediation steps, or add label 'cf-ns-pending' to bypass."
          exit 1

      - name: Warn (bypassed)
        if: steps.result.outputs.authoritative == 'false' && steps.bypass.outputs.bypassed == 'true'
        run: |
          echo "::warning::Cloudflare is NOT authoritative for $VERIFY_DOMAIN (bypass active via 'cf-ns-pending' label)."
          echo "::warning::DNS record commits will apply once NS delegation completes."

      - name: Pass
        if: steps.result.outputs.authoritative == 'true'
        run: |
          echo "✅ Cloudflare is authoritative for $VERIFY_DOMAIN — DNS changes will apply on merge."
