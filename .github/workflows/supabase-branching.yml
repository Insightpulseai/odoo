# =============================================================================
# Supabase Branching Workflow
# =============================================================================
# Integrates with Supabase's native branching feature to create isolated
# preview environments for each git branch.
#
# Prerequisites:
#   1. Enable Supabase GitHub integration in dashboard
#   2. Connect repository to Supabase project
#   3. Enable "Branching via dashboard" feature preview
#
# PHASE_REQUIRES_UI(GitHub integration setup):
#   - Go to Supabase Dashboard > Project Settings > Integrations
#   - Connect GitHub repository
#   - Enable branching in Project Settings > Branching
# =============================================================================

name: Supabase Branching

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - 'supabase/**'
      - '.github/workflows/supabase-branching.yml'

  push:
    branches:
      - 'feature/*'
      - 'claude/*'
      - 'fix/*'
    paths:
      - 'supabase/**'

  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'status'
        type: choice
        options:
          - status
          - create
          - delete
          - reset

concurrency:
  group: supabase-branch-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: false

env:
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
  SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

jobs:
  # ===========================================================================
  # Validate Branch Configuration
  # ===========================================================================
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    outputs:
      branch_name: ${{ steps.branch.outputs.name }}
      is_feature_branch: ${{ steps.branch.outputs.is_feature }}
      has_migrations: ${{ steps.check.outputs.has_migrations }}
      has_functions: ${{ steps.check.outputs.has_functions }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH="${{ github.head_ref }}"
          else
            BRANCH="${{ github.ref_name }}"
          fi

          # Sanitize branch name for Supabase (alphanumeric + hyphens)
          SAFE_BRANCH=$(echo "$BRANCH" | sed 's/[^a-zA-Z0-9-]/-/g' | cut -c1-63)

          echo "name=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          echo "Branch name: $SAFE_BRANCH"

          # Check if feature branch
          if [[ "$BRANCH" =~ ^(feature|claude|fix)/ ]]; then
            echo "is_feature=true" >> $GITHUB_OUTPUT
          else
            echo "is_feature=false" >> $GITHUB_OUTPUT
          fi

      - name: Check for changes
        id: check
        run: |
          # Check for migration changes
          if git diff --name-only origin/main...HEAD | grep -q "supabase/migrations/"; then
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "Found migration changes"
          else
            echo "has_migrations=false" >> $GITHUB_OUTPUT
          fi

          # Check for function changes
          if git diff --name-only origin/main...HEAD | grep -q "supabase/functions/"; then
            echo "has_functions=true" >> $GITHUB_OUTPUT
            echo "Found function changes"
          else
            echo "has_functions=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate secrets
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ]; then
            echo "::error::SUPABASE_ACCESS_TOKEN not configured"
            exit 1
          fi
          if [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "::error::SUPABASE_PROJECT_REF not configured"
            exit 1
          fi
          echo "Secrets validated"

  # ===========================================================================
  # Create/Update Preview Branch
  # ===========================================================================
  preview-branch:
    name: Preview Branch
    runs-on: ubuntu-latest
    needs: validate
    if: |
      needs.validate.outputs.is_feature_branch == 'true' &&
      github.event.action != 'closed'

    outputs:
      preview_url: ${{ steps.branch-info.outputs.url }}
      preview_ref: ${{ steps.branch-info.outputs.ref }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to project
        run: |
          supabase link --project-ref $SUPABASE_PROJECT_REF

      - name: Get or create preview branch
        id: branch-info
        run: |
          BRANCH_NAME="${{ needs.validate.outputs.branch_name }}"

          echo "Checking for existing preview branch: $BRANCH_NAME"

          # List existing branches
          BRANCHES=$(supabase branches list --json 2>/dev/null || echo '[]')

          # Check if branch exists
          EXISTING=$(echo "$BRANCHES" | jq -r ".[] | select(.name == \"$BRANCH_NAME\") | .id" || echo "")

          if [ -n "$EXISTING" ]; then
            echo "Preview branch exists: $EXISTING"
            BRANCH_REF="$EXISTING"
          else
            echo "Creating new preview branch: $BRANCH_NAME"
            # Note: Branch creation happens automatically via GitHub integration
            # This is a fallback for manual triggers
            supabase branches create "$BRANCH_NAME" --json 2>/dev/null || true
            BRANCH_REF="$BRANCH_NAME"
          fi

          # Get branch URL (format: https://<branch-ref>.supabase.co)
          PREVIEW_URL="https://${BRANCH_REF}.supabase.co"

          echo "ref=$BRANCH_REF" >> $GITHUB_OUTPUT
          echo "url=$PREVIEW_URL" >> $GITHUB_OUTPUT

          echo "Preview branch reference: $BRANCH_REF"
          echo "Preview URL: $PREVIEW_URL"

      - name: Apply migrations to preview
        if: needs.validate.outputs.has_migrations == 'true'
        run: |
          echo "Applying migrations to preview branch..."

          # Dry run first
          supabase db push --dry-run

          # Apply migrations
          supabase db push

          echo "Migrations applied successfully"

      - name: Deploy Edge Functions to preview
        if: needs.validate.outputs.has_functions == 'true'
        run: |
          echo "Deploying Edge Functions to preview branch..."

          # Get list of functions from config
          FUNCTIONS=$(grep -E "^\[functions\." supabase/config.toml | sed 's/\[functions\.\(.*\)\]/\1/' || echo "")

          for func in $FUNCTIONS; do
            echo "Deploying function: $func"
            # Check if function requires JWT verification
            VERIFY=$(grep -A1 "\[functions\.$func\]" supabase/config.toml | grep "verify_jwt" | cut -d'=' -f2 | tr -d ' ')

            if [ "$VERIFY" = "false" ]; then
              supabase functions deploy "$func" --no-verify-jwt
            else
              supabase functions deploy "$func"
            fi
          done

          echo "Edge Functions deployed"

      - name: Seed preview branch
        run: |
          if [ -f "supabase/seed.sql" ]; then
            echo "Applying seed data to preview branch..."
            # Note: Seeding happens automatically on branch creation
            # This is for manual re-seeding
            supabase db seed --file supabase/seed.sql || echo "Seeding skipped (may already be seeded)"
          fi

      - name: Post preview URL to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.branch-info.outputs.url }}';
            const previewRef = '${{ steps.branch-info.outputs.ref }}';

            const body = `## Supabase Preview Branch

            | Property | Value |
            |----------|-------|
            | Branch | \`${previewRef}\` |
            | API URL | ${previewUrl} |
            | Studio | https://supabase.com/dashboard/project/${previewRef} |

            ### Environment Variables
            \`\`\`bash
            NEXT_PUBLIC_SUPABASE_URL=${previewUrl}
            SUPABASE_URL=${previewUrl}
            \`\`\`

            > Preview branches are isolated environments with their own database, Auth, and Edge Functions.
            `;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('Supabase Preview Branch')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }

  # ===========================================================================
  # Cleanup Preview Branch (on PR close/merge)
  # ===========================================================================
  cleanup:
    name: Cleanup Preview Branch
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to project
        run: |
          supabase link --project-ref $SUPABASE_PROJECT_REF

      - name: Delete preview branch
        run: |
          BRANCH_NAME="${{ needs.validate.outputs.branch_name }}"
          echo "Deleting preview branch: $BRANCH_NAME"

          # Delete the preview branch
          supabase branches delete "$BRANCH_NAME" --confirm 2>/dev/null || echo "Branch may not exist or already deleted"

          echo "Preview branch cleanup complete"

      - name: Comment on PR
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## Supabase Branch Merged\n\nPreview branch has been deleted. Changes are now deployed to production via the main branch workflow.'
            });

  # ===========================================================================
  # Production Deploy (on merge to main)
  # ===========================================================================
  production-deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true

    steps:
      - uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link to production project
        run: |
          supabase link --project-ref $SUPABASE_PROJECT_REF

      - name: Deploy migrations to production
        run: |
          echo "Deploying migrations to production..."
          supabase db push
          echo "Production migrations complete"

      - name: Deploy Edge Functions to production
        run: |
          echo "Deploying Edge Functions to production..."

          # Get list of functions from config
          FUNCTIONS=$(grep -E "^\[functions\." supabase/config.toml | sed 's/\[functions\.\(.*\)\]/\1/' || echo "")

          for func in $FUNCTIONS; do
            VERIFY=$(grep -A1 "\[functions\.$func\]" supabase/config.toml | grep "verify_jwt" | cut -d'=' -f2 | tr -d ' ')
            if [ "$VERIFY" = "false" ]; then
              supabase functions deploy "$func" --no-verify-jwt
            else
              supabase functions deploy "$func"
            fi
          done

          echo "Production Edge Functions deployed"

      - name: Verify production health
        run: |
          echo "Verifying production health..."

          # Check API health
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            "https://$SUPABASE_PROJECT_REF.supabase.co/rest/v1/" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "Production API healthy: HTTP $HTTP_STATUS"
          else
            echo "::warning::Production API returned HTTP $HTTP_STATUS"
          fi

  # ===========================================================================
  # Summary
  # ===========================================================================
  summary:
    name: Workflow Summary
    runs-on: ubuntu-latest
    needs: [validate, preview-branch]
    if: always() && needs.validate.result == 'success'

    steps:
      - name: Generate summary
        run: |
          echo "## Supabase Branching Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ needs.validate.outputs.branch_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Is Feature | ${{ needs.validate.outputs.is_feature_branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Has Migrations | ${{ needs.validate.outputs.has_migrations }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Has Functions | ${{ needs.validate.outputs.has_functions }} |" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.preview-branch.result }}" = "success" ]; then
            echo "| Preview URL | ${{ needs.preview-branch.outputs.preview_url }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Preview Status | Created/Updated |" >> $GITHUB_STEP_SUMMARY
          fi
