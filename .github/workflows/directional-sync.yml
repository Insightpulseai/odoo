name: Directional Sync Automation

on:
  workflow_dispatch:
    inputs:
      direction:
        description: 'Sync direction filter (pull, push, bidirectional, or leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - pull
          - push
          - bidirectional
      target:
        description: 'Target pattern (e.g., "oca_*", "notion_*", or leave empty for all)'
        required: false
        type: string
      dry_run:
        description: 'Dry run mode (no changes made)'
        required: false
        type: boolean
        default: false
      verify:
        description: 'Enable verification checks'
        required: false
        type: boolean
        default: true

  # Scheduled runs matching sync.yaml schedules
  schedule:
    # OCA repos: Daily at 2 AM UTC
    - cron: '0 2 * * *'
    # Apps truth: Every 6 hours
    - cron: '0 */6 * * *'
    # Live to docs: Every 12 hours
    - cron: '0 */12 * * *'
    # Claude config: Daily at 4 AM UTC
    - cron: '0 4 * * *'
    # Skillsmith catalog: Weekly on Sunday at 5 AM
    - cron: '0 5 * * 0'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Determine sync targets
        id: targets
        run: |
          # Map scheduled runs to target patterns
          if [ "${{ github.event_name }}" = "schedule" ]; then
            HOUR=$(date -u +%H)
            WEEKDAY=$(date -u +%u)

            # Match cron schedule to target
            if [ "$HOUR" = "02" ]; then
              echo "target=oca_repos" >> $GITHUB_OUTPUT
              echo "direction=pull" >> $GITHUB_OUTPUT
            elif [ "$((HOUR % 6))" = "0" ]; then
              echo "target=apps_truth" >> $GITHUB_OUTPUT
              echo "direction=pull" >> $GITHUB_OUTPUT
            elif [ "$((HOUR % 12))" = "0" ] && [ "$HOUR" != "00" ]; then
              echo "target=live_to_docs" >> $GITHUB_OUTPUT
              echo "direction=pull" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "04" ]; then
              echo "target=claude_config" >> $GITHUB_OUTPUT
              echo "direction=bidirectional" >> $GITHUB_OUTPUT
            elif [ "$HOUR" = "05" ] && [ "$WEEKDAY" = "7" ]; then
              echo "target=skillsmith_catalog" >> $GITHUB_OUTPUT
              echo "direction=pull" >> $GITHUB_OUTPUT
            else
              echo "target=" >> $GITHUB_OUTPUT
              echo "direction=" >> $GITHUB_OUTPUT
            fi
          else
            # Manual trigger - use inputs
            echo "target=${{ github.event.inputs.target }}" >> $GITHUB_OUTPUT
            echo "direction=${{ github.event.inputs.direction }}" >> $GITHUB_OUTPUT
          fi

      - name: Run directional sync
        run: |
          # Build command
          CMD="python scripts/sync_directional.py --ci"

          # Add target if specified
          if [ -n "${{ steps.targets.outputs.target }}" ]; then
            CMD="$CMD --target '${{ steps.targets.outputs.target }}'"
          fi

          # Add direction if specified
          if [ -n "${{ steps.targets.outputs.direction }}" ]; then
            CMD="$CMD --direction ${{ steps.targets.outputs.direction }}"
          fi

          # Add dry-run if specified
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            CMD="$CMD --dry-run"
          fi

          # Add verify if specified (default true for manual runs)
          if [ "${{ github.event.inputs.verify }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            CMD="$CMD --verify"
          fi

          # Execute
          echo "Running: $CMD"
          eval $CMD

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes (PULL operations only)
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          # Only commit if there are actual changes
          git add -A

          # Create commit message
          TARGET="${{ steps.targets.outputs.target }}"
          if [ -z "$TARGET" ]; then
            TARGET="multiple targets"
          fi

          git commit -m "chore(sync): automated sync for $TARGET [skip ci]"
          git push origin main

      - name: Upload sync summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-summary-${{ github.run_id }}
          path: |
            sync_summary_*.json
            docs/claude-config-drift.md
          retention-days: 7
          if-no-files-found: ignore

      - name: Comment on workflow run (manual triggers only)
        if: github.event_name == 'workflow_dispatch' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summaryFiles = fs.readdirSync('.').filter(f => f.startsWith('sync_summary_'));

            if (summaryFiles.length > 0) {
              const summaryPath = summaryFiles[0];
              const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));

              let comment = `## Directional Sync Summary\n\n`;
              comment += `**Total Targets**: ${summary.total_targets}\n`;
              comment += `**Successful**: ${summary.successful}\n`;
              comment += `**Failed**: ${summary.failed}\n`;
              comment += `**Duration**: ${summary.total_duration.toFixed(2)}s\n\n`;

              if (summary.results.length > 0) {
                comment += `### Results\n\n`;
                summary.results.forEach(result => {
                  const icon = result.success ? '✅' : '❌';
                  comment += `${icon} **${result.target}** (${result.direction}) - ${result.message}\n`;
                });
              }

              console.log(comment);
            }
