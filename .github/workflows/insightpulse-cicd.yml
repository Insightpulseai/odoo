# =============================================================================
# GitHub Actions: InsightPulse Unified CI/CD
# =============================================================================
# Orchestrates deployment of all stack components:
#   - Supabase (migrations, edge functions)
#   - Odoo CE (modules, Docker image)
#   - n8n (workflow sync)
#
# Uses path-based change detection to deploy only modified components.
#
# Architecture:
#   GitHub → detect-changes → [deploy-supabase, deploy-odoo, sync-n8n] → notify
#
# Required Secrets:
#   - SUPABASE_ACCESS_TOKEN, SUPABASE_DB_PASSWORD, SUPABASE_PROJECT_ID
#   - SSH_PRIVATE_KEY, SSH_HOST, SSH_USER (for Odoo deployment)
#   - N8N_API_URL, N8N_API_KEY, N8N_WEBHOOK_URL
#   - GHCR_TOKEN (for Docker registry)
# =============================================================================

name: InsightPulse CI/CD

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'supabase/**'
      - 'addons/**'
      - 'n8n/**'
      - 'docker/**'
      - 'docker-compose*.yml'
      - 'Dockerfile*'
  workflow_dispatch:
    inputs:
      component:
        description: 'Component to deploy'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - supabase
          - odoo
          - n8n
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

concurrency:
  group: insightpulse-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: jgtolentino/odoo-ce
  SUPABASE_PROJECT_ID: spdtwktxdalcfigzeqrz

jobs:
  # ===========================================================================
  # Detect Changes
  # ===========================================================================
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      supabase: ${{ steps.filter.outputs.supabase }}
      odoo: ${{ steps.filter.outputs.odoo }}
      n8n: ${{ steps.filter.outputs.n8n }}
      docker: ${{ steps.filter.outputs.docker }}
      any_changes: ${{ steps.summary.outputs.any_changes }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            supabase:
              - 'supabase/migrations/**'
              - 'supabase/functions/**'
              - 'supabase/seed/**'
            odoo:
              - 'addons/**'
              - 'docker/**'
              - 'Dockerfile*'
              - 'docker-compose*.yml'
            n8n:
              - 'n8n/**'
            docker:
              - 'docker/**'
              - 'Dockerfile*'
              - 'docker-compose*.yml'

      - name: Summarize changes
        id: summary
        run: |
          echo "## Change Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase | ${{ steps.filter.outputs.supabase == 'true' && '✅ Yes' || '⏭️ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Odoo | ${{ steps.filter.outputs.odoo == 'true' && '✅ Yes' || '⏭️ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| n8n | ${{ steps.filter.outputs.n8n == 'true' && '✅ Yes' || '⏭️ No' }} |" >> $GITHUB_STEP_SUMMARY

          # Check if any component has changes
          if [ "${{ steps.filter.outputs.supabase }}" = "true" ] || \
             [ "${{ steps.filter.outputs.odoo }}" = "true" ] || \
             [ "${{ steps.filter.outputs.n8n }}" = "true" ]; then
            echo "any_changes=true" >> $GITHUB_OUTPUT
          else
            echo "any_changes=false" >> $GITHUB_OUTPUT
          fi

  # ===========================================================================
  # Deploy Supabase
  # ===========================================================================
  deploy-supabase:
    name: Deploy Supabase
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.supabase == 'true' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.component == 'all' || github.event.inputs.component == 'supabase'))

    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Set environment
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.event.inputs.environment }}" == "production" ]; then
            echo "project_id=${{ secrets.SUPABASE_PROJECT_ID || env.SUPABASE_PROJECT_ID }}" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "project_id=${{ secrets.SUPABASE_PROJECT_ID_STAGING || secrets.SUPABASE_PROJECT_ID || env.SUPABASE_PROJECT_ID }}" >> $GITHUB_OUTPUT
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

      - name: Link Supabase project
        run: supabase link --project-ref ${{ steps.env.outputs.project_id }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Push migrations
        run: |
          echo "## Supabase Migration" >> $GITHUB_STEP_SUMMARY
          supabase db push 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}

      - name: Deploy edge functions
        run: |
          if [ -d "supabase/functions" ] && [ "$(ls -A supabase/functions 2>/dev/null)" ]; then
            echo "## Edge Functions" >> $GITHUB_STEP_SUMMARY
            supabase functions deploy 2>&1 | tee -a $GITHUB_STEP_SUMMARY || true
          fi
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # ===========================================================================
  # Deploy Odoo
  # ===========================================================================
  deploy-odoo:
    name: Deploy Odoo
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.odoo == 'true' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.component == 'all' || github.event.inputs.component == 'odoo'))

    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      url: https://erp.insightpulseai.net

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        if: needs.detect-changes.outputs.docker == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.unified
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref == 'refs/heads/main' && 'latest' || 'edge' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to server
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$SSH_HOST" ]; then
            echo "::warning::SSH secrets not configured. Skipping remote deployment."
            echo "## Odoo Deployment Skipped" >> $GITHUB_STEP_SUMMARY
            echo "Configure SSH_PRIVATE_KEY, SSH_HOST, SSH_USER secrets to enable." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          # Setup SSH
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          echo "## Odoo Deployment" >> $GITHUB_STEP_SUMMARY

          ssh -i ~/.ssh/deploy_key "$SSH_USER@$SSH_HOST" << 'DEPLOY_SCRIPT'
            set -e
            cd /opt/odoo-ce

            # Pull latest
            git fetch origin
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            # Update submodules
            git submodule update --init --recursive

            # Pull and restart
            docker compose pull
            docker compose up -d --force-recreate

            # Health check
            sleep 30
            curl -sf http://localhost:8069/web/health || echo "Health check pending..."
          DEPLOY_SCRIPT

          echo "✅ Deployment complete" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Sync n8n Workflows
  # ===========================================================================
  sync-n8n:
    name: Sync n8n
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.n8n == 'true' ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.component == 'all' || github.event.inputs.component == 'n8n'))

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate n8n workflows
        run: |
          echo "## n8n Workflow Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for file in n8n/**/*.json; do
            if [ -f "$file" ]; then
              if python3 -c "import json; json.load(open('$file'))" 2>/dev/null; then
                workflow_name=$(python3 -c "import json; print(json.load(open('$file')).get('name', 'Unknown'))" 2>/dev/null || echo "Unknown")
                echo "- ✅ \`$workflow_name\`" >> $GITHUB_STEP_SUMMARY
              else
                echo "- ❌ Invalid JSON: \`$file\`" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          done

      - name: Sync to n8n instance
        run: |
          N8N_URL="${{ secrets.N8N_API_URL }}"
          N8N_KEY="${{ secrets.N8N_API_KEY }}"

          if [ -z "$N8N_URL" ] || [ -z "$N8N_KEY" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ N8N_API_URL/N8N_API_KEY not configured. Sync skipped." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Sync Results" >> $GITHUB_STEP_SUMMARY

          # Sync logic here (simplified - full logic in n8n-orchestrator.yml)
          echo "✅ Workflows validated and ready for sync" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Post-Deployment Notifications
  # ===========================================================================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-supabase, deploy-odoo, sync-n8n]
    if: always()

    steps:
      - name: Notify n8n webhook
        run: |
          WEBHOOK_URL="${{ secrets.N8N_WEBHOOK_URL }}"

          if [ -z "$WEBHOOK_URL" ]; then
            echo "N8N_WEBHOOK_URL not configured"
            exit 0
          fi

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "event": "insightpulse_deployment",
              "environment": "${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}",
              "components": {
                "supabase": "${{ needs.deploy-supabase.result }}",
                "odoo": "${{ needs.deploy-odoo.result }}",
                "n8n": "${{ needs.sync-n8n.result }}"
              },
              "commit": "${{ github.sha }}",
              "branch": "${{ github.ref_name }}",
              "actor": "${{ github.actor }}",
              "run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "timestamp": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'"
            }' || echo "Webhook failed (non-critical)"

      - name: Generate deployment summary
        run: |
          echo "## InsightPulse CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.ref == 'refs/heads/main' && 'Production' || 'Staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Component Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Supabase | ${{ needs.deploy-supabase.result == 'success' && '✅' || needs.deploy-supabase.result == 'skipped' && '⏭️' || '❌' }} ${{ needs.deploy-supabase.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Odoo | ${{ needs.deploy-odoo.result == 'success' && '✅' || needs.deploy-odoo.result == 'skipped' && '⏭️' || '❌' }} ${{ needs.deploy-odoo.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| n8n | ${{ needs.sync-n8n.result == 'success' && '✅' || needs.sync-n8n.result == 'skipped' && '⏭️' || '❌' }} ${{ needs.sync-n8n.result }} |" >> $GITHUB_STEP_SUMMARY
