<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Finance Kanban Board View for Project Tasks -->
    <record id="view_finance_task_kanban" model="ir.ui.view">
        <field name="name">finance.task.kanban</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <kanban default_group_by="finance_state" class="o_kanban_small_column o_kanban_project_tasks">
                <field name="id"/>
                <field name="name"/>
                <field name="finance_state"/>
                <field name="is_closing_task"/>
                <field name="is_compliance_task"/>
                <field name="deadline_date"/>
                <field name="date_deadline"/>
                <field name="user_id"/>
                <field name="color"/>
                <field name="finance_category"/>
                <progressbar field="finance_state"
                    colors='{"draft": "muted", "active": "warning", "review": "danger", "done": "success"}'/>

                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_global_click #{record.color.raw_value ? 'oe_kanban_color_' + record.color.raw_value : ''}">
                            <div class="oe_kanban_content">
                                <!-- Header with badges -->
                                <div class="o_kanban_record_top mb-2">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                    </div>
                                    <div class="o_kanban_record_top_right">
                                        <t t-if="record.is_compliance_task.raw_value">
                                            <span class="badge text-bg-danger me-1">Tax</span>
                                        </t>
                                        <t t-if="record.is_closing_task.raw_value">
                                            <span class="badge text-bg-primary">Close</span>
                                        </t>
                                    </div>
                                </div>

                                <!-- Finance Category Badge -->
                                <div class="o_kanban_record_body" t-if="record.finance_category.raw_value">
                                    <field name="finance_category" widget="badge"
                                        decoration-info="finance_category == 'foundation_corp'"
                                        decoration-success="finance_category == 'revenue_wip'"
                                        decoration-warning="finance_category == 'vat_tax'"
                                        decoration-danger="finance_category == 'compliance'"/>
                                </div>

                                <!-- Footer with deadline and assignee -->
                                <div class="o_kanban_record_bottom mt-2">
                                    <div class="oe_kanban_bottom_left">
                                        <t t-if="record.deadline_date.raw_value">
                                            <field name="deadline_date" widget="remaining_days"/>
                                        </t>
                                        <t t-elif="record.date_deadline.raw_value">
                                            <field name="date_deadline" widget="remaining_days"/>
                                        </t>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="user_id" widget="many2one_avatar_user"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Finance Kanban Board Action -->
    <record id="action_finance_kanban_board" model="ir.actions.act_window">
        <field name="name">Finance Kanban Board</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">kanban,tree,form,calendar</field>
        <field name="view_id" ref="view_finance_task_kanban"/>
        <field name="domain">[('is_finance_ppm', '=', True)]</field>
        <field name="context">{
            'default_is_finance_ppm': True,
            'default_finance_state': 'draft',
            'search_default_filter_not_done': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create your first finance task!
            </p>
            <p>
                Track month-end close, tax compliance, and finance workflows
                with a visual Kanban board.
            </p>
        </field>
    </record>

    <!-- Month-End Close Tasks Action -->
    <record id="action_closing_tasks_kanban" model="ir.actions.act_window">
        <field name="name">Month-End Close Tasks</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="view_id" ref="view_finance_task_kanban"/>
        <field name="domain">[('is_closing_task', '=', True)]</field>
        <field name="context">{
            'default_is_closing_task': True,
            'default_finance_state': 'draft'
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No month-end close tasks found
            </p>
            <p>
                Use the Finance Close automation to generate month-end tasks.
            </p>
        </field>
    </record>

    <!-- Tax Compliance Tasks Action -->
    <record id="action_compliance_tasks_kanban" model="ir.actions.act_window">
        <field name="name">Tax Compliance Tasks</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="view_id" ref="view_finance_task_kanban"/>
        <field name="domain">[('is_compliance_task', '=', True)]</field>
        <field name="context">{
            'default_is_compliance_task': True,
            'default_finance_state': 'draft'
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No tax compliance tasks found
            </p>
            <p>
                Create BIR compliance tasks to track tax filing deadlines.
            </p>
        </field>
    </record>

    <!-- Search View with Kanban-specific filters -->
    <record id="view_finance_task_kanban_search" model="ir.ui.view">
        <field name="name">finance.task.kanban.search</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_search_form"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <separator/>
                <filter string="Draft" name="filter_draft" domain="[('finance_state', '=', 'draft')]"/>
                <filter string="In Progress" name="filter_active" domain="[('finance_state', '=', 'active')]"/>
                <filter string="Under Review" name="filter_review" domain="[('finance_state', '=', 'review')]"/>
                <filter string="Closed" name="filter_done" domain="[('finance_state', '=', 'done')]"/>
                <filter string="Not Closed" name="filter_not_done" domain="[('finance_state', '!=', 'done')]"/>
                <separator/>
                <filter string="Month-End Close" name="filter_closing" domain="[('is_closing_task', '=', True)]"/>
                <filter string="Tax Compliance" name="filter_compliance" domain="[('is_compliance_task', '=', True)]"/>
                <separator/>
                <filter string="Overdue" name="filter_overdue"
                    domain="[('deadline_date', '&lt;', context_today().strftime('%Y-%m-%d')), ('finance_state', '!=', 'done')]"/>
                <filter string="Due This Week" name="filter_due_week"
                    domain="[('deadline_date', '&gt;=', context_today().strftime('%Y-%m-%d')),
                             ('deadline_date', '&lt;=', (context_today() + datetime.timedelta(days=7)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <group expand="0" string="Group By">
                    <filter string="Finance State" name="group_finance_state" context="{'group_by': 'finance_state'}"/>
                    <filter string="Closing Task" name="group_closing" context="{'group_by': 'is_closing_task'}"/>
                    <filter string="Compliance Task" name="group_compliance" context="{'group_by': 'is_compliance_task'}"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Extend task form with Kanban state controls -->
    <record id="view_task_form_finance_kanban_inherit" model="ir.ui.view">
        <field name="name">project.task.form.finance.kanban.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="priority">50</field>
        <field name="arch" type="xml">
            <!-- Add Finance State widget to header -->
            <xpath expr="//header" position="inside">
                <field name="finance_state" widget="statusbar"
                    statusbar_visible="draft,active,review,done"
                    clickable="1"/>
            </xpath>

            <!-- Add toggle badges in button box -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" type="object" name="toggle_is_closing_task" icon="fa-calendar-check-o">
                    <field name="is_closing_task" widget="boolean_button"
                        options='{"terminology": {"string_true": "Month-End", "string_false": "Month-End"}}'/>
                </button>
                <button class="oe_stat_button" type="object" name="toggle_is_compliance_task" icon="fa-gavel">
                    <field name="is_compliance_task" widget="boolean_button"
                        options='{"terminology": {"string_true": "Tax Compliance", "string_false": "Tax Compliance"}}'/>
                </button>
            </xpath>
        </field>
    </record>

    <!-- Recurrence Rule Views -->
    <record id="view_finance_recurrence_tree" model="ir.ui.view">
        <field name="name">finance.recurrence.rule.tree</field>
        <field name="model">finance.recurrence.rule</field>
        <field name="arch" type="xml">
            <list string="Recurrence Rules">
                <field name="name"/>
                <field name="recurrence_type" widget="badge"/>
                <field name="day_of_month"/>
                <field name="offset_workdays"/>
                <field name="task_count"/>
                <field name="active"/>
            </list>
        </field>
    </record>

    <record id="view_finance_recurrence_form" model="ir.ui.view">
        <field name="name">finance.recurrence.rule.form</field>
        <field name="model">finance.recurrence.rule</field>
        <field name="arch" type="xml">
            <form string="Recurrence Rule">
                <sheet>
                    <group>
                        <group string="Rule Definition">
                            <field name="name"/>
                            <field name="recurrence_type"/>
                            <field name="active"/>
                        </group>
                        <group string="Schedule">
                            <field name="day_of_month" invisible="recurrence_type == 'bir_linked'"/>
                            <field name="offset_workdays"/>
                            <field name="bir_form_id" invisible="recurrence_type != 'bir_linked'"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Linked Tasks" name="tasks">
                            <field name="task_ids">
                                <list string="Tasks">
                                    <field name="name"/>
                                    <field name="project_id"/>
                                    <field name="user_id"/>
                                    <field name="finance_state"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <record id="action_finance_recurrence_rules" model="ir.actions.act_window">
        <field name="name">Recurrence Rules</field>
        <field name="res_model">finance.recurrence.rule</field>
        <field name="view_mode">tree,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Define recurrence rules for automated task generation
            </p>
        </field>
    </record>
</odoo>
