# schema: ssot.secrets.v1
# Single source of truth for secret IDENTIFIERS used by InsightPulse AI.
#
# This file tracks:
#   - Secret names (not values)
#   - Purpose and scope
#   - Approved storage locations
#   - Which files/services consume each secret
#
# NEVER include secret values in this file.
# Values live in: macOS Keychain, GitHub Actions Secrets, Supabase Vault, Vercel env vars
#
# Workflow: docs/runbooks/SECRETS_SSOT.md

version: "1.0.0"
schema: ssot.secrets.v1
last_reviewed: "2026-02-27"

schema_rules:
  required_fields:
    - purpose
    - approved_stores
    - consumers
  consumer_format: "store:identifier"
  consumer_stores:
    - github_actions
    - vercel_env
    - supabase_vault
    - os_keychain
    - odoo_config_parameter

secrets:
  cf_dns_read_token:
    purpose: "Cloudflare DNS Zone:Read — CI drift gate"
    approved_stores:
      - github_actions
    github_secret_name: CF_DNS_READ_TOKEN
    consumers:
      - github_actions:.github/workflows/cloudflare-dns-drift.yml
      - github_actions:.github/workflows/domain-lint.yml
    rotation_policy: "Annually or on team member offboarding"
    notes: "Read-only token. Minimal blast radius."

  cf_dns_edit_token:
    purpose: "Cloudflare DNS Zone:Edit — Terraform apply via CI"
    approved_stores:
      - github_actions
    github_secret_name: CF_DNS_EDIT_TOKEN
    consumers:
      - github_actions:infra/cloudflare/envs/prod/
      - github_actions:.github/workflows/dns-ssot-apply.yml
    rotation_policy: "Annually or on team member offboarding"
    notes: "Edit-scoped token. Only used by Terraform apply workflow."

  zoho_client_id:
    purpose: "Zoho Mail API OAuth2 client ID"
    approved_stores:
      - os_keychain
      - supabase_vault
    vault_secret_name: zoho_client_id
    consumers:
      - supabase_vault:zoho_client_id
      - odoo_config_parameter:addons/ipai/ipai_zoho_mail_api/
    rotation_policy: "On Zoho app credential reset"
    notes: "Pair with zoho_client_secret and zoho_refresh_token."

  zoho_client_secret:
    purpose: "Zoho Mail API OAuth2 client secret"
    approved_stores:
      - os_keychain
      - supabase_vault
    vault_secret_name: zoho_client_secret
    consumers:
      - supabase_vault:zoho_client_secret
      - odoo_config_parameter:addons/ipai/ipai_zoho_mail_api/
    rotation_policy: "On Zoho app credential reset"
    notes: "Pair with zoho_client_id and zoho_refresh_token."

  zoho_refresh_token:
    purpose: "Zoho Mail API OAuth2 long-lived refresh token"
    approved_stores:
      - os_keychain
      - supabase_vault
    vault_secret_name: zoho_refresh_token
    consumers:
      - supabase_vault:zoho_refresh_token
      - odoo_config_parameter:addons/ipai/ipai_zoho_mail_api/
    rotation_policy: "Every 6 months or when access is revoked"
    notes: "Used to obtain short-lived access tokens. Rotate proactively."

  supabase_service_role_key:
    purpose: "Supabase service role key (full RLS bypass — use sparingly)"
    approved_stores:
      - os_keychain
      - github_actions
    github_secret_name: SUPABASE_SERVICE_ROLE_KEY
    consumers:
      - github_actions:SUPABASE_SERVICE_ROLE_KEY
      - os_keychain:local-dev
    rotation_policy: "Quarterly or on team member offboarding"
    notes: "Bypasses all RLS. Scope usage to CI/migration scripts only."

  supabase_anon_key:
    purpose: "Supabase anonymous key (public — safe to expose client-side)"
    approved_stores:
      - os_keychain
      - vercel_env
    vercel_env_name: NEXT_PUBLIC_SUPABASE_ANON_KEY
    consumers:
      - vercel_env:apps/ops-console
      - os_keychain:local-dev
    rotation_policy: "On Supabase project reset only"
    notes: "Public key — low sensitivity. Subject to RLS policies."

  gemini_api_key:
    purpose: "Google Gemini API key — Ops Console AI route (/api/ai/gemini)"
    approved_stores:
      - github_actions
      - vercel_env
    github_secret_name: GEMINI_API_KEY
    vercel_env_name: GEMINI_API_KEY
    consumers:
      - vercel_env:apps/ops-console
      - vercel_env:platform/ai/providers/gemini
      - github_actions:GEMINI_API_KEY
    rotation_policy: "Annually or on security incident"
    notes: "Required for Gemini bridge. Set in Vercel env vars for ops-console deployment."

  slack_bot_token:
    purpose: "Slack bot token for ipai_slack_connector notifications"
    approved_stores:
      - os_keychain
      - supabase_vault
    vault_secret_name: slack_bot_token
    consumers:
      - supabase_vault:slack_bot_token
      - odoo_config_parameter:addons/ipai/ipai_slack_connector/
    rotation_policy: "On Slack app reinstallation or security incident"
    notes: "xoxb- prefix token. Scopes: chat:write, channels:read."

  slack_signing_secret:
    purpose: "Slack signing secret for webhook verification"
    approved_stores:
      - os_keychain
      - supabase_vault
    vault_secret_name: slack_signing_secret
    consumers:
      - supabase_vault:slack_signing_secret
      - odoo_config_parameter:addons/ipai/ipai_slack_connector/
    rotation_policy: "On Slack app reinstallation or security incident"
    notes: "Used to verify that webhook payloads come from Slack."

  github_token:
    purpose: "GitHub PAT for API access (repo operations, workflow triggers)"
    approved_stores:
      - os_keychain
      - github_actions
    github_secret_name: GITHUB_TOKEN
    consumers:
      - github_actions:GITHUB_TOKEN
      - os_keychain:local-dev
    rotation_policy: "Annually or on team member offboarding"
    notes: "Use fine-grained PAT scoped to this repo only."

  do_access_token:
    purpose: "DigitalOcean API token — App Platform + Droplet management"
    approved_stores:
      - os_keychain
      - github_actions
    github_secret_name: DO_ACCESS_TOKEN
    consumers:
      - github_actions:DO_ACCESS_TOKEN
      - os_keychain:local-dev
    rotation_policy: "Annually or on team member offboarding"
    notes: "Scoped to fin-workspace project where possible."

  anthropic_api_key:
    purpose: "Anthropic Claude API key for llm_anthropic Odoo provider (Apexive odoo-llm)"
    approved_stores:
      - odoo_config_parameter
      - os_keychain
    consumers:
      - odoo_config_parameter:anthropic.api_key
      - os_keychain:local-dev
    rotation_policy: "Annually or on API key compromise"
    notes: >
      Used by the llm_anthropic provider module (vendored from Apexive, ported to 19.0).
      Configured in Odoo Settings → LLM → Providers → Anthropic.
      Key must support Claude 4.5 family models (claude-sonnet-4-6, claude-opus-4-6).
      Never commit to git; never inject via Dockerfile ENV in tracked compose files.
      See: spec/ipai-llm-supabase-bridge/

  llm_bridge_webhook_secret:
    purpose: "HMAC-SHA256 shared secret for ipai_llm_supabase_bridge webhook signing"
    approved_stores:
      - supabase_vault
      - odoo_config_parameter
    consumers:
      - supabase_vault:LLM_BRIDGE_WEBHOOK_SECRET
      - odoo_config_parameter:ipai_llm_supabase_bridge.webhook_secret
    rotation_policy: "Rotate on team member offboarding or suspected exposure"
    notes: >
      Must be identical on both sides: Supabase Edge Function reads from Vault;
      Odoo bridge reads from ir.config_parameter (set via Settings UI).
      Minimum 32 random bytes (base64 or hex). Generate with:
        python3 -c "import secrets; print(secrets.token_hex(32))"
      See: spec/ipai-llm-supabase-bridge/

  slack_client_secret:
    purpose: "Slack OAuth client secret for pulser app"
    approved_stores:
      - supabase_vault
      - os_keychain
    vault_secret_name: slack_client_secret
    consumers:
      - supabase_vault:slack_client_secret
      - supabase_edge:ops-slack-bridge
    rotation_policy: "On Slack app reinstallation or security incident"
    notes: "Pair with client_id in ssot/integrations/slack/pulser.yaml."

  slack_app_token:
    purpose: "Slack Socket Mode app-level token (xapp-*) for pulser"
    approved_stores:
      - supabase_vault
      - os_keychain
    vault_secret_name: slack_app_token
    consumers:
      - supabase_vault:slack_app_token
      - supabase_edge:ops-slack-socket
    rotation_policy: "On Slack app reinstallation or security incident"
    notes: "xapp- prefix. Required for Socket Mode transport."

  slack_refresh_token:
    purpose: "Slack OAuth refresh token (if token rotation enabled)"
    approved_stores:
      - supabase_vault
      - os_keychain
    vault_secret_name: slack_refresh_token
    consumers:
      - supabase_vault:slack_refresh_token
      - supabase_edge:ops-slack-bridge
    rotation_policy: "On token rotation event"
    notes: "Only needed if Slack token rotation is enabled for the app."

  plane_api_key:
    purpose: "Plane REST API personal access token"
    approved_stores:
      - supabase_vault
      - os_keychain
    vault_secret_name: plane_api_key
    consumers:
      - odoo_config_parameter:addons/ipai/ipai_plane_connector/
      - supabase_edge:plane-sync
    rotation_policy: "Annually or on security incident"
    notes: "Used as X-API-Key header for Plane REST API calls."

  plane_webhook_secret:
    purpose: "Plane webhook HMAC-SHA256 verification secret"
    approved_stores:
      - supabase_vault
      - os_keychain
    vault_secret_name: plane_webhook_secret
    consumers:
      - odoo_config_parameter:addons/ipai/ipai_plane_connector/
      - supabase_edge:plane-sync
    rotation_policy: "Annually or on security incident"
    notes: "Used to verify X-Plane-Signature on incoming webhooks."

  github_app_id:
    purpose: "GitHub App identifier for JWT iss claim"
    approved_stores:
      - supabase_vault
    vault_secret_name: github_app_id
    consumers:
      - supabase_edge:github-app-token
    rotation_policy: "On app recreation only"
    notes: "Not truly secret but stored in Vault for consistency."

  github_app_private_key_pem:
    purpose: "RS256 private key for GitHub App JWT signing"
    approved_stores:
      - supabase_vault
    vault_secret_name: github_app_private_key_pem
    consumers:
      - supabase_edge:github-app-token
    rotation_policy: "Annually or on security incident"
    notes: "High sensitivity. PEM-encoded RSA private key. Never log."

  github_webhook_secret:
    purpose: "GitHub App webhook HMAC-SHA256 verification secret"
    approved_stores:
      - supabase_vault
    vault_secret_name: github_webhook_secret
    consumers:
      - supabase_edge:github-app-webhook
    rotation_policy: "Annually or on security incident"
    notes: "Used to verify X-Hub-Signature-256 on incoming webhooks."
