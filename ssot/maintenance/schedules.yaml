# Periodic Maintenance Schedule — SSOT
# Defines automated chores for repo, infra, and security hygiene.
# Runner: ops.schedules table + ops-convergence-scan / CI / manual
# See: spec/odooops-console/plan.md § "Periodic Maintenance Schedule"

version: "1.0.0"
schema: ssot.maintenance.schedules.v1
last_reviewed: "2026-03-01"

chores:
  # ── Daily ──────────────────────────────────────────────────────────────────
  - id: ci_gates_daily
    name: CI Gates + Policy Check
    cadence: daily
    cron: "0 2 * * *"  # 02:00 UTC daily
    runner: ci
    description: Run lint, unit tests, and core policy gates (OCA allowlist, diagram drift, JSON-only APIs, secrets SSOT presence).
    outputs:
      - ops.gate_runs
      - ops.agent_artifacts
    alert_on_failure: true

  - id: dependency_vuln_scan
    name: Dependency Vulnerability Scan
    cadence: daily
    cron: "0 3 * * *"
    runner: ci
    description: Ingest Dependabot alerts + SBOM scan. Create work item if severity >= high.
    outputs:
      - ops.security_findings
    alert_on_failure: true

  - id: backup_freshness
    name: Backup Freshness Check
    cadence: daily
    cron: "0 4 * * *"
    runner: ops-convergence-scan
    description: Verify last backup exists for PROD and is within SLA window (24h).
    outputs:
      - ops.convergence_findings
    alert_on_failure: true
    success_criteria: "Latest backup age < 24 hours"

  - id: provider_ingest_do
    name: DigitalOcean Inventory Ingest
    cadence: hourly
    cron: "0 * * * *"
    runner: ops-do-ingest
    description: Ingest DO droplets, databases, firewalls into ops.do_* tables.
    outputs:
      - ops.do_droplets
      - ops.do_databases
      - ops.do_firewalls
      - ops.do_ingest_runs
    alert_on_failure: true

  - id: convergence_scan
    name: Deployment Convergence Scan
    cadence: every_15_min
    cron: "*/15 * * * *"
    runner: ops-convergence-scan
    description: Detect drift between git HEAD and deployed SHA per environment.
    outputs:
      - ops.convergence_findings
    alert_on_failure: true

  - id: log_error_rollup
    name: Log/Error Rollup
    cadence: daily
    cron: "0 5 * * *"
    runner: ops-summary
    description: Aggregate errors from Vercel/Supabase/Edge Functions into ops.platform_events.
    outputs:
      - ops.platform_events
    alert_on_failure: false

  # ── Weekly ─────────────────────────────────────────────────────────────────
  - id: dependency_upgrade_window
    name: Dependency Upgrade PR Window
    cadence: weekly
    cron: "0 6 * * 1"  # Monday 06:00 UTC
    runner: ci
    description: Run controlled lockfile update batch. Require green gates + PR review.
    outputs:
      - github_pr
    alert_on_failure: false

  - id: diagram_drift_export
    name: Diagram Drift Enforcement
    cadence: weekly
    cron: "0 7 * * 1"
    runner: ci
    description: Re-export .drawio → .png in CI; fail if drift detected.
    outputs:
      - ops.gate_runs
    alert_on_failure: true

  - id: rls_drift_audit
    name: RLS/Policy Drift Audit
    cadence: weekly
    cron: "0 8 * * 2"  # Tuesday 08:00 UTC
    runner: ops-convergence-scan
    description: Compare supabase/migrations + expected RLS policies to live DB.
    outputs:
      - ops.convergence_findings
    alert_on_failure: true

  - id: secrets_registry_audit
    name: Secrets Registry Audit
    cadence: weekly
    cron: "0 9 * * 2"
    runner: ops-convergence-scan
    description: Ensure every referenced env var in code has a ssot/secrets/registry.yaml entry.
    outputs:
      - ops.convergence_findings
    alert_on_failure: true

  # ── Monthly ────────────────────────────────────────────────────────────────
  - id: backup_restore_drill
    name: Backup Restore Drill (Staging)
    cadence: monthly
    cron: "0 10 1 * *"  # 1st of month 10:00 UTC
    runner: manual
    description: Restore latest PROD snapshot into STAGE and run smoke tests.
    outputs:
      - ops.maintenance_runs
    alert_on_failure: true

  - id: access_review
    name: Access Review (GitHub/Vercel/Supabase/DO)
    cadence: monthly
    cron: "0 11 1 * *"
    runner: ops-convergence-scan
    description: Inventory admins, deploy keys, tokens in use (metadata only). Diff from last month.
    outputs:
      - ops.maintenance_runs
    alert_on_failure: false

  - id: cost_quota_review
    name: Cost & Quota Review
    cadence: monthly
    cron: "0 12 1 * *"
    runner: ops-convergence-scan
    description: Ingest Vercel/Supabase/DO usage. Alert on anomalies.
    outputs:
      - ops.maintenance_runs
    alert_on_failure: false

  - id: incident_playbook_drill
    name: Incident Playbook Exercise
    cadence: monthly
    cron: "0 13 15 * *"  # 15th of month
    runner: manual
    description: Pick one failure mode, validate runbooks + automation paths.
    outputs:
      - ops.maintenance_runs
      - github_pr  # updated runbook PR
    alert_on_failure: false

  # ── Quarterly ──────────────────────────────────────────────────────────────
  - id: key_token_rotation
    name: Key/Token Rotation Window
    cadence: quarterly
    cron: "0 14 1 1,4,7,10 *"  # 1st of Jan/Apr/Jul/Oct
    runner: manual
    description: Rotate critical provider tokens (Vercel, Supabase service_role, DO API, Mailgun signing key).
    outputs:
      - ops.maintenance_runs
    alert_on_failure: true

  - id: major_version_planning
    name: Major Version Upgrade Planning
    cadence: quarterly
    cron: "0 15 1 1,4,7,10 *"
    runner: manual
    description: Check Odoo major version lifecycle + OCA module compatibility scan.
    outputs:
      - github_pr  # roadmap + spec bundles
    alert_on_failure: false

  - id: disaster_recovery_rehearsal
    name: Disaster Recovery Rehearsal
    cadence: quarterly
    cron: "0 16 1 1,4,7,10 *"
    runner: manual
    description: Rebuild the environment from SSOT on a clean project/stage instance.
    outputs:
      - ops.maintenance_runs
    alert_on_failure: true
