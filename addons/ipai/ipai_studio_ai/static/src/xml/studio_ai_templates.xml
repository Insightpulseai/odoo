<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">

    <!-- Systray Button -->
    <t t-name="ipai_studio_ai.Systray">
        <div class="o_studio_ai_systray">
            <button class="btn btn-link o_studio_ai_trigger"
                    t-on-click="togglePanel"
                    title="Studio AI (Ctrl+Shift+A)"
                    aria-label="Open Studio AI">
                <i class="fa fa-magic"/>
                <span class="d-none d-md-inline ms-1">Ask AI</span>
            </button>
            <t t-if="state.showPanel">
                <StudioAIChatPanel onClose.bind="closePanel"/>
            </t>
        </div>
    </t>

    <!-- Main Chat Panel -->
    <t t-name="ipai_studio_ai.ChatPanel">
        <div t-att-class="'o_studio_ai_panel ' + (state.isMinimized ? 'minimized' : '') + (state.isOpen ? ' open' : '')">
            <!-- Panel Header -->
            <div class="o_studio_ai_header">
                <div class="o_studio_ai_title">
                    <i class="fa fa-magic me-2"/>
                    <span>Studio AI</span>
                    <t t-if="state.currentModelName">
                        <span class="o_studio_ai_context badge bg-secondary ms-2">
                            <t t-esc="state.currentModelName"/>
                        </span>
                    </t>
                </div>
                <div class="o_studio_ai_actions">
                    <button class="btn btn-link btn-sm" t-on-click="clearMessages" title="Clear history">
                        <i class="fa fa-trash"/>
                    </button>
                    <button class="btn btn-link btn-sm" t-on-click="openWizard" title="Open full wizard">
                        <i class="fa fa-external-link"/>
                    </button>
                    <button class="btn btn-link btn-sm" t-on-click="minimizePanel" title="Minimize">
                        <i class="fa fa-minus"/>
                    </button>
                    <button class="btn btn-link btn-sm" t-on-click="closePanel" title="Close (ESC)">
                        <i class="fa fa-times"/>
                    </button>
                </div>
            </div>

            <!-- Panel Body -->
            <div class="o_studio_ai_body" t-if="!state.isMinimized">
                <!-- Messages Area -->
                <div class="o_studio_ai_messages">
                    <t t-if="state.messages.length === 0">
                        <div class="o_studio_ai_welcome">
                            <div class="o_studio_ai_welcome_icon">
                                <i class="fa fa-magic fa-3x"/>
                            </div>
                            <h5>Welcome to Studio AI</h5>
                            <p class="text-muted">
                                Describe what you want to customize in natural language.
                            </p>
                        </div>
                    </t>

                    <t t-foreach="state.messages" t-as="msg" t-key="msg_index">
                        <div t-att-class="getMessageClass(msg)">
                            <!-- User Message -->
                            <t t-if="msg.type === 'user'">
                                <div class="o_studio_ai_msg_content">
                                    <i class="fa fa-user me-2"/>
                                    <span t-esc="msg.content"/>
                                </div>
                                <div class="o_studio_ai_msg_time" t-esc="msg.timestamp"/>
                            </t>

                            <!-- Assistant Message -->
                            <t t-if="msg.type === 'assistant'">
                                <div class="o_studio_ai_msg_content">
                                    <i class="fa fa-robot me-2"/>
                                    <span t-esc="msg.content"/>
                                </div>
                                <t t-if="msg.confidence">
                                    <div class="o_studio_ai_confidence">
                                        <span class="badge bg-info">
                                            Confidence: <t t-esc="formatConfidence(msg.confidence)"/>
                                        </span>
                                        <t t-if="msg.commandType">
                                            <span class="badge bg-secondary ms-1" t-esc="msg.commandType"/>
                                        </t>
                                    </div>
                                </t>
                                <div class="o_studio_ai_msg_time" t-esc="msg.timestamp"/>
                            </t>

                            <!-- Action Message -->
                            <t t-if="msg.type === 'action'">
                                <div class="o_studio_ai_msg_content">
                                    <i class="fa fa-check-circle me-2 text-success"/>
                                    <span t-esc="msg.content"/>
                                </div>
                                <div class="o_studio_ai_action_buttons mt-2">
                                    <button class="btn btn-primary btn-sm me-2"
                                            t-on-click="() => this.executeCommand(msg.analysis)">
                                        <i class="fa fa-play me-1"/> Execute
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm"
                                            t-on-click="openWizard">
                                        <i class="fa fa-edit me-1"/> Review First
                                    </button>
                                </div>
                            </t>

                            <!-- Success Message -->
                            <t t-if="msg.type === 'success'">
                                <div class="o_studio_ai_msg_content text-success">
                                    <i class="fa fa-check-circle me-2"/>
                                    <span t-esc="msg.content"/>
                                </div>
                                <div class="o_studio_ai_msg_time" t-esc="msg.timestamp"/>
                            </t>

                            <!-- Error Message -->
                            <t t-if="msg.type === 'error'">
                                <div class="o_studio_ai_msg_content text-danger">
                                    <i class="fa fa-exclamation-circle me-2"/>
                                    <span t-esc="msg.content"/>
                                </div>
                                <div class="o_studio_ai_msg_time" t-esc="msg.timestamp"/>
                            </t>

                            <!-- Query Result Message -->
                            <t t-if="msg.type === 'query_result'">
                                <div class="o_studio_ai_msg_content">
                                    <i class="fa fa-search me-2 text-info"/>
                                    <span t-esc="msg.content"/>
                                </div>
                                <t t-if="msg.records and msg.records.length > 0">
                                    <div class="o_studio_ai_query_results mt-2">
                                        <t t-foreach="msg.records.slice(0, 5)" t-as="record" t-key="record.id">
                                            <div class="o_studio_ai_query_item">
                                                <i class="fa fa-circle-o me-1 text-muted"/>
                                                <t t-esc="record.display_name"/>
                                            </div>
                                        </t>
                                        <t t-if="msg.records.length > 5">
                                            <div class="o_studio_ai_query_more text-muted">
                                                ...and <t t-esc="msg.records.length - 5"/> more
                                            </div>
                                        </t>
                                    </div>
                                    <div class="o_studio_ai_action_buttons mt-2">
                                        <button class="btn btn-info btn-sm"
                                                t-on-click="() => this.openQueryResults(msg.action)">
                                            <i class="fa fa-external-link me-1"/> Open Full List
                                        </button>
                                    </div>
                                </t>
                                <div class="o_studio_ai_msg_time" t-esc="msg.timestamp"/>
                            </t>
                        </div>
                    </t>

                    <!-- Processing Indicator -->
                    <t t-if="state.isProcessing">
                        <div class="o_studio_ai_message o_studio_ai_message-processing">
                            <div class="o_studio_ai_typing">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </t>
                </div>

                <!-- Suggestions -->
                <t t-if="state.showSuggestions and state.suggestions.length > 0">
                    <div class="o_studio_ai_suggestions">
                        <div class="o_studio_ai_suggestions_label">
                            <i class="fa fa-lightbulb-o me-1"/> Try asking:
                        </div>
                        <t t-foreach="state.suggestions" t-as="suggestion" t-key="suggestion_index">
                            <button class="o_studio_ai_suggestion btn btn-outline-primary btn-sm"
                                    t-on-click="() => this.selectSuggestion(suggestion)">
                                <i t-att-class="'fa ' + suggestion.icon + ' me-1'"/>
                                <t t-esc="suggestion.text"/>
                            </button>
                        </t>
                    </div>
                </t>

                <!-- Input Area -->
                <div class="o_studio_ai_input_area">
                    <div class="o_studio_ai_input_wrapper">
                        <textarea
                            t-ref="commandInput"
                            class="o_studio_ai_input form-control"
                            t-att-value="state.command"
                            t-on-input="onInput"
                            t-on-focus="onFocus"
                            t-on-blur="onBlur"
                            t-on-keydown="onKeydown"
                            placeholder="Describe what you want to customize..."
                            rows="1"
                            t-att-disabled="state.isProcessing"/>
                        <button class="o_studio_ai_send btn btn-primary"
                                t-on-click="sendCommand"
                                t-att-disabled="!state.command.trim() || state.isProcessing"
                                title="Send (Enter)">
                            <t t-if="state.isProcessing">
                                <i class="fa fa-spinner fa-spin"/>
                            </t>
                            <t t-else="">
                                <i class="fa fa-paper-plane"/>
                            </t>
                        </button>
                    </div>
                    <div class="o_studio_ai_input_hint">
                        Press <kbd>Enter</kbd> to send, <kbd>Shift+Enter</kbd> for new line
                    </div>
                </div>
            </div>

            <!-- Minimized State -->
            <div class="o_studio_ai_minimized_bar" t-if="state.isMinimized" t-on-click="restorePanel">
                <i class="fa fa-magic me-2"/>
                <span>Studio AI</span>
                <t t-if="state.messages.length > 0">
                    <span class="badge bg-primary ms-2" t-esc="state.messages.length"/>
                </t>
            </div>
        </div>
    </t>

</templates>
