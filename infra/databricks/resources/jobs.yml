# Databricks Jobs Configuration

resources:
  jobs:
    # ============================================
    # Bronze Layer: Data Ingestion
    # ============================================

    notion_sync_bronze:
      name: "Notion Sync Bronze"
      description: "Sync Notion databases to bronze layer"
      tags:
        layer: bronze
        source: notion
        team: platform

      tasks:
        - task_key: sync_all
          description: "Sync all Notion databases"
          notebook_task:
            notebook_path: ../notebooks/bronze/ingest_notion.py
            source: WORKSPACE
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 1
            spark_env_vars:
              NOTION_TOKEN: "{{secrets/notion-ppm/notion_token}}"
              DATABRICKS_CATALOG: "${var.catalog}"
          timeout_seconds: 1800
          max_retries: 2

      schedule:
        quartz_cron_expression: "0 */15 * * * ?"
        timezone_id: "UTC"
        pause_status: UNPAUSED

      email_notifications:
        on_failure:
          - platform-alerts@insightpulseai.com

    azure_rg_ingest:
      name: "Azure Resource Graph Ingest"
      description: "Ingest Azure Advisor and Resource Graph data"
      tags:
        layer: bronze
        source: azure
        team: platform

      tasks:
        - task_key: ingest_advisor
          description: "Query Azure Advisor recommendations"
          notebook_task:
            notebook_path: ../notebooks/bronze/ingest_azure_rg.py
            source: WORKSPACE
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 1
            spark_env_vars:
              AZURE_SUBSCRIPTION_ID: "{{secrets/notion-ppm/azure_subscription_id}}"
              AZURE_CLIENT_ID: "{{secrets/notion-ppm/azure_client_id}}"
              AZURE_CLIENT_SECRET: "{{secrets/notion-ppm/azure_client_secret}}"
              AZURE_TENANT_ID: "{{secrets/notion-ppm/azure_tenant_id}}"
              DATABRICKS_CATALOG: "${var.catalog}"
          timeout_seconds: 1800
          max_retries: 2

      schedule:
        quartz_cron_expression: "0 0 */6 * * ?"
        timezone_id: "UTC"
        pause_status: UNPAUSED

    # ============================================
    # Silver Layer: Transformation
    # ============================================

    notion_transform_silver:
      name: "Notion Transform Silver"
      description: "Transform Notion bronze data to silver tables"
      tags:
        layer: silver
        source: notion
        team: platform

      tasks:
        - task_key: transform_programs
          description: "Transform programs"
          notebook_task:
            notebook_path: ../notebooks/silver/transform_notion.py
            base_parameters:
              table_name: programs
            source: WORKSPACE
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 1
          timeout_seconds: 900

        - task_key: transform_projects
          description: "Transform projects"
          notebook_task:
            notebook_path: ../notebooks/silver/transform_notion.py
            base_parameters:
              table_name: projects
            source: WORKSPACE
          depends_on:
            - task_key: transform_programs
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 1
          timeout_seconds: 900

        - task_key: transform_budget_lines
          description: "Transform budget lines"
          notebook_task:
            notebook_path: ../notebooks/silver/transform_notion.py
            base_parameters:
              table_name: budget_lines
            source: WORKSPACE
          depends_on:
            - task_key: transform_projects
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 1
          timeout_seconds: 900

        - task_key: transform_risks
          description: "Transform risks"
          notebook_task:
            notebook_path: ../notebooks/silver/transform_notion.py
            base_parameters:
              table_name: risks
            source: WORKSPACE
          depends_on:
            - task_key: transform_projects
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 1
          timeout_seconds: 900

      schedule:
        quartz_cron_expression: "0 0 * * * ?"
        timezone_id: "UTC"
        pause_status: UNPAUSED

    # ============================================
    # Gold Layer: Business Marts
    # ============================================

    ppm_marts_gold:
      name: "PPM Marts Gold"
      description: "Build PPM business marts in gold layer"
      tags:
        layer: gold
        domain: ppm
        team: platform

      tasks:
        - task_key: budget_vs_actual
          description: "Compute budget vs actual metrics"
          notebook_task:
            notebook_path: ../notebooks/gold/budget_vs_actual.py
            source: WORKSPACE
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 2
          timeout_seconds: 1800

        - task_key: forecast
          description: "Compute forecast metrics"
          notebook_task:
            notebook_path: ../notebooks/gold/forecast.py
            source: WORKSPACE
          depends_on:
            - task_key: budget_vs_actual
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 2
          timeout_seconds: 1800

        - task_key: risk_summary
          description: "Compute risk rollups"
          notebook_task:
            notebook_path: ../notebooks/gold/risk_summary.py
            source: WORKSPACE
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 1
          timeout_seconds: 900

        - task_key: projects_summary
          description: "Build projects summary table"
          notebook_task:
            notebook_path: ../notebooks/gold/projects_summary.py
            source: WORKSPACE
          depends_on:
            - task_key: budget_vs_actual
            - task_key: risk_summary
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 1
          timeout_seconds: 900

      schedule:
        quartz_cron_expression: "0 30 * * * ?"
        timezone_id: "UTC"
        pause_status: UNPAUSED

    # ============================================
    # Data Quality & Monitoring
    # ============================================

    dq_checks:
      name: "Data Quality Checks"
      description: "Run data quality checks across all layers"
      tags:
        layer: gold
        domain: quality
        team: platform

      tasks:
        - task_key: run_checks
          description: "Execute DQ checks"
          notebook_task:
            notebook_path: ../notebooks/gold/dq_checks.py
            source: WORKSPACE
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 1
          timeout_seconds: 1800

      schedule:
        quartz_cron_expression: "0 0 * * * ?"
        timezone_id: "UTC"
        pause_status: UNPAUSED

    control_room_refresh:
      name: "Control Room Status Refresh"
      description: "Update control room status table with job metadata"
      tags:
        layer: gold
        domain: monitoring
        team: platform

      tasks:
        - task_key: refresh_status
          description: "Collect job run metadata"
          notebook_task:
            notebook_path: ../notebooks/gold/control_room_status.py
            source: WORKSPACE
          new_cluster:
            spark_version: "14.3.x-scala2.12"
            node_type_id: "Standard_DS3_v2"
            num_workers: 1
          timeout_seconds: 600

      schedule:
        quartz_cron_expression: "0 */15 * * * ?"
        timezone_id: "UTC"
        pause_status: UNPAUSED
