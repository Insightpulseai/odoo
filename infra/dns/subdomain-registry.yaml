# =============================================================================
# DNS Subdomain Registry — Single Source of Truth
# =============================================================================
# This file is the CANONICAL source for all subdomains under insightpulseai.com.
# All DNS configuration (Terraform, runtime JSON, monitoring) is generated from this file.
#
# Generation: ./scripts/generate-dns-artifacts.sh
# Validation: .github/workflows/dns-sync-check.yml (CI enforces sync)
#
# DO NOT manually edit generated files:
#   - infra/cloudflare/envs/prod/subdomains.auto.tfvars
#   - docs/architecture/runtime_identifiers.json
#   - infra/dns/dns-validation-spec.json
# =============================================================================
#
# lifecycle field (schema: ssot.dns.v1)
# ─────────────────────────────────────
# active  → Terraform provisions/maintains the record.
#           REQUIRED: provider_claim.status must be "claimed" with claimed_at + claim_ref.
#           CI gate (check_dns_provider_claims.py) blocks merge if not satisfied.
#
# planned → Record is defined in SSOT but Terraform SKIPS it.
#           Safe to commit; no DNS change occurs.
#           Optional: set expires_at to auto-age stale planned records.
#           CI gate fails if expires_at is in the past (forces resolution).
#
# provider_claim field (schema: ssot.dns.provider_claim.v1)
# ──────────────────────────────────────────────────────────
# Required on ALL subdomains (active and planned alike).
#
#   provider:    WHO owns/manages the target endpoint.
#                Allowed: cloudflare | vercel | digitalocean | other
#
#   status:      Claim state.
#                Allowed: unclaimed | claimed
#
#   claimed_at:  YYYY-MM-DD — REQUIRED when status=claimed.
#                Date the provider confirmed domain ownership.
#
#   claim_ref:   String — REQUIRED when status=claimed.
#                Traceability anchor. Examples:
#                  "ssot:cloudflare"               → A record direct to origin, Cloudflare is the CDN
#                  "ssot:digitalocean-app-platform" → DO App Platform CNAME
#                  "vercel:prj_<id>"               → Vercel project ID (from dashboard)
#                  "ticket:ops-2026-042"            → Internal incident/ops ticket
#
#   expires_at:  YYYY-MM-DD — OPTIONAL, only meaningful on planned records.
#                After this date, CI fails until the claim is resolved or the
#                record is removed from SSOT. Prevents permanent "planned" limbo.
#
# Transition path for planned → active (e.g. Vercel custom domains)
# ──────────────────────────────────────────────────────────────────
# 1. DNS record committed with lifecycle=planned + provider_claim.status=unclaimed.
#    ↳ Terraform skips it; gate passes; DNS unchanged.
# 2. Operator claims the domain in the provider dashboard.
# 3. Operator commits:
#    - provider_claim.status:   unclaimed → claimed
#    - provider_claim.claimed_at: <today>
#    - provider_claim.claim_ref:  <provider reference ID>
#    - lifecycle:               planned → active
# 4. Gate passes → PR merges → Terraform provisions the record.
# =============================================================================

version: "1.0"
domain: insightpulseai.com
environment: production
origin_ip: 178.128.112.214

# =============================================================================
# Subdomain Definitions
# =============================================================================
# Each subdomain entry must specify:
#   - name: subdomain (e.g., "erp" for erp.insightpulseai.com)
#   - type: DNS record type (A, CNAME, TXT)
#   - service: human-readable service identifier
#   - For A records: origin_port, health_check
#   - For CNAME records: target (full FQDN)
# =============================================================================

subdomains:
  # ---------------------------------------------------------------------------
  # Core Business Systems (A Records → 178.128.112.214)
  # ---------------------------------------------------------------------------
  - name: erp
    type: A
    service: odoo_ce_19
    port: 8069
    health_check: /web/login
    owner_system: "Odoo CE 19.0"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"

  - name: n8n
    type: A
    service: n8n_workflow_automation
    port: 5678
    health_check: /healthz
    owner_system: "n8n automation"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"

  - name: plane
    type: A
    service: plane_project_management
    port: 3002
    health_check: /
    owner_system: "Plane CE (self-hosted)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-28"
      claim_ref: "ssot:cloudflare"

  - name: shelf
    type: A
    service: shelf_asset_management
    port: 3003
    health_check: /healthcheck
    owner_system: "Shelf.nu (self-hosted, ipai fork)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-28"
      claim_ref: "ssot:cloudflare"

  - name: ocr
    type: A
    service: paddleocr_microservice
    port: 8001
    health_check: /health
    owner_system: "PaddleOCR microservice"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    vhost_file: "infra/nginx/ocr.insightpulseai.com.conf"
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"

  - name: auth
    type: A
    service: authentication_service
    port: 8080
    health_check: /.well-known/openid-configuration
    owner_system: "Authentication service"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    # lifecycle=planned: auth-prod container runs on :8080 but has no nginx vhost
    # and OIDC discovery endpoint returns 404. Must not be "active" until both
    # conditions are resolved.
    lifecycle: planned
    status: planned
    backing_status: broken
    activation_criteria:
      - "Add nginx vhost routing auth.insightpulseai.com → 127.0.0.1:8080"
      - "Implement /.well-known/openid-configuration endpoint in auth-prod service"
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"
      expires_at: "2026-06-01"

  - name: superset
    type: A
    service: apache_superset_bi
    port: 8088
    health_check: /health
    owner_system: "Apache Superset BI"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    database: "DO managed PostgreSQL: odoo-db-sgp1/superset"
    lifecycle: active
    status: active
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"

  # ---------------------------------------------------------------------------
  # App Platform Services (CNAME Records → DO App Platform)
  # ---------------------------------------------------------------------------
  - name: mcp
    type: CNAME
    service: mcp_gateway
    target: pulse-hub-web-an645.ondigitalocean.app
    health_check: /healthz
    owner_system: "MCP coordination (11 servers)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    drift_note: "Cloudflare currently has A record (178.128.112.214) — WRONG. Must be CNAME. Will be fixed on next Terraform apply."
    provider_claim:
      provider: digitalocean
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:digitalocean-app-platform"

  # ---------------------------------------------------------------------------
  # Additional Subdomains (for www, api, etc.)
  # ---------------------------------------------------------------------------
  - name: www
    type: A
    service: website_redirect
    port: 80
    health_check: /
    owner_system: "Redirect to apex"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: active
    status: active
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"

  - name: api
    type: A
    service: api_gateway
    port: 8000
    health_check: /api/health
    owner_system: "API Gateway"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: planned
    status: planned
    provider_claim:
      provider: cloudflare
      status: unclaimed
      expires_at: "2026-06-01"

  # ---------------------------------------------------------------------------
  # Vercel Deployments (CNAME → cname.vercel-dns.com)
  # ---------------------------------------------------------------------------
  - name: ops
    type: CNAME
    service: ops_console_vercel
    target: cname.vercel-dns.com
    health_check: /api/health
    owner_system: "OdooOps Console (Next.js on Vercel)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    # lifecycle=planned: Terraform SKIPS this record until the Vercel domain
    # is claimed and provider_claim.status is updated to "claimed".
    # expires_at enforces a deadline: CI will fail after this date if still unclaimed.
    lifecycle: planned
    status: active
    provider_claim:
      provider: vercel
      status: unclaimed
      expires_at: "2026-03-15"

  - name: console
    description: "Ops Console — Next.js app on Vercel (Supabase-backed)"
    type: CNAME
    target: cname.vercel-dns.com
    proxied: false
    lifecycle: planned
    provider_claim:
      provider: vercel
      status: unclaimed
      expires_at: "2026-06-01"

  # ---------------------------------------------------------------------------
  # Staging Environment (A Records → 178.128.112.214)
  # ---------------------------------------------------------------------------
  # ALL staging entries are lifecycle=planned because no staging containers exist.
  # DNS records are live in Cloudflare (claimed) but no backing service is running.
  # Do not flip to lifecycle=active until docker-compose staging stack is provisioned.
  # ---------------------------------------------------------------------------
  - name: stage-erp
    type: A
    service: odoo_ce_19_staging
    port: 8069
    health_check: /web/login
    owner_system: "Odoo CE 19.0 (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: planned
    status: planned
    backing_status: not_provisioned
    environment: staging
    activation_criteria:
      - "Provision staging Odoo compose stack"
      - "Add nginx vhost for stage-erp → :8069"
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"
      expires_at: "2026-09-01"

  - name: stage-api
    type: A
    service: api_gateway_staging
    port: 8100
    health_check: /api/health
    owner_system: "API Gateway (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: planned
    status: planned
    backing_status: not_provisioned
    environment: staging
    notes: "Port changed from 8000 (conflict: paddleocr-service binds 127.0.0.1:8000 on prod host)"
    activation_criteria:
      - "Provision API gateway staging container on port 8100"
      - "Add nginx vhost for stage-api → :8100"
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"
      expires_at: "2026-09-01"

  - name: stage-auth
    type: A
    service: authentication_service_staging
    port: 8080
    health_check: /.well-known/openid-configuration
    owner_system: "Authentication service (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: planned
    status: planned
    backing_status: not_provisioned
    environment: staging
    activation_criteria:
      - "Provision staging auth container"
      - "Implement OIDC discovery endpoint"
      - "Add nginx vhost for stage-auth → :8080"
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"
      expires_at: "2026-09-01"

  - name: stage-mcp
    type: A
    service: mcp_gateway_staging
    port: 8766
    health_check: /healthz
    owner_system: "MCP coordination (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: planned
    status: planned
    backing_status: not_provisioned
    environment: staging
    activation_criteria:
      - "Provision staging MCP coordinator container on port 8766"
      - "Add nginx vhost for stage-mcp → :8766"
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"
      expires_at: "2026-09-01"

  - name: stage-n8n
    type: A
    service: n8n_workflow_automation_staging
    port: 5679
    health_check: /healthz
    owner_system: "n8n automation (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: planned
    status: planned
    backing_status: not_provisioned
    environment: staging
    notes: "Port changed from 5678 (conflict: prod n8n binds 0.0.0.0:5678)"
    activation_criteria:
      - "Provision staging n8n container on port 5679"
      - "Add nginx vhost for stage-n8n → :5679"
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"
      expires_at: "2026-09-01"

  - name: stage-superset
    type: A
    service: apache_superset_bi_staging
    port: 8089
    health_check: /health
    owner_system: "Apache Superset BI (staging)"
    cloudflare_proxied: true
    tls_mode: "Full (strict)"
    lifecycle: planned
    status: planned
    backing_status: not_provisioned
    environment: staging
    notes: "Port changed from 8088 (conflict: prod Superset binds 127.0.0.1:8088)"
    activation_criteria:
      - "Provision staging Superset container on port 8089"
      - "Add nginx vhost for stage-superset → :8089"
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"
      expires_at: "2026-09-01"

  - name: stage-ocr
    type: A
    service: paddleocr_microservice_staging
    port: 8002
    health_check: /health
    owner_system: "PaddleOCR microservice (staging)"
    cloudflare_proxied: false
    tls_mode: "Full (strict)"
    lifecycle: planned
    status: planned
    backing_status: not_provisioned
    environment: staging
    notes: "Port changed from 8080 (conflict: auth-prod binds 0.0.0.0:8080)"
    activation_criteria:
      - "Provision staging OCR container on port 8002"
      - "Add nginx vhost for stage-ocr → :8002"
    provider_claim:
      provider: cloudflare
      status: claimed
      claimed_at: "2026-02-27"
      claim_ref: "ssot:cloudflare"
      expires_at: "2026-09-01"

# =============================================================================
# Deprecated Services (Archived for Reference)
# =============================================================================
deprecated:
  - name: affine
    deprecated_date: "2026-02-09"
    replacement: null
    reason: "Service no longer needed"
    dns_removed: true
    container_removed: true

  # Mailgun email routing — replaced by Zoho Mail SMTP (2026-02)
  # Remove from Cloudflare: email.mg CNAME, mg SPF TXT, mx._domainkey.mg DKIM TXT, _dmarc.mg DMARC TXT
  - name: mg
    deprecated_date: "2026-02-01"
    replacement: "Zoho Mail (mx.zoho.com / mx2 / mx3)"
    reason: "Mailgun deprecated; outbound mail now routes through Zoho Mail SMTP bridge (ipai_zoho_mail_api)"
    dns_removed: false
    records_to_remove:
      - type: CNAME
        name: email.mg
        content: mailgun.org
      - type: TXT
        name: mg
        content: "v=spf1 include:mailgun.org ~all"
      - type: TXT
        name: mx._domainkey.mg
        content: "k=rsa; p=MIGfMA0..."
      - type: TXT
        name: _dmarc.mg
        content: "v=DMARC1; p=none; ..."
    notes: "4 records still present in Cloudflare as of 2026-02-27 — remove via Terraform apply"
