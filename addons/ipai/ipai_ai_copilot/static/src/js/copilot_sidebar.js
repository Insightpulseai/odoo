/** @odoo-module **/
/**
 * IPAI Copilot Sidebar — persistent right panel + systray toggle.
 *
 * CopilotSidebar: registered in main_components, renders on every view.
 * CopilotToggle: registered in systray (sequence: 5), opens/closes sidebar.
 *
 * The sidebar has two tabs:
 *   - Chat: conversational AI with tool confirmation support
 *   - Insights: proactive business alerts generated by daily cron
 */
import { Component, useState, useRef, onMounted, useEffect } from "@odoo/owl";
import { useService } from "@web/core/utils/hooks";
import { registry } from "@web/core/registry";

// ── Systray Toggle ────────────────────────────────────────────────────────────

class CopilotToggle extends Component {
    static template = "ipai_ai_copilot.CopilotToggle";
    static props = {};

    setup() {
        this.copilot = useService("ipai_copilot");
    }

    toggle() {
        this.copilot.toggle();
    }
}

// ── Main Sidebar Component ────────────────────────────────────────────────────

export class CopilotSidebar extends Component {
    static template = "ipai_ai_copilot.CopilotSidebar";
    static props = {};

    setup() {
        this.copilot = useService("ipai_copilot");
        this.state = this.copilot.state;
        this.inputRef = useRef("input");
        this.messagesRef = useRef("messages");
        this.localState = useState({
            tab: "chat",
            inputValue: "",
        });

        onMounted(() => {
            // Load insights on first open
            if (this.state.open) {
                this.copilot.loadInsights();
            }
        });

        // Auto-scroll messages to bottom when new messages arrive
        useEffect(
            () => {
                const el = this.messagesRef.el;
                if (el) {
                    el.scrollTop = el.scrollHeight;
                }
            },
            () => [this.state.messages.length, this.state.loading]
        );
    }

    // ── User interactions ──────────────────────────────────────────────────

    onKeydown(ev) {
        if (ev.key === "Enter" && !ev.shiftKey) {
            ev.preventDefault();
            this.send();
        }
    }

    async send() {
        const text = this.localState.inputValue.trim();
        if (!text || this.state.loading) return;
        this.localState.inputValue = "";
        await this.copilot.sendMessage(text);
        // Focus input after send
        setTimeout(() => this.inputRef.el?.focus(), 50);
    }

    async confirmTools(msg) {
        msg.dismissed = true; // Disable confirm/cancel buttons immediately
        await this.copilot.confirmTools(msg.tool_calls);
    }

    dismissTools(msg) {
        msg.dismissed = true;
        // Add cancelled note to chat
        this.state.messages.push({
            role: "assistant",
            type: "message",
            content: "Action cancelled.",
        });
    }

    switchTab(tab) {
        this.localState.tab = tab;
        if (tab === "insights") {
            this.copilot.loadInsights();
        }
    }

    clearChat() {
        this.copilot.clearMessages();
    }

    async askInsight(insight) {
        this.localState.tab = "chat";
        await this.copilot.sendMessage(`Show me details about: ${insight.title}`);
    }

    // ── Suggested starter prompts ─────────────────────────────────────────

    async sendStarter(text) {
        await this.copilot.sendMessage(text);
    }
}

// ── Registry Registrations ────────────────────────────────────────────────────

registry.category("systray").add("ipai_copilot_toggle", {
    Component: CopilotToggle,
    sequence: 5,
});

registry.category("main_components").add("ipai_copilot_sidebar", {
    Component: CopilotSidebar,
    props: {},
});
