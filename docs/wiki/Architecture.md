# Architecture

## System Architecture

```
┌─────────────────────────────────────────────────────────────────────┐
│                         InsightPulse AI Stack                        │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   Mattermost ◄──► n8n ◄──► Odoo CE 18 ◄──► PostgreSQL 15            │
│       │           │            │                                     │
│       │           │            ├── Core (8069)                       │
│       │           │            ├── Marketing (8070)                  │
│       │           │            └── Accounting (8071)                 │
│       │           │                                                  │
│       │           └──────────► Supabase (KB + integrations)          │
│       │                                                              │
│       └─────────────────────► AI Agents (RAG, LLM)                  │
│                                                                      │
├─────────────────────────────────────────────────────────────────────┤
│  Superset (BI)  │  Keycloak (SSO)  │  DigitalOcean (Hosting)        │
└─────────────────────────────────────────────────────────────────────┘
```

## Module Architecture

```
┌────────────────────────────────────────────────────────┐
│                    Odoo CE 18                          │
├────────────────────────────────────────────────────────┤
│                                                        │
│  ┌─────────────────────────────────────────────────┐  │
│  │               IPAI Platform Layer               │  │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────────────┐   │  │
│  │  │AI Agents│ │Approvals│ │Finance Close    │   │  │
│  │  └────┬────┘ └────┬────┘ └────────┬────────┘   │  │
│  └───────┼───────────┼───────────────┼────────────┘  │
│          │           │               │                │
│  ┌───────┼───────────┼───────────────┼────────────┐  │
│  │       ▼           ▼               ▼            │  │
│  │               Core Odoo                        │  │
│  │  ┌─────┐ ┌────┐ ┌───────┐ ┌────┐ ┌──────┐    │  │
│  │  │base │ │mail│ │account│ │sale│ │hr    │    │  │
│  │  └─────┘ └────┘ └───────┘ └────┘ └──────┘    │  │
│  └────────────────────────────────────────────────┘  │
│                                                        │
│  ┌────────────────────────────────────────────────┐  │
│  │               OCA Modules                      │  │
│  │  web_responsive, partner_*, account_*, ...    │  │
│  └────────────────────────────────────────────────┘  │
│                                                        │
└────────────────────────────────────────────────────────┘
```

## AI Agents Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    ipai_ai_agents                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────┐    ┌─────────────────────────────┐   │
│  │  Controller  │───▶│      RAG Pipeline           │   │
│  │  /ask        │    │  ┌─────────┐  ┌──────────┐  │   │
│  │  /bootstrap  │    │  │Retriever│──│Supabase  │  │   │
│  │  /feedback   │    │  │         │  │KB        │  │   │
│  └──────────────┘    │  └────┬────┘  └──────────┘  │   │
│                      │       │                      │   │
│                      │  ┌────▼────┐  ┌──────────┐  │   │
│                      │  │Reranker │──│LLM       │  │   │
│                      │  │         │  │Provider  │  │   │
│                      │  └─────────┘  └──────────┘  │   │
│                      └─────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                   Models                         │   │
│  │  ┌──────┐ ┌────────┐ ┌─────────┐ ┌──────────┐  │   │
│  │  │Agent │ │Thread  │ │Message  │ │Source    │  │   │
│  │  └──────┘ └────────┘ └─────────┘ └──────────┘  │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Approval Workflow Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    ipai_approvals                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │               Approval Type                      │   │
│  │  - User approvers                               │   │
│  │  - Group approvers                              │   │
│  │  - Manager chain                                │   │
│  │  - Auto-approve thresholds                      │   │
│  └─────────────────────────────────────────────────┘   │
│                      │                                  │
│                      ▼                                  │
│  ┌─────────────────────────────────────────────────┐   │
│  │            Approval Request                      │   │
│  │                                                  │   │
│  │   Draft ──▶ Pending ──▶ Approved                │   │
│  │                │                                 │   │
│  │                └──▶ Rejected                     │   │
│  │                                                  │   │
│  └─────────────────────────────────────────────────┘   │
│                      │                                  │
│                      ▼                                  │
│  ┌─────────────────────────────────────────────────┐   │
│  │           Approval Approver                      │   │
│  │  - Sequence order                               │   │
│  │  - Status tracking                              │   │
│  │  - Delegation support                           │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## Data Flow

1. **User Request** → Odoo controller
2. **RAG Retrieval** → Supabase KB (vector or text search)
3. **Evidence Ranking** → Reranker scores relevance
4. **LLM Generation** → Grounded answer with citations
5. **Response** → JSON with answer, citations, confidence

## Security Model

- **Company isolation**: Record rules enforce multi-company
- **User groups**: User/Manager roles per module
- **API auth**: Odoo session or API key
- **Supabase RLS**: Row-level security for KB data
