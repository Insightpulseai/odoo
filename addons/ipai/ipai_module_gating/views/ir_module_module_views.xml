<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============================================================ -->
    <!-- Module List View with Risk Badges                           -->
    <!-- ============================================================ -->

    <record id="view_module_list_gating" model="ir.ui.view">
        <field name="name">ir.module.module.list.gating</field>
        <field name="model">ir.module.module</field>
        <field name="inherit_id" ref="base.module_tree"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='state']" position="after">
                <field name="x_risk_stage" widget="badge"
                       decoration-success="x_risk_stage == 'stable'"
                       decoration-warning="x_risk_stage == 'beta'"
                       decoration-danger="x_risk_stage in ('experimental', 'deprecated')"
                       optional="show"/>
                <field name="x_risk_score" optional="hide"/>
                <field name="x_block_install" widget="boolean" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- Module Form View with Risk Details                          -->
    <!-- ============================================================ -->

    <record id="view_module_form_gating" model="ir.ui.view">
        <field name="name">ir.module.module.form.gating</field>
        <field name="model">ir.module.module</field>
        <field name="inherit_id" ref="base.module_form"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">
            <xpath expr="//div[@class='oe_button_box']" position="inside">
                <button name="action_recompute_module_risk" type="object"
                        class="oe_stat_button" icon="fa-refresh"
                        help="Recompute production readiness risk">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="x_risk_score"/> / 100
                        </span>
                        <span class="o_stat_text">Risk Score</span>
                    </div>
                </button>
            </xpath>

            <xpath expr="//group[@name='technical']" position="after">
                <group string="Production Readiness" name="gating">
                    <group>
                        <field name="x_risk_stage" widget="badge"
                               decoration-success="x_risk_stage == 'stable'"
                               decoration-warning="x_risk_stage == 'beta'"
                               decoration-danger="x_risk_stage in ('experimental', 'deprecated')"/>
                        <field name="x_risk_score"/>
                        <field name="x_block_install"/>
                        <field name="x_block_override" readonly="0"/>
                    </group>
                    <group>
                        <field name="x_deps_missing"/>
                        <field name="x_v18_compat_required"/>
                        <field name="x_last_risk_check"/>
                    </group>
                    <group colspan="2">
                        <field name="x_risk_reasons" readonly="1" widget="text"/>
                    </group>
                </group>
            </xpath>
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- Module Search with Risk Filters                             -->
    <!-- ============================================================ -->

    <record id="view_module_search_gating" model="ir.ui.view">
        <field name="name">ir.module.module.search.gating</field>
        <field name="model">ir.module.module</field>
        <field name="inherit_id" ref="base.view_module_filter"/>
        <field name="priority">20</field>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='app']" position="after">
                <separator/>
                <filter string="Stable" name="filter_stable"
                        domain="[('x_risk_stage', '=', 'stable')]"/>
                <filter string="Beta" name="filter_beta"
                        domain="[('x_risk_stage', '=', 'beta')]"/>
                <filter string="Experimental" name="filter_experimental"
                        domain="[('x_risk_stage', '=', 'experimental')]"/>
                <filter string="Deprecated" name="filter_deprecated"
                        domain="[('x_risk_stage', '=', 'deprecated')]"/>
                <separator/>
                <filter string="Blocked" name="filter_blocked"
                        domain="[('x_block_install', '=', True)]"/>
                <filter string="V18 Compat Needed" name="filter_v18_compat"
                        domain="[('x_v18_compat_required', '=', True)]"/>
                <filter string="High Risk (≥40)" name="filter_high_risk"
                        domain="[('x_risk_score', '>=', 40)]"/>
            </xpath>
            <xpath expr="//group" position="inside">
                <filter string="Risk Stage" name="groupby_stage"
                        context="{'group_by': 'x_risk_stage'}"/>
                <filter string="Blocked" name="groupby_blocked"
                        context="{'group_by': 'x_block_install'}"/>
            </xpath>
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- High-Risk Modules Action                                    -->
    <!-- ============================================================ -->

    <record id="action_module_high_risk" model="ir.actions.act_window">
        <field name="name">High-Risk Modules</field>
        <field name="res_model">ir.module.module</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('x_risk_score', '>=', 40)]</field>
        <field name="context">{'search_default_filter_high_risk': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No high-risk modules found
            </p>
            <p>
                Modules with risk score ≥ 40 will appear here.
                Click "Recompute All Risk" to update assessments.
            </p>
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- Blocked Modules Action                                      -->
    <!-- ============================================================ -->

    <record id="action_module_blocked" model="ir.actions.act_window">
        <field name="name">Blocked Modules</field>
        <field name="res_model">ir.module.module</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('x_block_install', '=', True)]</field>
        <field name="context">{'search_default_filter_blocked': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No blocked modules
            </p>
            <p>
                Modules blocked from install/upgrade due to risk assessment will appear here.
            </p>
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- Health Report Actions                                       -->
    <!-- ============================================================ -->

    <record id="action_module_health_report_csv" model="ir.actions.server">
        <field name="name">Export Health Report (CSV)</field>
        <field name="model_id" ref="base.model_ir_module_module"/>
        <field name="binding_model_id" ref="base.model_ir_module_module"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    action = records.action_export_health_report()
        </field>
    </record>

    <record id="action_module_health_report_md" model="ir.actions.server">
        <field name="name">Export Health Report (Markdown)</field>
        <field name="model_id" ref="base.model_ir_module_module"/>
        <field name="binding_model_id" ref="base.model_ir_module_module"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    action = records.action_generate_markdown_report()
        </field>
    </record>

    <record id="action_recompute_all_risk" model="ir.actions.server">
        <field name="name">Recompute All Risk</field>
        <field name="model_id" ref="base.model_ir_module_module"/>
        <field name="binding_model_id" ref="base.model_ir_module_module"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
records = env['ir.module.module'].search([])
records.action_recompute_module_risk()
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- Menu Items                                                  -->
    <!-- ============================================================ -->

    <menuitem id="menu_module_gating"
              name="Module Health"
              parent="base.menu_apps"
              sequence="100"/>

    <menuitem id="menu_module_high_risk"
              name="High-Risk Modules"
              parent="menu_module_gating"
              action="action_module_high_risk"
              sequence="10"/>

    <menuitem id="menu_module_blocked"
              name="Blocked Modules"
              parent="menu_module_gating"
              action="action_module_blocked"
              sequence="20"/>

</odoo>
