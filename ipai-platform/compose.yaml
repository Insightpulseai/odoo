# =============================================================================
# ipai-platform Docker Compose â€” SSOT Delegator
# =============================================================================
# Delegates to canonical ../docker-compose.yml for core services (db, redis, odoo).
# Adds only platform-specific services: Nginx reverse proxy, optional Supabase.
#
# Usage:
#   docker compose up -d                     # Core stack (from SSOT) + Nginx
#   docker compose --profile supabase up -d  # With local Supabase
#
# Endpoints:
#   - Nginx:    http://localhost:80        (reverse proxy)
#   - Odoo:     http://localhost:8069      (from SSOT)
#   - Supabase: http://localhost:3000      (optional, PostgREST)
# =============================================================================

include:
  - path: ../docker-compose.yml

name: ipai_platform

services:
  # ---------------------------------------------------------------------------
  # Nginx Reverse Proxy
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:1.25-alpine
    container_name: ipai-nginx
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      odoo:
        condition: service_healthy
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Supabase Local Stack (Optional Profile)
  # ---------------------------------------------------------------------------
  supabase_db:
    image: supabase/postgres:15.1.0.147
    container_name: ipai-supabase-db
    profiles:
      - supabase
    environment:
      - POSTGRES_PASSWORD_FILE=/run/secrets/supabase_db_password
      - POSTGRES_DB=postgres
    volumes:
      - supabase_db_data:/var/lib/postgresql/data
    secrets:
      - supabase_db_password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  supabase_postgrest:
    image: postgrest/postgrest:v12.0.2
    container_name: ipai-supabase-postgrest
    profiles:
      - supabase
    ports:
      - "3000:3000"
    environment:
      - PGRST_DB_URI=postgres://postgres:@supabase_db:5432/postgres
      - PGRST_DB_SCHEMAS=public,graphql_public
      - PGRST_DB_ANON_ROLE=anon
      - PGRST_JWT_SECRET_FILE=/run/secrets/supabase_jwt_secret
    secrets:
      - supabase_jwt_secret
    depends_on:
      supabase_db:
        condition: service_healthy
    restart: unless-stopped

volumes:
  supabase_db_data:

# ---------------------------------------------------------------------------
# Secrets (file-based for security)
# ---------------------------------------------------------------------------
secrets:
  supabase_db_password:
    file: ./secrets/supabase_db_password.txt
  supabase_jwt_secret:
    file: ./secrets/supabase_jwt_secret.txt
