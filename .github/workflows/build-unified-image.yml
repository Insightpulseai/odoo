# =============================================================================
# GitHub Actions: Build & Publish IPAI Odoo CE Images
# =============================================================================
# Triggers:
#   - Git tags: v*.*.* (production releases)
#   - Push to main branch (edge builds)
#   - Pull requests (build + test only, no push)
#   - Manual workflow dispatch
#
# Image Matrix:
#   - standard: CE + OCA essentials (production default)
#   - parity: Full enterprise parity modules
#
# CI Gates:
#   - Build: Multi-arch image build
#   - Smoke Test: --stop-after-init validation
#   - Audit: SBOM + vulnerability scan + image diff
#
# Registry: ghcr.io/jgtolentino/odoo-ce
# =============================================================================

name: Build IPAI Odoo Images

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
    paths:
      - 'addons/**'
      - 'docker/**'
      - 'config/**'
      - 'vendor/**'
      - '.github/workflows/build-unified-image.yml'
  # NOTE: pull_request trigger removed - builds are expensive and should only run on main
  workflow_dispatch:
    inputs:
      push_image:
        description: 'Push images to registry'
        required: false
        default: 'true'
        type: boolean
      run_audit:
        description: 'Run image audit (SBOM + vulns)'
        required: false
        default: 'true'
        type: boolean
      profiles:
        description: 'Profiles to build (comma-separated: standard,parity)'
        required: false
        default: 'standard,parity'
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: jgtolentino/odoo-ce

jobs:
  # ===========================================================================
  # Verify OCA Lockfile
  # ===========================================================================
  verify-oca-lock:
    name: Verify OCA Lock
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify OCA lockfile structure
        run: |
          echo "Verifying OCA lockfile structure..."

          # Check lockfile exists
          if [ ! -f "vendor/oca.lock.json" ]; then
            echo "ERROR: vendor/oca.lock.json not found"
            exit 1
          fi

          # Validate JSON
          if ! jq empty vendor/oca.lock.json 2>/dev/null; then
            echo "ERROR: Invalid JSON in vendor/oca.lock.json"
            exit 1
          fi

          # Check required fields
          VERSION=$(jq -r '.version' vendor/oca.lock.json)
          ODOO_VERSION=$(jq -r '.odoo_version' vendor/oca.lock.json)
          REPOS_COUNT=$(jq '.repos | length' vendor/oca.lock.json)

          echo "Lockfile version: $VERSION"
          echo "Odoo version: $ODOO_VERSION"
          echo "Repositories: $REPOS_COUNT"

          if [ "$ODOO_VERSION" != "18.0" ]; then
            echo "WARNING: Odoo version is not 18.0"
          fi

          # Check for unpinned commits
          UNPINNED=$(jq '[.repos[] | select(.commit == "HEAD" or .commit == null)] | length' vendor/oca.lock.json)
          if [ "$UNPINNED" -gt 0 ]; then
            echo "WARNING: $UNPINNED repositories have unpinned commits"
            jq -r '.repos[] | select(.commit == "HEAD" or .commit == null) | .name' vendor/oca.lock.json
          fi

          echo ""
          echo "OCA lockfile verification complete"
          echo "## OCA Lock Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lockfile Version | $VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| Odoo Version | $ODOO_VERSION |" >> $GITHUB_STEP_SUMMARY
          echo "| Repositories | $REPOS_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Unpinned Commits | $UNPINNED |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Build Matrix (Standard, Parity)
  # ===========================================================================
  build:
    name: Build ${{ matrix.profile }} Profile
    runs-on: ubuntu-latest
    needs: verify-oca-lock
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        profile: [standard, parity]

    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}

    steps:
      # -----------------------------------------------------------------------
      # Checkout & Setup
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # -----------------------------------------------------------------------
      # Registry Login (skip for PRs)
      # -----------------------------------------------------------------------
      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # Extract Metadata for Tags
      # -----------------------------------------------------------------------
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          flavor: |
            suffix=-${{ matrix.profile }},onlatest=true
          tags: |
            # Git tag: v1.2.0 → 1.2.0-standard
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

            # Main branch → edge-standard
            type=edge,branch=main,prefix=edge-

            # SHA for traceability → sha-abc1234-standard
            type=sha,prefix=sha-,format=short

            # Latest pointer (standard is canonical production)
            type=raw,value=latest,enable=${{ matrix.profile == 'standard' }}

            # 18.0 channel
            type=raw,value=18.0-${{ matrix.profile }}

          labels: |
            org.opencontainers.image.title=IPAI Odoo CE (${{ matrix.profile }})
            org.opencontainers.image.description=Odoo 18 CE + OCA + IPAI Modules
            org.opencontainers.image.vendor=InsightPulse AI
            com.insightpulseai.profile=${{ matrix.profile }}
            com.insightpulseai.odoo.version=18.0
            com.insightpulseai.build.git-sha=${{ github.sha }}

      # -----------------------------------------------------------------------
      # Build Image
      # -----------------------------------------------------------------------
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.unified
          build-args: |
            PROFILE=${{ matrix.profile }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_SHA=${{ github.sha }}
          push: false
          load: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ matrix.profile }}
          cache-from: type=gha,scope=${{ matrix.profile }}
          cache-to: type=gha,mode=max,scope=${{ matrix.profile }}

      # -----------------------------------------------------------------------
      # Smoke Test (CI Gate)
      # -----------------------------------------------------------------------
      - name: Run smoke test
        run: |
          echo "Running smoke test for ${{ matrix.profile }} profile..."

          # Make script executable
          chmod +x ./scripts/ci_smoke_test.sh

          # Run smoke test
          ./scripts/ci_smoke_test.sh "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:test-${{ matrix.profile }}"

      - name: Cleanup test containers
        if: always()
        run: |
          # Cleanup any leftover containers from smoke test
          docker ps -a --filter "name=smoke" -q | xargs -r docker rm -f || true
          docker network ls --filter "name=smoke" -q | xargs -r docker network rm || true

      # -----------------------------------------------------------------------
      # Push Image (only on main push, tag push, or manual trigger)
      # -----------------------------------------------------------------------
      - name: Push Docker image
        if: |
          github.event_name == 'push' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.push_image == 'true')
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.unified
          build-args: |
            PROFILE=${{ matrix.profile }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            GIT_SHA=${{ github.sha }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.profile }}
          cache-to: type=gha,mode=max,scope=${{ matrix.profile }}

      # -----------------------------------------------------------------------
      # Output Summary
      # -----------------------------------------------------------------------
      - name: Output image details
        if: success()
        run: |
          echo "## Build Summary (${{ matrix.profile }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Profile:** \`${{ matrix.profile }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Smoke Test:** Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Image Audit (SBOM + Vulnerabilities)
  # ===========================================================================
  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: build
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_audit == 'true')

    permissions:
      contents: read
      packages: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Install security scanning tools
      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Install Grype
        uses: anchore/scan-action/download-grype@v4

      # Generate SBOM for standard profile
      - name: Generate SBOM
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${GITHUB_SHA::7}-standard"
          echo "Generating SBOM for $IMAGE..."

          # Pull the image
          docker pull "$IMAGE" || {
            echo "Image not found, using edge tag..."
            IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:edge-standard"
            docker pull "$IMAGE"
          }

          # Generate SBOM
          syft "$IMAGE" -o json > sbom.json
          syft "$IMAGE" -o spdx-json > sbom.spdx.json

          echo "SBOM generated successfully"

      # Vulnerability scan
      - name: Scan for vulnerabilities
        id: scan
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${GITHUB_SHA::7}-standard"

          # Scan with Grype
          grype "$IMAGE" -o json > vulns.json || true
          grype "$IMAGE" -o table > vulns.txt || true

          # Count vulnerabilities by severity
          CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' vulns.json 2>/dev/null || echo "0")
          HIGH=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' vulns.json 2>/dev/null || echo "0")
          MEDIUM=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' vulns.json 2>/dev/null || echo "0")

          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT

          echo "## Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | $CRITICAL |" >> $GITHUB_STEP_SUMMARY
          echo "| High | $HIGH |" >> $GITHUB_STEP_SUMMARY
          echo "| Medium | $MEDIUM |" >> $GITHUB_STEP_SUMMARY

      # Upload artifacts
      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: |
            sbom.json
            sbom.spdx.json

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-report
          path: |
            vulns.json
            vulns.txt
