name: Deploy Odoo CE

on:
  push:
    branches: [ main ]

jobs:
  ci:
    name: Lint and quality checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install lint tooling
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit pylint-odoo

      - name: Run pre-commit
        run: pre-commit run --all-files

      - name: Run pylint-odoo on custom addons
        run: pylint-odoo addons

  build_image:
    name: Build and push GHCR image
    needs: ci
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: jgtolentino
          password: ${{ secrets.GHCR_PAT }}

      - name: Build image
        run: |
          IMAGE=ghcr.io/jgtolentino/odoo-ce:latest
          docker build -t "$IMAGE" .

      - name: Push image
        run: |
          IMAGE=ghcr.io/jgtolentino/odoo-ce:latest
          docker push "$IMAGE"

  deploy_vps:
    name: Deploy to DigitalOcean VPS
    needs: build_image
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1
        with:
          host: 159.223.75.148
          username: ubuntu
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            set -e
            cd ~/odoo-prod
            git pull origin main
            docker compose -f docker-compose.prod.yml pull odoo
            docker compose -f docker-compose.prod.yml up -d
            docker compose -f docker-compose.prod.yml exec odoo \
              odoo-bin -c /etc/odoo.conf \
              -d odoo \
              -u ipai_ppm_advanced,ipai_internal_shop,ipai_finance_ppm,auth_oidc \
              --stop-after-init

  deploy_doks:
    name: Deploy to DOKS
    needs: build_image
    runs-on: ubuntu-latest
    if: ${{ false }}
    steps:
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4

      - name: Update Odoo deployment image
        env:
          KUBECONFIG: ${{ secrets.DOKS_KUBECONFIG }}
        run: |
          kubectl set image deployment/odoo odoo=ghcr.io/jgtolentino/odoo-ce:latest
          kubectl rollout status deployment/odoo
