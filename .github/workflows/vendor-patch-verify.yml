name: Verify Vendor Patches

# Fires when any of the vendor patch artifacts change, ensuring the
# odoo-test-helper Odoo 19 compat patch still applies cleanly.
#
# If this gate is red after an odoo-test-helper upstream update:
#   1. Review: runtime/patches/odoo-test-helper/0001-odoo19-metamodel-module_to_models.patch
#   2. Update: runtime/scripts/apply_vendor_patches.sh (OLD/NEW patterns)
#   3. Pin:    requirements-constraints.txt (pin to last known-good version)

on:
  push:
    branches: [main]
    paths:
      - 'runtime/patches/**'
      - 'runtime/scripts/apply_vendor_patches.sh'
      - 'requirements-oca.txt'
      - 'requirements-constraints.txt'
      - 'scripts/verify_vendor_patches.py'
      - '.github/workflows/vendor-patch-verify.yml'
  pull_request:
    paths:
      - 'runtime/patches/**'
      - 'runtime/scripts/apply_vendor_patches.sh'
      - 'requirements-oca.txt'
      - 'requirements-constraints.txt'
      - 'scripts/verify_vendor_patches.py'

permissions:
  contents: read

jobs:
  verify-vendor-patches:
    name: Vendor patch â€” odoo-test-helper Odoo 19 compat
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install odoo-test-helper (with constraints)
        run: pip install -c requirements-constraints.txt "odoo-test-helper>=2.0"

      - name: Apply vendor patches (idempotent)
        run: bash runtime/scripts/apply_vendor_patches.sh

      - name: Verify patch marker present
        run: python3 scripts/verify_vendor_patches.py
