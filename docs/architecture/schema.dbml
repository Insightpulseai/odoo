Project "Insightpulse AI Supabase Core" {
  database_type: 'PostgreSQL'
  Note: 'Complete SSOT for public, auth, and ops schemas.'
}

// ==========================================
// SCHEMA: public (Auth, RBAC, Agent KB)
// ==========================================

Table public.roles {
  id uuid [pk, default: `uuid_generate_v4()`]
  name text [unique, not null]
  description text
}

Table public.profiles {
  id uuid [pk, ref: - auth.users.id]
  email text
  full_name text
  avatar_url text
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

Table public.user_roles {
  id uuid [pk, default: `uuid_generate_v4()`]
  user_id uuid [not null, ref: > public.profiles.id]
  role_id uuid [not null, ref: > public.roles.id]
  created_at timestamptz [not null, default: `now()`]

  Indexes {
    (user_id, role_id) [unique]
  }
}

Table public.kb_chunks {
  id uuid [pk, default: `uuid_generate_v4()`]
  document_id text [not null]
  content text [not null]
  metadata jsonb [not null, default: '{}']
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

Table public.kb_embeddings {
  id uuid [pk, default: `uuid_generate_v4()`]
  chunk_id uuid [not null, ref: > public.kb_chunks.id]
  embedding vector(1536) [not null]
  model text [not null]
  created_at timestamptz [not null, default: `now()`]
}

// ==========================================
// SCHEMA: ops (Integration Backbone)
// ==========================================

Table ops.integrations {
  id bigserial [pk]
  name text [unique, not null]
  enabled boolean [not null, default: true]
  config jsonb [not null, default: '{}']
  last_seen_at timestamptz
  last_error_at timestamptz
  error_count bigint [not null, default: 0]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]
}

Table ops.webhook_events {
  id bigserial [pk]
  integration text [not null] // Logical FK to ops.integrations.name
  event_type text
  idempotency_key text
  signature_valid boolean [not null, default: false]
  received_at timestamptz [not null, default: `now()`]
  headers jsonb [not null, default: '{}']
  payload jsonb [not null]
  processed_at timestamptz
  status text [not null, default: 'received']
  error text

  Indexes {
    (integration, idempotency_key) [unique]
  }
}

Table ops.jobs {
  id bigserial [pk]
  integration text [not null]
  job_type text [not null]
  payload jsonb [not null]
  run_after timestamptz [not null, default: `now()`]
  attempts int [not null, default: 0]
  max_attempts int [not null, default: 10]
  locked_at timestamptz
  locked_by text
  status text [not null, default: 'queued']
  last_error text
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  Indexes {
    (status, run_after)
  }
}

Table ops.deployments {
  id bigserial [pk]
  provider text [not null, default: 'vercel']
  provider_id text
  project_id text
  env text
  url text
  status text
  created_at timestamptz [not null, default: `now()`]
  raw_event_id bigint [ref: > ops.webhook_events.id]
}

Table ops.billing_events {
  id bigserial [pk]
  provider text [not null, default: 'stripe']
  provider_id text
  customer_id text
  event_type text
  amount bigint
  currency text
  created_at timestamptz [not null, default: `now()`]
  raw_event_id bigint [ref: > ops.webhook_events.id]
}

Table ops.email_events {
  id bigserial [pk]
  provider text [not null, default: 'resend']
  provider_id text
  to_email text
  template text
  status text
  created_at timestamptz [not null, default: `now()`]
  raw_event_id bigint [ref: > ops.webhook_events.id]
}

Table ops.edge_targets {
  name text [pk]
  url text [not null]
  created_at timestamptz [not null, default: `now()`]
}

// Relationships
Ref: ops.webhook_events.integration > ops.integrations.name
Ref: ops.jobs.integration > ops.integrations.name
