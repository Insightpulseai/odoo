id: invoice_basic_v1
doc_type: invoice
description: >
  Agentic pipeline for standard invoices with single currency, single total.
  Uses classification, extraction, normalization, validation, and one correction round.

steps:
  # 1) Sanity: is this even an invoice?
  - id: classify_document
    type: llm
    prompt_ref: classify_document
    inputs:
      - ocr_text
    outputs:
      - doc_type_pred
      - doc_type_confidence
    stop_if:
      condition: "doc_type_pred != 'invoice'"
      action: "fail"

  # 2) Core extraction from OCR text
  - id: extract_core_fields
    type: llm
    prompt_ref: invoice_extraction
    inputs:
      - ocr_text
    outputs:
      - vendor_name
      - vendor_address
      - invoice_number
      - invoice_date
      - due_date
      - total_amount
      - subtotal_amount
      - tax_amount
      - currency
      - po_number
      - line_items
      - overall_confidence

  # 3) Normalization with your parser service
  - id: normalize_fields
    type: parser
    operations:
      - field: invoice_date
        parser: normalize_date
      - field: due_date
        parser: normalize_date
      - field: total_amount
        parser: parse_amount
      - field: subtotal_amount
        parser: parse_amount
      - field: tax_amount
        parser: parse_amount
      - field: currency
        parser: detect_currency

  # 4) Validation pass using idp.validation.rule (invoice_default)
  - id: validate_business_rules
    type: validation
    rule_set: invoice_default
    outputs:
      - validation_status
      - validation_errors

  # 5) Optional correction round if validation failed or confidence low
  - id: correction_round
    type: llm
    when: "validation_status == 'fail' or overall_confidence < 0.9"
    prompt_ref: invoice_correction
    inputs:
      - ocr_text
      - current_fields
      - validation_errors
    outputs:
      - vendor_name
      - invoice_number
      - invoice_date
      - due_date
      - total_amount
      - subtotal_amount
      - tax_amount
      - currency
      - line_items
      - overall_confidence

  # 6) Final validation after correction
  - id: final_validation
    type: validation
    rule_set: invoice_default
    outputs:
      - final_status
      - final_errors

target:
  min_confidence: 0.9
  require_final_status: "pass"
  on_fail: "send_to_review"
