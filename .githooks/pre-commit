#!/usr/bin/env bash
set -e

# Finance PPM Seed Protection Hook
# Prevents direct edits to canonical seed files
# Source: config/finance/BIR_SCHEDULE_2026.xlsx
# Generator: scripts/generate_seed_from_excel.py

protected_files=(
  "addons/ipai_finance_ppm_umbrella/data/01_employees.xml"
  "addons/ipai_finance_ppm_umbrella/data/02_logframe_complete.xml"
  "addons/ipai_finance_ppm_umbrella/data/03_bir_schedule.xml"
  "addons/ipai_finance_ppm_umbrella/data/04_closing_tasks.xml"
)

echo "üîí Checking for protected Finance PPM seed file edits..."

violations=0

for f in "${protected_files[@]}"; do
  if git diff --cached --name-only | grep -q "^$f$"; then
    echo ""
    echo "‚ùå BLOCKED: Direct edit to protected file: $f"
    echo ""
    echo "   This file is auto-generated from Excel RACI:"
    echo "   ‚Üí config/finance/BIR_SCHEDULE_2026.xlsx"
    echo ""
    echo "   To make changes:"
    echo "   1. Edit the Excel file"
    echo "   2. Run: python3 scripts/generate_seed_from_excel.py"
    echo "   3. Commit the regenerated XML files"
    echo ""
    violations=$((violations + 1))
  fi
done

if [ $violations -gt 0 ]; then
  echo "‚õî Commit blocked due to $violations protected file violation(s)"
  echo ""
  echo "   To bypass this protection (NOT RECOMMENDED):"
  echo "   git commit --no-verify"
  echo ""
  exit 1
fi

echo "‚úÖ No protected file edits detected"
exit 0
