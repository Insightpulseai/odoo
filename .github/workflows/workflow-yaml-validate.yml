name: Workflow YAML Validation

on:
  pull_request:
    paths:
      - '.github/workflows/**'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/**'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: yaml-validate-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-yaml:
    name: Validate Workflow YAML Syntax
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        shell: bash
        run: |
          set -euo pipefail
          pip install --quiet pyyaml

      - name: Validate all workflow YAML files
        shell: bash
        run: |
          set -euo pipefail

          echo "Validating .github/workflows/*.yml files..."

          exit_code=0
          for file in .github/workflows/*.yml; do
            if [ ! -f "$file" ]; then
              echo "No workflow files found."
              exit 0
            fi
            echo -n "Checking $file ... "
            if python -c "import yaml; yaml.safe_load(open('$file'))" 2>&1; then
              echo "OK"
            else
              echo "FAILED"
              exit_code=1
            fi
          done

          if [ $exit_code -eq 0 ]; then
            echo ""
            echo "All workflow YAML files are valid."
          else
            echo ""
            echo "::error::Some workflow YAML files have syntax errors."
          fi

          exit $exit_code
