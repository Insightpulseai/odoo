name: secrets-registry-validate

on:
  pull_request:
    paths:
      - 'infra/secrets/registry.yaml'
      - 'scripts/secrets/**'
      - '.github/workflows/secrets-registry-validate.yml'
  push:
    branches: [main, feat/infra-dns-ssot]
    paths:
      - 'infra/secrets/registry.yaml'
      - 'scripts/secrets/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate secrets registry
        run: ./scripts/secrets/validate_registry.py

      - name: Dry-run GitHub sync (no execution)
        run: |
          echo "=== GitHub Secrets Sync (dry-run) ==="
          ./scripts/secrets/sync_github_secrets.sh || true
        env:
          CLOUDFLARE_API_TOKEN: "dummy-for-validation"
          SUPABASE_ANON_KEY: "dummy-for-validation"

      - name: Dry-run Supabase sync (no execution)
        run: |
          echo "=== Supabase Secrets Sync (dry-run) ==="
          ./scripts/secrets/sync_supabase_secrets.sh || true
        env:
          SUPABASE_PROJECT_REF: "dummy-for-validation"
          SUPABASE_SERVICE_ROLE_KEY: "dummy-for-validation"
          OPENAI_API_KEY: "dummy-for-validation"
